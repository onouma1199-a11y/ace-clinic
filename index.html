<!DOCTYPE html>

<html lang="th">

<head>
<script src="https://unpkg.com/lucide@latest"></script>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ACE Clinic | Management System Luxury</title>

    <script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    

    <style>
/* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏Ñ‡∏¥‡∏ß */
@keyframes blink-pink {
    0% { background-color: rgba(212, 129, 151, 0); }
    50% { background-color: rgba(212, 129, 151, 0.2); }
    100% { background-color: rgba(212, 129, 151, 0); }
}
.animate-blink {
    animation: blink-pink 1.5s infinite;
}
/* üñ®Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ */
@media print {
    /* 1. ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á */
    body * { visibility: hidden; }
    aside, header, .no-print, button, input, select { display: none !important; }

    /* 2. ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô */
    #dynamicContent, #dynamicContent * { visibility: visible; }
    
    /* 3. ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
    #dynamicContent {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 0;
        margin: 0;
    }
    
    /* 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô */
    @page { size: A4 landscape; margin: 1cm; }
}
/* üñ®Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå OPD Card ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ A4 */
@media print {
    /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á */
    body * {
        visibility: hidden;
    }
    
    /* ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà OPD Card ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô */
    #opd-card-printable, #opd-card-printable * {
        visibility: visible;
    }
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ A4 */
    #opd-card-printable {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        max-height: 14.8cm; /* üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á A4 ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
        margin: 0;
        padding: 15px;
        border: 1px solid #eee !important; /* ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏ö‡∏ö‡∏≤‡∏á‡πÜ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏•‡∏¥‡πâ‡∏ô */
        box-shadow: none !important;
        overflow: hidden;
    }

    /* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
    .no-print {
        display: none !important;
    }

    /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
    @page {
        size: A4 portrait; /* ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A4 ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
        margin: 0.5cm;     /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
    }
}
/* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏î‡∏≥ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏´‡∏£‡∏π ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
.course-tag {
    background: transparent !important; /* ‡πÄ‡∏≠‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡∏≠‡∏Å */
    color: #1a1a1a !important; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏î‡∏≥ */
    padding: 2px 0;
    font-weight: 500;
    display: block; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
    font-size: 13px;
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏π Luxury */
.course-container {
    background: white;
    border-radius: 0.1rem; 
    border: none;
    overflow: hidden; 
    box-shadow: 0 15px 50px rgba(0,0,0,0.05);
    margin-top: 0 !important; 
}
.course-header-row {
    background-color: #D48197 !important; /* ‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏Ç‡πâ‡∏°‡∏´‡∏ß‡∏≤‡∏ô */
    color: white !important;
    font-weight: 800;
    font-size: 14px; /* ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    letter-spacing: 1px;
}
/* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π */
.course-header-row th {
    border: none !important;
    padding-top: 12px !important;    /* üëà ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏à‡∏≤‡∏Å 25px ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
    padding-bottom: 12px !important; /* üëà ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏à‡∏≤‡∏Å 25px */
    white-space: nowrap;            /* üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏Å‡∏ä‡πà‡∏≠‡∏á */
    text-align: center;             /* üëà ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
}
/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏µ‡∏¢‡∏î */
.course-container tbody td {
    padding: 35px 10px !important;  /* üëà ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏ü‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ */
    font-size: 14px;
	vertical-align: middle !important;
}

/* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏≠‡∏¢‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö) */
#dynamicContent .glass-card {
    overflow: visible !important;
}
/* üéØ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏î‡πâ‡∏á‡∏•‡∏á‡∏°‡∏≤‡∏ó‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ */
.overflow-x-auto, table {
    overflow: visible !important;
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏î‡∏π‡πÅ‡∏û‡∏á */
[id^="action-menu-"] button {
    transition: 0.3s;
    white-space: nowrap; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
}


/* --- ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Responsive) --- */
.customer-photo {
    width: 45px !important;
    height: 45px !important;
    border-radius: 50% !important;
    object-fit: cover !important; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß */
    border: 2px solid #D48197;
}

/* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ô‡∏¥‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤‡πÑ‡∏î‡πâ */
.glass-card {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π */
.action-group {
    display: inline-flex;
    align-items: center;
    background-color: #D48197;
    border-radius: 9999px;
    padding: 2px;
}

/* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏∏‡∏î‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
[id^="action-menu-"] {
    animation: fadeInScale 0.2s ease-out;
}

@keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.95) translateY(-10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.course-table th {
    font-weight: 600;
    color: #D48197;
    background-color: #FFF9FA;
    border-bottom: 1px solid #FEE2E7;
}

.course-table td {
    font-weight: 300; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏≠‡∏°‡∏•‡∏á */
}
/* üö´ ‡πÄ‡∏≠‡∏≤‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏Ç‡∏∂‡πâ‡∏ô-‡∏•‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á Input Number ‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î */
input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button { 
    -webkit-appearance: none; 
    margin: 0; 
}
input[type=number] {
    -moz-appearance: textfield; /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firefox */
}

        /* --- [1. GLOBAL STYLES] --- */

        body { font-family: 'Sarabun', sans-serif; background-color: #FDF7F8; color: #4B5563; }

        .gold-bg { background: linear-gradient(45deg, #C5A059, #E4C580); }

        .ace-pink { color: #D48197; }

        .ace-bg-pink { background-color: #D48197; }



        /* --- [2. NAVIGATION & UI] --- */

        .sidebar-item { transition: 0.3s; border-radius: 15px; cursor: pointer; display: flex; align-items: center; padding: 0.9rem 1.2rem; margin-bottom: 5px; font-weight: 600; }

        .sidebar-item:hover { background-color: #FFF0F3; color: #D48197; transform: translateX(5px); }

        .active-menu { background-color: #D48197 !important; color: white !important; shadow: 0 10px 15px -3px rgba(212, 129, 151, 0.4); }

        

        .glass-card { background: white; border-radius: 2rem; padding: 2rem; border: 1px solid #FDF2F4; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }

        

        /* --- [3. MODAL & TABS] --- */

        .modal {

  display: none;

  position: fixed;

  z-index: 9999; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å */

  left: 0;

  top: 0;

  width: 100%;

  height: 100%;

  overflow: auto;

  background-color: rgba(0,0,0,0.4);

}

.modal-content {

  background-color: #fff;

  margin: 5% auto;

  padding: 20px;

  border-radius: 12px;

  width: 600px;

  max-width: 95%;

  position: relative;

}

     

     /* ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ (Minimal Luxury) */
.profile-tab {
    padding: 12px 25px;
    font-weight: 400;
    color: #9CA3AF;
    background: transparent !important;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
    cursor: pointer;
}

.profile-tab.active {
    color: #D48197 !important;
    border-bottom: 2px solid #D48197;
    background: transparent !important; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏™ ‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
    font-weight: 600;
}
        

        .btn-period { transition: 0.3s; border-radius: 10px; padding: 0.5rem 1.2rem; font-weight: 700; font-size: 0.8rem; border: 1px solid #F1F1F1; }

        .btn-period.active { background-color: #D48197; color: white; border-color: #D48197; }



        ::-webkit-scrollbar { width: 6px; }

        ::-webkit-scrollbar-thumb { background: #D48197; border-radius: 10px; }



/* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏ü‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
.live-indicator { 
    width: 8px; 
    height: 8px; 
    background-color: #2ecc71; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏î‡πÉ‡∏™ (Emerald Green) */
    border-radius: 50%; 
    display: inline-block; 
    animation: blink 2s infinite; /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ä‡πâ‡∏≤‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤ */
    box-shadow: 0 0 8px rgba(46, 204, 113, 0.6); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÅ‡∏™‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÜ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
}

@keyframes blink { 
    0% { opacity: 1; transform: scale(1); } 
    50% { opacity: 0.4; transform: scale(1.1); } /* ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ä‡∏µ‡∏û‡∏à‡∏£ */
    100% { opacity: 1; transform: scale(1); } 
}

        .control-group { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
/* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ú‡∏≠‡∏°‡πÄ‡∏û‡∏£‡∏µ‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
body { font-family: 'Sarabun', sans-serif; font-weight: 300; }

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á "‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏£‡πå‡∏™" ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏¢ */
.course-container {
    background: white;
    border-radius: 2.5rem;
    border: 1px solid #F3F4F6;
    box-shadow: 0 10px 40px rgba(0,0,0,0.03); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏• */
    overflow: hidden;
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏Ç‡πâ‡∏°‡∏´‡∏ß‡∏≤‡∏ô */
.course-header-row {
    background-color: #D48197 !important; /* ‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏Ç‡πâ‡∏°‡∏´‡∏ß‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å */
    color: white !important; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
    font-weight: 800; /* ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ */
    text-transform: uppercase;
    font-size: 13px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á */
    letter-spacing: 1px;
}

/* ‡πÅ‡∏ñ‡∏°: ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á */
.course-container thead tr th:first-child { border-top-left-radius: 2rem; }
.course-container thead tr th:last-child { border-top-right-radius: 2rem; }

/* ‡∏ö‡∏µ‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π (Tabs) ‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Å‡∏±‡∏ô */
.flex.flex-wrap.gap-2.mb-8 { 
    margin-bottom: 0.25rem !important; /* ‡∏•‡∏î‡∏à‡∏≤‡∏Å mb-8 ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Ñ‡πà‡∏∞ */
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å */
.course-container {
    margin-top: 0 !important;
position: relative;
    top: -1px;
}

/* --- üíé ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå (Luxury ACE Style) --- */
.sidebar-item span { font-style: normal !important; } /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏£‡∏á */
.submenu {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease-in-out, opacity 0.3s ease;
    padding-left: 1.5rem;
    opacity: 0;
}

/* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ "‡∏Ñ‡∏•‡∏¥‡∏Å" */
.submenu.open {
    max-height: 250px; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ */
    opacity: 1;
    margin-top: 5px;
}

/* ‡∏´‡∏°‡∏∏‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π */
.arrow-icon {
    transition: transform 0.3s;
}
.arrow-icon.rotate {
    transform: rotate(180deg);
}
    </style>

</head>

<body>

<div id="customerModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[10000] animate-in fade-in duration-300">
    <div class="bg-white w-full max-w-6xl rounded-[2rem] shadow-2xl overflow-hidden border-2 border-pink-200 font-normal">
        
        <div class="bg-white p-6 flex justify-between items-center border-b-2 border-pink-100">
            <h2 id="modalTitle" class="text-2xl font-bold text-slate-800 uppercase tracking-tight">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>
            <div class="flex gap-2">
                <button onclick="alert('‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£...')" class="bg-[#D48197] text-white px-6 py-2.5 rounded-xl text-xs font-bold hover:brightness-110 transition-all uppercase shadow-md">‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£</button>
                <button onclick="saveCustomer()" class="bg-[#D48197] text-white px-8 py-2.5 rounded-xl text-xs font-bold hover:brightness-110 transition-all uppercase shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button onclick="closeModal()" class="bg-[#888] text-white px-6 py-2.5 rounded-xl text-xs font-bold hover:bg-slate-700 transition-all uppercase shadow-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>

        <div class="p-8 max-h-[80vh] overflow-y-auto bg-[#FDF7F8] text-left">
            <div class="flex flex-col lg:flex-row gap-10">
                
                <div class="w-full lg:w-[300px] space-y-4">
                    <div class="bg-white p-6 rounded-2xl border-2 border-pink-200 shadow-sm text-center">
                        <div class="w-48 h-48 bg-[#FFF0F5] border-2 border-dashed border-[#E4C580] rounded-2xl mx-auto flex flex-col items-center justify-center text-[#D48197] relative overflow-hidden group">
                            <img id="photoPreview" class="absolute inset-0 w-full h-full object-cover hidden">
                            <div id="uploadPlaceholder" class="flex flex-col items-center">
                                <span class="text-4xl">üì∏</span>
                                <span class="text-[10px] font-bold uppercase mt-2">ID PHOTO</span>
                            </div>
                            <input type="file" id="modalPhotoInput" onchange="handlePhotoUpload(event)" class="absolute inset-0 opacity-0 cursor-pointer">
                        </div>
                        <div class="mt-8 space-y-4 text-left font-bold">
                            <div class="space-y-1">
                                <label class="text-[11px] text-[#D48197] uppercase ml-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                                <select id="modalStatus" class="w-full border-2 border-pink-200 p-3 rounded-xl text-sm bg-white outline-none focus:border-[#D48197] text-slate-800">
                                    <option value="‡∏õ‡∏Å‡∏ï‡∏¥">üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥ (General)</option>
                                    <option value="VIP">‚≠ê VIP Member</option>
                                    <option value="Blacklist">üö´ ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[11px] text-[#D48197] uppercase ml-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥</label>
                                <select id="modalBranch" class="w-full border-2 border-pink-200 p-3 rounded-xl text-sm bg-white outline-none focus:border-[#D48197] text-slate-800">
                                    <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ">üìç ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ</option>
                                    <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ">üìç ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</option>
                                    <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç">üìç ‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 space-y-6">
                    <div class="bg-white p-8 rounded-2xl border-2 border-pink-200 shadow-sm grid grid-cols-2 md:grid-cols-4 gap-6">
                        
                        <div class="col-span-2 space-y-1">
                            <label class="text-[11px] font-bold text-[#D48197] uppercase">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (HN)</label>
                            <input id="modalHN" type="text" class="w-full bg-slate-50 border-2 border-slate-200 p-3 rounded-xl text-base font-black text-[#D48197]" readonly>
                        </div>
                        <div class="col-span-2 space-y-1">
                            <label class="text-[11px] font-bold text-[#D48197] uppercase">üë§ ‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô)</label>
                            <input type="text" id="modalSeller" 
                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•..." 
                                class="w-full border-2 border-pink-200 p-3 rounded-xl text-base font-bold text-slate-900 bg-white outline-none focus:border-[#D48197] disabled:bg-slate-100 disabled:text-slate-400 transition-all">
                        </div>
                        
                        <div class="space-y-1">
                            <label class="text-[11px] font-bold text-[#D48197] uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á *</label>
                            <input id="modalFirstName" type="text" class="w-full border-2 border-pink-200 p-3 rounded-xl text-base font-bold text-slate-900 focus:bg-pink-50 outline-none transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[11px] font-bold text-[#D48197] uppercase">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                            <input id="modalLastName" type="text" class="w-full border-2 border-pink-200 p-3 rounded-xl text-base font-bold text-slate-900 focus:bg-pink-50 outline-none transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[11px] font-bold text-[#D48197] uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                            <input id="modalNickname" type="text" class="w-full border-2 border-pink-200 p-3 rounded-xl text-base font-bold text-slate-900 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[11px] font-bold text-[#D48197] uppercase">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î *</label>
                            <input id="modalBirthDate" type="date" class="w-full border-2 border-pink-200 p-3 rounded-xl text-base font-bold text-slate-900 outline-none">
                        </div>

                        <div class="col-span-2 space-y-1">
                            <label class="text-[11px] font-bold text-[#D48197] uppercase">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ *</label>
                            <input id="modalPhone" type="text" class="w-full border-2 border-pink-200 p-3 rounded-xl text-base font-bold text-slate-900">
                        </div>
                        <div class="col-span-2 space-y-1">
                            <label class="text-[11px] font-bold text-[#D48197] uppercase">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (E-mail)</label>
                            <input id="modalEmail" type="email" class="w-full border-2 border-pink-200 p-3 rounded-xl text-base font-bold text-slate-900 placeholder:text-slate-300" placeholder="customer@email.com">
                        </div>

                        <div class="col-span-2 space-y-1">
                            <label class="text-[11px] font-bold text-[#D48197] uppercase">Line ID / UID</label>
                            <input id="modalLine" type="text" class="w-full border-2 border-pink-200 p-3 rounded-xl text-base font-bold text-slate-900">
                        </div>
                        <div class="col-span-2 space-y-1">
                            <label class="text-[11px] font-bold text-red-500 uppercase">üö® ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤ (‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤)</label>
                            <input id="modalAllergy" type="text" class="w-full border-2 border-red-300 p-3 rounded-xl text-base font-bold text-red-600 bg-red-50" placeholder="‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏™‡πà '‡πÑ‡∏°‡πà‡∏°‡∏µ'">
                        </div>

                        <div class="col-span-4 space-y-1">
                            <label class="text-[11px] font-bold text-[#D48197] uppercase">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ / ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                            <textarea id="modalAddress" class="w-full border-2 border-pink-200 p-3 rounded-xl text-base font-bold text-slate-900 h-24 outline-none focus:bg-pink-50 transition-all"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

   <div id="loginPage" class="min-h-screen flex items-center justify-center p-4 bg-[#FDF7F8] bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-md border border-[#E4C580]/30 text-center animate-in fade-in zoom-in duration-500">
            <img src="ace-logo.jpg" alt="ACE CLINIC" class="w-32 mx-auto mb-4">
            <h1 class="text-2xl font-bold tracking-tighter uppercase text-[#D48197] mb-1">ACE CLINIC - ‡πÄ‡∏≠‡∏ã ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</h1>
            <p class="text-[#C5A059] font-bold tracking-[0.2em] text-[10px] mb-10 uppercase">Management System</p>
            
            <div class="space-y-6 text-left">
                <div class="space-y-1">
                    <label class="text-[11px] font-bold text-[#D48197] ml-2 uppercase tracking-wider">‡∏≠‡∏µ‡πÄ‡∏°‡∏• / ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                    <input type="text" id="uIn" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" 
                        class="w-full px-5 py-4 rounded-2xl border border-pink-100 outline-none focus:ring-2 focus:ring-[#D48197] font-normal text-slate-600 transition-all">
                </div>

                <div class="space-y-1">
                    <label class="text-[11px] font-bold text-[#D48197] ml-2 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="pIn" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" 
                        class="w-full px-5 py-4 rounded-2xl border border-pink-100 outline-none focus:ring-2 focus:ring-[#D48197] font-normal text-slate-600 transition-all">
                </div>

                <button onclick="doLogin()" 
                    class="w-full gold-bg text-white font-bold py-4 rounded-2xl shadow-lg mt-4 hover:brightness-110 active:scale-[0.98] transition-all text-lg uppercase tracking-widest">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>

                <p class="text-center text-[10px] text-gray-400 mt-6 font-normal">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà? 
                    <span class="text-[#D48197] cursor-pointer font-bold hover:underline" onclick="alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô')">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</span>
                </p>
            </div>
        </div>
    </div>


   <div id="mainDashboard" class="hidden min-h-screen flex flex-col md:flex-row">

        <aside class="w-80 bg-white shadow-2xl border-r border-pink-50 flex flex-col p-6 z-50">

            <div class="px-4 py-8 text-center border-b border-pink-50 mb-8 font-black">

                <img src="ace-logo.jpg" alt="ACE CLINIC" class="w-32 mx-auto mb-3">

                <div id="userBranchBadge" class="inline-block px-4 py-1 rounded-full gold-bg text-white text-[10px] uppercase italic tracking-widest font-black">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ</div>

            </div>

            

            <nav id="menuContainer" class="flex-1 space-y-2 overflow-y-auto font-black italic text-sm uppercase"></nav>

            

            <div class="mt-auto pt-6 border-t border-pink-50">

                <div class="flex items-center gap-3 p-3 rounded-2xl bg-pink-50/50 font-black italic">

                    <div id="userInitial" class="w-10 h-10 rounded-full bg-[#D48197] flex items-center justify-center text-white text-xs uppercase font-black">‡∏≠‡∏ô</div>

                    <div>

                        <p id="userNameLabel" class="text-[11px] text-gray-700 uppercase tracking-tighter font-black italic"></p>

                        <p onclick="location.reload()" class="text-[10px] text-red-400 cursor-pointer hover:underline uppercase italic font-black">Logout</p>

                    </div>

                </div>

            </div>

        </aside>



       <main class="flex-1 p-10 overflow-y-auto bg-[#FDF7F8]">

           <header class="bg-white px-8 py-4 flex flex-wrap items-center justify-between border-b relative z-10 rounded-3xl mb-8 shadow-sm">

    <div class="flex items-center gap-6">

        <h1 id="pageTitle" class="text-xl ace-pink uppercase font-black italic">DASHBOARD</h1>

        <div class="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-xl border border-pink-100">

            <span class="text-xs font-bold text-gray-400">üìÖ</span>

            <input type="date" id="headerDatePicker" class="bg-transparent text-xs font-black outline-none cursor-pointer" onchange="refreshAllData()">

        </div>

        <div class="text-[10px] font-bold text-gray-400 uppercase italic">

            ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="headerLastUpdate" class="text-slate-700">--:--:--</span>

        </div>

    </div>



    <div class="flex bg-slate-100 p-1 rounded-xl border border-pink-50">

        <button class="btn-period active" onclick="changePeriod('day', this)">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>

        <button class="btn-period" onclick="changePeriod('month', this)">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>

        <button class="btn-period" onclick="changePeriod('year', this)">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>

    </div>



    <div class="flex items-center gap-4">

        <button class="bg-green-100 text-green-700 px-4 py-2 rounded-xl text-xs font-black flex items-center gap-2 hover:bg-green-200 transition-all border border-green-200 shadow-sm">
    <span class="live-indicator"></span> LIVE 
</button>

        <button onclick="refreshAllData()" class="bg-slate-50 text-slate-500 p-2 rounded-xl border border-pink-50 hover:bg-slate-100 transition-all shadow-sm">üîÑ</button>

        

        <div class="relative group ml-2 border-l pl-4">

            <button onclick="location.reload()" class="flex items-center justify-center p-3 rounded-2xl hover:bg-pink-50 hover:scale-110 transition-all duration-300 group">
    <i data-lucide="home" class="w-8 h-8 text-[#D48197] stroke-[2]"></i>
</button>

            <div class="hidden group-hover:block absolute right-0 mt-1 w-48 bg-white border border-pink-100 rounded-2xl shadow-2xl z-[150] overflow-hidden">

                <p class="p-3 text-[10px] font-black text-gray-400 border-b uppercase">‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>

                <button class="w-full text-left p-3 text-xs font-bold hover:bg-pink-50 border-b" onclick="alert('‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ')">üìç ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ</button>

                <button class="w-full text-left p-3 text-xs font-bold hover:bg-pink-50 border-b" onclick="alert('‡∏™‡∏≤‡∏Ç‡∏≤‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ')">üìç ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</button>

                <button class="w-full text-left p-3 text-xs font-bold hover:bg-pink-50" onclick="alert('‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç')">üìç ‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç</button>

            </div>

        </div>

    </div>

</header>

            

            <div id="dynamicContent" class="animate-in fade-in duration-500"></div>

        </main>

    </div>       



    <script>

//‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏• ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤///
const productMaster = [
    { name: "‡∏Å‡∏•‡∏¥‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå 2 ‡∏ã‡∏µ‡∏ã‡∏µ", price: 3500, category: "course" },
    { name: "‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™", price: 1500, category: "course" },
    { name: "‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏•‡∏î‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö", price: 150, category: "medicine" },
    { name: "‡∏Ñ‡∏£‡∏µ‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ú‡∏¥‡∏ß ACE", price: 450, category: "medicine" }
];

window.openBillingTab = function(customerName) {
    currentBillItems = [];
    const body = document.getElementById('profileTabBody');
    document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));

    body.innerHTML = `
        <div class="animate-in fade-in duration-500 p-8 bg-white min-h-full font-bold">
            
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h4 class="text-3xl text-[#FF4B91] font-bold">üßæ ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à / ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà</h4>
                    <p class="text-slate-400 text-xs mt-1 uppercase tracking-widest font-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${customerName}</p>
                </div>
                <button onclick="switchProfileTab(1)" 
                    class="bg-pink-50 text-[#FF4B91] px-4 py-2 rounded-xl text-xs hover:bg-[#FF4B91] hover:text-white transition-all shadow-sm border border-pink-100 font-bold">
                    ‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 text-left">
                <div class="space-y-2">
                    <label class="text-xs text-[#FF4B91] font-bold ml-1">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•</label>
                    <input type="date" id="billDate" value="${new Date().toISOString().split('T')[0]}" 
                        class="w-full bg-[#FFF0F5] border border-pink-100 rounded-2xl p-4 text-sm text-slate-700 outline-none font-bold focus:border-[#FF4B91]">
                </div>
                <div class="space-y-2 text-left">
    <label class="text-xs text-[#FF4B91] font-bold ml-1">üí≥ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
    <select id="billPaymentMethod" 
        onchange="window.selectedPaymentMethod = this.value"
        class="w-full bg-[#FFF0F5] border border-pink-100 rounded-2xl p-4 text-sm text-slate-700 outline-none font-bold focus:border-[#FF4B91] appearance-none cursor-pointer">
        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á --</option>
        <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
        <option value="‡πÇ‡∏≠‡∏ô (QR)">‡πÇ‡∏≠‡∏ô (QR)</option>
        <option value="‡πÇ‡∏≠‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">‡πÇ‡∏≠‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</option>
        <option value="‡∏£‡∏π‡∏î‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï">‡∏£‡∏π‡∏î‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
        <option value="Shopee">Shopee</option>
        <option value="Gowabi">Gowabi</option>
    </select>
</div>
</div>

            <div class="bg-[#FFF0F5] rounded-[2.5rem] p-8 mb-8 relative border-2 border-dashed border-[#FF4B91]/20 text-left">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-5 items-end">
                    <div class="lg:col-span-5 space-y-2 relative">
                        <label class="text-xs text-[#FF4B91] ml-1 font-bold">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≠‡∏£‡πå‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡∏≤</label>
                        <input type="text" id="itemName" oninput="searchProduct(this.value)" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." 
                            class="w-full bg-white border border-pink-100 rounded-2xl p-4 text-sm text-slate-700 outline-none shadow-sm font-bold focus:border-[#FF4B91]">
                        <div id="searchResult" class="absolute z-50 w-full bg-white shadow-xl rounded-2xl mt-1 hidden border border-pink-50 max-h-48 overflow-y-auto font-bold"></div>
                    </div>

                    <div class="lg:col-span-3 space-y-2">
                        <label class="text-xs text-[#FF4B91] ml-1 font-bold text-center block">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ø)</label>
                        <input type="number" id="billPrice" placeholder="0.00" 
                            class="w-full bg-white border border-pink-100 rounded-2xl p-4 text-sm text-[#FF4B91] font-black outline-none shadow-sm text-center">
                    </div>

                    <div class="lg:col-span-2 space-y-2">
                        <label class="text-xs text-[#FF4B91] ml-1 font-bold text-center block">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                        <input type="number" id="billQty" value="1" 
                            class="w-full bg-white border border-pink-100 rounded-2xl p-4 text-sm text-[#FF4B91] font-black outline-none shadow-sm text-center">
                    </div>

                    <div class="lg:col-span-2">
                        <button onclick="addItemToBill()" class="w-full bg-[#FF4B91] text-white py-4 rounded-2xl text-[11px] hover:bg-[#E63980] transition-all shadow-lg font-bold uppercase">
                            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ö‡∏¥‡∏•
                        </button>
                    </div>
                </div>
            </div>

            <div class="mb-8 overflow-hidden rounded-[1.5rem] border border-pink-50 shadow-sm">
                <table class="w-full text-left font-bold">
                    <thead class="bg-[#FFF0F5] text-[11px] text-[#FF4B91] uppercase tracking-wider">
                        <tr>
                            <th class="p-4">‡∏´‡∏°‡∏ß‡∏î</th>
                            <th class="p-4">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ / ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th class="p-4 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th class="p-4 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                            <th class="p-4 text-right">‡∏£‡∏ß‡∏° (‡∏ø)</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="billItemsList" class="text-[13px] text-slate-600 font-bold">
                        <tr><td colspan="6" class="p-8 text-center text-slate-300 font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-end border-t border-pink-50 pt-8 gap-6">
                <div class="text-right md:text-left">
                    <p class="text-xs text-slate-400 font-bold uppercase">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
                    <h5 id="grandTotalDisplay" class="text-6xl text-[#FF4B91] font-bold tracking-tighter">‡∏ø0.00</h5>
                </div>
                <button onclick="confirmFinalPayment()" 
                    class="w-full md:w-auto bg-[#FF4B91] text-white px-16 py-5 rounded-[2rem] text-sm shadow-xl hover:bg-[#E63980] transition-all font-bold uppercase tracking-widest">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                </button>
            </div>
        </div>
    `;
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto-complete)
window.searchProduct = function(val) {
    const resDiv = document.getElementById('searchResult');
    if (!val) { resDiv.classList.add('hidden'); return; }
    
    const matches = productMaster.filter(p => p.name.includes(val));
    if (matches.length > 0) {
        resDiv.innerHTML = matches.map(p => `
            <div onclick="selectProduct('${p.name}', ${p.price}, '${p.category}')" 
                class="p-4 hover:bg-pink-100 cursor-pointer border-b border-pink-50 flex justify-between items-center bg-white shadow-sm transition-all">
                <span class="text-sm font-bold text-slate-900">${p.name}</span>
                <span class="text-[10px] bg-slate-200 text-slate-600 px-3 py-1 rounded-full font-bold uppercase">
                    ${p.category === 'medicine' ? '‡∏¢‡∏≤/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡∏Ñ‡∏≠‡∏£‡πå‡∏™'}
                </span>
            </div>
        `).join('');
        resDiv.classList.remove('hidden');
    } else {
        resDiv.classList.add('hidden');
    }
};

window.selectProduct = function(name, price, cat) {
    document.getElementById('itemName').value = name;
    document.getElementById('billPrice').value = price;
    document.getElementById('searchResult').classList.add('hidden');
    document.getElementById('itemName').dataset.category = cat;
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢)
window.addItemToBill = function() {
    const name = document.getElementById('itemName').value;
    const price = parseFloat(document.getElementById('billPrice').value) || 0;
    const qty = parseFloat(document.getElementById('billQty').value) || 0;
    const cat = document.getElementById('itemName').dataset.category || 'general';

    if (!name || price <= 0) return;

    currentBillItems.push({ name, price, qty, cat, total: price * qty });
    renderBillItems();
    
    document.getElementById('itemName').value = '';
    document.getElementById('billPrice').value = '';
    document.getElementById('billQty').value = '1';
};
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡πà‡∏∞)
function renderBillItems() {
    const listBody = document.getElementById('billItemsList');
    let grandTotal = 0;

    if (currentBillItems.length === 0) {
        listBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-300 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</td></tr>`;
    } else {
        listBody.innerHTML = currentBillItems.map((item, index) => {
            grandTotal += item.total;
            return `
                <tr class="border-b border-slate-50 hover:bg-pink-50/20 transition-all font-bold">
                    <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded-lg text-[10px] uppercase">${item.cat === 'medicine' ? '‡∏¢‡∏≤/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡∏Ñ‡∏≠‡∏£‡πå‡∏™'}</span></td>
                    <td class="p-4 text-slate-700">${item.name}</td>
                    <td class="p-4 text-center text-slate-600">${item.qty}</td>
                    <td class="p-4 text-right text-slate-600">‡∏ø${item.price.toLocaleString()}</td>
                    <td class="p-4 text-right ace-pink">‡∏ø${item.total.toLocaleString()}</td>
                   <td class="p-4 text-center">
    <button onclick='viewReceiptDetail(${JSON.stringify(item)})'
            class="bg-slate-100 p-2 rounded-lg hover:bg-pink-100 transition-all">üëÅÔ∏è</button>
</td>
                </tr>
            `;
        }).join('');
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    const formatter = new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' });
    document.getElementById('grandTotalDisplay').innerText = formatter.format(grandTotal);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å
window.removeItemFromBill = function(index) {
    currentBillItems.splice(index, 1);
    renderBillItems();
};

window.viewReceiptDetail = function(billData) {
    if (typeof showReceiptPreview === 'function') {
        showReceiptPreview(billData);
    } else {
        alert("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏•: " + billData.customer + "\n‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: " + billData.total);
    }
};



        /* --- [4.1 DATA: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö] --- */

        const users = [

            { email: '1111', pass: '1111', name: '‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏£‡∏≠‡∏∏‡∏°‡∏≤', role: 'admin', branch: '‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤' },

            { email: 'staff@ace.com', pass: '1111', name: '‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ö', role: 'staff', branch: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ' },

            { email: 'account@ace.com', pass: '2222', name: '‡∏û‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', role: 'accounting', branch: '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á' }

        ];



       const menuConfig = [
    { id: 1, n: 'Dashboard ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°', i: 'üìä', roles: ['admin', 'accounting'] },
    { id: 2, n: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', i: 'üë•', roles: ['admin', 'staff'] },
    
    // --- üíé ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Ñ‡πà‡∏∞) ---
    { id: 'header', n: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', i: 'üßæ', roles: ['admin', 'staff'] }, 
    { id: 3, n: '‡∏ï‡∏µ‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (INCOMING)', i:'',roles: ['admin', 'staff'] },
    { id: 9, n: '‡∏ï‡∏µ‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (OUTGOING)', i:'',roles: ['admin', 'staff'] },
    // ----------------------------------------------------

    { id: 4, n: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢', i: 'üìÖ', roles: ['admin', 'staff'] },
    { id: 5, n: '‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', i: '‚ú®', roles: ['admin', 'staff'] },
    { id: 6, n: '‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', i: 'üìà', roles: ['admin', 'accounting'] },
    { id: 7, n: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', i: 'ü©∫', roles: ['admin'] },
    { id: 8, n: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö', i: '‚öôÔ∏è', roles: ['admin'] }
];


        // üéØ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
let customerDB = JSON.parse(localStorage.getItem('customerDB')) || [
    {
        hn: "HN0001",
        fullname: "‡∏≠‡∏±‡∏Ñ‡∏£‡∏û‡∏• ‡∏û‡∏•‡∏±‡∏ö‡∏û‡∏•‡∏≤",
        nickname: "‡∏ï‡πâ‡∏ô",
        phone: "0971375498",
        branch: "‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ",
        photo: "",
        courses: [], // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏£‡πå‡∏™
        createdAt: "11/06/2024"
    },
    {
        hn: "HN0002",
        fullname: "‡∏ò‡∏ô‡πÇ‡∏ä‡∏ï‡∏¥ ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏ä‡∏£",
        nickname: "‡πÇ‡∏ä‡∏ï‡∏¥",
        phone: "0952826296",
        branch: "‡∏™‡∏≤‡∏Ç‡∏≤‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ",
        photo: "",
        courses: [], // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏£‡πå‡∏™
        createdAt: "11/06/2024"
    }
];


 let editingIndex = null;



function openModalForEdit(index){

  editingIndex = index;

  const c = customerDB[index];



  const modal = document.getElementById("customerModal");



  modal.classList.remove("hidden");

  modal.classList.add("flex");



  document.getElementById("modalTitle").innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";



  document.getElementById("modalHN").value = c.hn || "";

  document.getElementById("modalFirstName").value = c.firstName || "";

  document.getElementById("modalLastName").value = c.lastName || "";

  document.getElementById("modalNickname").value = c.nickname || "";

  document.getElementById("modalPhone").value = c.phone || "";

}



function saveCustomer(){



  const firstName = document.getElementById("modalFirstName").value.trim();

  const lastName = document.getElementById("modalLastName").value.trim();

  const phone = document.getElementById("modalPhone").value.trim();



  if(!firstName || !lastName || !phone){

    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ *");

    return;

  }



  const data = {

    hn: document.getElementById("modalHN").value || 

        "HN" + String(customerDB.length + 1).padStart(4,'0'),

    firstName,

    lastName,

    fullname: firstName + " " + lastName,

    nickname: document.getElementById("modalNickname").value,

    phone,

    citizenId: document.getElementById("modalCitizenId").value,

    address: document.getElementById("modalAddress").value,

    line: document.getElementById("modalLine").value,

    branch: document.getElementById("modalBranch").value,

    status: document.getElementById("modalStatus").value,

    createdAt: new Date().toLocaleDateString("th-TH")

  };



  if(editingIndex !== null){

    customerDB[editingIndex] = data;

  }else{

    customerDB.push(data);

  }



  localStorage.setItem("customerDB", JSON.stringify(customerDB));

  renderCustomerTable(customerDB);

  closeModal();

}



function clearModal(){

  document.getElementById("modalHN").value = "";

  document.getElementById("modalFirstName").value = "";

  document.getElementById("modalLastName").value = "";

  document.getElementById("modalNickname").value = "";

  document.getElementById("modalPhone").value = "";

  document.getElementById("modalCitizenId").value = "";

  document.getElementById("modalAddress").value = "";

  document.getElementById("modalLine").value = "";

  document.getElementById("modalBranch").value = "";

  document.getElementById("modalStatus").value = "‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";

}

function closeModal(){

  const modal = document.getElementById("customerModal");

  modal.classList.add("hidden");

  modal.classList.remove("flex");

  clearModal();

}

let hnRunning = localStorage.getItem("hnRunning")

    ? parseInt(localStorage.getItem("hnRunning"))

    : 1;



function generateHN() {



    const year = new Date().getFullYear().toString().slice(-2);

    const runningNumber = String(hnRunning).padStart(4, "0");



    const hn = "HN" + year + runningNumber;



    document.getElementById("modalHN").value = hn;



    hnRunning++;

    localStorage.setItem("hnRunning", hnRunning);

}



        /* --- [4.2 CORE SYSTEM: ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å] --- */

        function doLogin() {

            const u = document.getElementById('uIn').value;

            const p = document.getElementById('pIn').value;

            const user = users.find(x => x.email === u && x.pass === p);

            if (user) {

                document.getElementById('loginPage').classList.add('hidden');

                document.getElementById('mainDashboard').classList.remove('hidden');

                document.getElementById('userNameLabel').innerText = `${user.name} (${user.role.toUpperCase()})`;

                document.getElementById('userInitial').innerText = user.name.substring(0, 2);

                renderMenuByRole(user.role);

                loadPage(1, 'Dashboard ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°');

            } else { 

                alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); 

            }

        }
/* --- üõ†Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡∏â‡∏ö‡∏±‡∏ö Luxury Pink Icons) --- */
function renderMenuByRole(role) {
    const container = document.getElementById('menuContainer');
    if (!container) return; 

    const allowedMenu = menuConfig.filter(m => m.roles.includes(role));
    let menuHtml = '';
    
    allowedMenu.forEach(m => {
        // --- 1. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (ID: header) ---
        if (m.id === 'header') {
            menuHtml += `
                <div class="menu-group">
                    <div class="sidebar-item bg-slate-50/80 cursor-pointer flex justify-between items-center group" onclick="toggleBillingMenu()">
                        <div class="flex items-center">
                            <i data-lucide="receipt" class="mr-3 w-5 h-5 text-[#D48197] stroke-[2]"></i>
                            <span class="text-sm font-bold uppercase text-slate-700 group-hover:text-[#D48197]">${m.n}</span>
                        </div>
                        <span id="billingArrow" class="arrow-icon text-[10px] transition-transform duration-300 text-slate-400">‚ñº</span>
                    </div>
                    <div id="billingSubmenu" class="submenu overflow-hidden transition-all duration-500 max-h-0 opacity-0 pl-4">`;
        } 
        // --- 2. ‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (ID: 3 ‡πÅ‡∏•‡∏∞ 9) ---
        else if (m.id === 3 || m.id === 9) {
            let iconName = m.id === 3 ? 'trending-up' : 'trending-down';
            menuHtml += `
                <div class="sidebar-item mb-1 hover:translate-x-2 transition-transform group" id="menu-${m.id}" onclick="loadPage(${m.id}, '${m.n}')">
                    <i data-lucide="${iconName}" class="mr-3 w-4 h-4 text-[#D48197] stroke-[2]"></i>
                    <span class="text-[11px] font-bold uppercase text-slate-600 group-hover:text-[#D48197]">${m.n}</span>
                </div>`;
            if (m.id === 9) menuHtml += `</div></div>`; 
        } 
        // --- 3. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (ID: 5) ---
        else if (m.id === 5) {
            menuHtml += `
                <div class="menu-group">
                    <div class="sidebar-item bg-slate-50/80 cursor-pointer flex justify-between items-center transition-all group" onclick="toggleServiceSubmenu()">
                        <div class="flex items-center">
                            <i data-lucide="sparkles" class="mr-3 w-5 h-5 text-[#D48197] stroke-[2]"></i>
                            <span class="text-sm font-bold uppercase text-slate-700 group-hover:text-[#D48197]">${m.n}</span>
                        </div>
                        <span id="serviceArrow" class="arrow-icon text-[10px] transition-transform duration-300 text-slate-400">‚ñº</span>
                    </div>
                    <div id="serviceSubmenu" class="submenu overflow-hidden transition-all duration-500 max-h-0 opacity-0 pl-4">
                        <div class="sidebar-item mb-1 py-2 hover:bg-pink-50 rounded-xl group" onclick="loadPage(52, '‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß')">
                            <i data-lucide="users-round" class="mr-2 w-4 h-4 text-[#D48197]"></i>
                            <span class="text-[11px] font-bold text-slate-600 group-hover:text-[#D48197]">‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß</span>
                        </div>
                        <div class="sidebar-item mb-1 py-2 hover:bg-pink-50 rounded-xl group" onclick="loadPage(51, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô')">
                            <i data-lucide="scroll-text" class="mr-2 w-4 h-4 text-[#D48197]"></i>
                            <span class="text-[11px] font-bold text-slate-600 group-hover:text-[#D48197]">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™</span>
                        </div>
                        <div class="sidebar-item mb-1 py-2 hover:bg-pink-50 rounded-xl group" onclick="loadPage(53, '‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏≤‡∏â‡∏µ‡∏î')">
                            <i data-lucide="package-search" class="mr-2 w-4 h-4 text-[#D48197]"></i>
                            <span class="text-[11px] font-bold text-slate-600 group-hover:text-[#D48197]">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏≤‡∏â‡∏µ‡∏î</span>
                        </div>
                    </div>
                </div>`;
        }
        // --- 4. ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∑‡πà‡∏ô‡πÜ (1, 2, 4, 6, 7, 8) ---
        else {
            let iconName = 'circle';
            if(m.id === 1) iconName = 'layout-grid';
            if(m.id === 2) iconName = 'users';
            if(m.id === 4) iconName = 'calendar-check';
            if(m.id === 6) iconName = 'user-cog';
            if(m.id === 7) iconName = 'bar-chart-3';
            if(m.id === 8) iconName = 'settings';

            menuHtml += `
                <div class="sidebar-item group" id="menu-${m.id}" onclick="loadPage(${m.id}, '${m.n}')">
                    <i data-lucide="${iconName}" class="mr-3 w-5 h-5 text-[#D48197] stroke-[2]"></i>
                    <span class="text-sm font-bold uppercase text-slate-700 group-hover:text-[#D48197]">${m.n}</span>
                </div>`;
        }
    });
    
    container.innerHTML = menuHtml;
    
    // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ Lucide ‡∏ß‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡∏£‡πá‡∏à
    if (window.lucide) {
        lucide.createIcons();
    }
}

      
/* --- üñ±Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î (Accordion) --- */
function toggleBillingMenu() {
    const submenu = document.getElementById('billingSubmenu');
    const arrow = document.getElementById('billingArrow');
    
    // ‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™ open ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏á‡∏°‡∏≤
    submenu.classList.toggle('open');
    // ‡∏´‡∏°‡∏∏‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£
    arrow.classList.toggle('rotate');
}
/* --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡πÜ toggleBillingMenu ‡∏Ñ‡πà‡∏∞ --- */
function toggleServiceSubmenu() {
    const submenu = document.getElementById('serviceSubmenu');
    const arrow = document.getElementById('serviceArrow');
    
    if (submenu.style.maxHeight === "0px" || submenu.style.maxHeight === "") {
        submenu.style.maxHeight = "300px"; 
        submenu.style.opacity = "1";
        submenu.style.marginTop = "5px";
        arrow.style.transform = "rotate(180deg)";
    } else {
        submenu.style.maxHeight = "0px";
        submenu.style.opacity = "0";
        submenu.style.marginTop = "0px";
        arrow.style.transform = "rotate(0deg)";
    }
}


      /* --- [4.3 DASHBOARD: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏∏‡πà‡∏° 4 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ö‡∏ô ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà - ‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏°‡∏≠] --- */
function renderDashboard(target, period = 'day') {
    if (!target) return;

    const accountDB = JSON.parse(localStorage.getItem('accountDB')) || [];
    const appointmentDB = JSON.parse(localStorage.getItem('appointmentDB')) || [];
    const customerDB = JSON.parse(localStorage.getItem('customerDB')) || [];
    
    const today = new Date().toISOString().split('T')[0];
    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
    const currentMonth = today.substring(0, 7);
    const currentYear = today.substring(0, 4);

    // 1. üéØ ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 4 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ö‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏° period)
    let statsIncomes = accountDB.filter(item => item.type === "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" && item.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
    let statsExpenses = accountDB.filter(item => item.type === "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢");
    let statsApps = appointmentDB;
    let statsCustomers = customerDB; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà

    if (period === 'day') {
        statsIncomes = statsIncomes.filter(i => i.date === today);
        statsExpenses = statsExpenses.filter(e => e.date === today);
        statsApps = appointmentDB.filter(a => a.date === today);
        statsCustomers = customerDB.filter(c => c.date === today); // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    } else if (period === 'month') {
        statsIncomes = statsIncomes.filter(i => i.date && i.date.startsWith(currentMonth));
        statsExpenses = statsExpenses.filter(e => e.date && e.date.startsWith(currentMonth));
        statsApps = appointmentDB.filter(a => a.date && a.date.startsWith(currentMonth));
        statsCustomers = customerDB.filter(c => c.date && c.date.startsWith(currentMonth)); // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
    } else if (period === 'year') {
        statsIncomes = statsIncomes.filter(i => i.date && i.date.startsWith(currentYear));
        statsExpenses = statsExpenses.filter(e => e.date && e.date.startsWith(currentYear));
        statsApps = appointmentDB.filter(a => a.date && a.date.startsWith(currentYear));
        statsCustomers = customerDB.filter(c => c.date && c.date.startsWith(currentYear)); // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏õ‡∏µ‡∏ô‡∏µ‡πâ
    }

    // 2. üéØ ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" 100% ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°)
    const incomesToday = accountDB.filter(item => item.type === "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" && item.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" && item.date === today);
    const expensesToday = accountDB.filter(item => item.type === "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" && item.date === today);
    const appsToday = appointmentDB.filter(a => a.date === today);

    // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 4 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ö‡∏ô
    const totalSales = statsIncomes.reduce((sum, item) => sum + (parseFloat(String(item.total).replace(/[^0-9.-]+/g,"")) || 0), 0);
    const totalExp = statsExpenses.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
    const netProfit = totalSales - totalExp;
    
    // ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å)
    const salesYesterday = accountDB.filter(item => item.type === "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" && item.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" && item.date === yesterday)
                            .reduce((sum, item) => sum + (parseFloat(String(item.total).replace(/[^0-9.-]+/g,"")) || 0), 0);

    const titleLabel = period === 'day' ? "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" : (period === 'month' ? "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ" : "‡∏õ‡∏µ‡∏ô‡∏µ‡πâ");

    target.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 font-black italic uppercase animate-in slide-in-from-bottom duration-500">
            <div class="glass-card border-l-8 border-[#C5A059] shadow-sm">
                <p class="text-[10px] text-gray-400 font-bold uppercase">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢${titleLabel}</p>
                <p class="text-3xl text-gray-800 mt-2 font-black italic">‡∏ø${totalSales.toLocaleString()}</p>
                <p class="text-[9px] text-slate-400 font-bold mt-1">(‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡∏ô‡∏µ‡πâ: ‡∏ø${salesYesterday.toLocaleString()})</p>
            </div>
            
            <div class="glass-card border-l-8 border-[#D48197] shadow-sm">
                <p class="text-[10px] text-gray-400 font-bold uppercase">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà${titleLabel}</p>
                <p class="text-3xl text-gray-800 mt-2 font-black italic">${statsCustomers.length.toLocaleString()} ‡∏Ñ‡∏ô</p>
                <p class="text-[9px] text-slate-400 font-bold mt-1">(‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${customerDB.length.toLocaleString()} ‡∏Ñ‡∏ô)</p>
            </div>
            
            <div class="glass-card border-l-8 border-blue-400 shadow-sm">
                <p class="text-[10px] text-gray-400 font-bold uppercase">‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏±‡∏î${titleLabel}</p>
                <p class="text-3xl text-gray-800 mt-2 font-black italic">${statsApps.length.toLocaleString()} ‡∏ô‡∏±‡∏î</p>
            </div>
            
            <div class="glass-card border-l-8 border-green-400 shadow-sm">
                <p class="text-[10px] text-gray-400 font-bold uppercase">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥${titleLabel}</p>
                <p class="text-3xl text-green-600 mt-2 font-black italic">‡∏ø${netProfit.toLocaleString()}</p>
            </div>
        </div>

        <div class="glass-card shadow-lg mb-8 border-t-4 border-blue-400">
            <h3 class="text-lg font-black ace-pink mb-6 uppercase italic">üìÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${appsToday.length} ‡∏ô‡∏±‡∏î)</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-[11px] font-black italic uppercase">
                    <thead class="bg-slate-50 text-gray-500 border-b">
                        <tr>
                            <th class="p-3">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th class="p-3">HN</th>
                            <th class="p-3">‡πÄ‡∏ß‡∏•‡∏≤</th><th class="p-3">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th class="p-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th class="p-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y bg-white">
                        ${appsToday.length > 0 ? appsToday.map((ap, idx) => `
                            <tr>
                                <td class="p-3">${idx + 1}</td>
                                <td class="p-3">${ap.hn || '-'}</td>
                                <td class="p-3">${ap.time || '--:--'}</td>
                                <td class="p-3">${ap.phone || '-'}</td>
                                <td class="p-3">${ap.customerName}</td>
                                <td class="p-3 text-center"><span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-[9px]">üü¢ ${ap.status}</span></td>
                            </tr>
                        `).join('') : '<tr><td colspan="6" class="p-5 text-center text-gray-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 font-bold uppercase">
            <div class="glass-card shadow-lg border-t-4 border-[#C5A059] bg-white p-8">
                <h3 class="text-lg font-bold ace-pink mb-6 border-b-2 border-dashed pb-2 text-center">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (REAL-TIME)</h3>
                <div class="space-y-3 text-sm font-bold text-slate-600">
                    ${['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', '‡πÇ‡∏≠‡∏ô (QR)', '‡πÇ‡∏≠‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó', '‡∏£‡∏π‡∏î‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï', 'Shopee', 'Gowabi'].map(method => {
                        const amt = incomesToday.filter(i => i.payment === method)
                                    .reduce((s, item) => s + (parseFloat(String(item.total).replace(/[^0-9.-]+/g,"")) || 0), 0);
                        return `<div class="flex justify-between border-b border-slate-50 pb-1"><span>üíµ ${method}</span><span class="text-slate-800">${amt.toLocaleString()}.-</span></div>`;
                    }).join('')}
                    <div class="flex justify-between pt-3 text-xl ace-pink border-t-4 border-double font-bold mt-2">
                        <span>üìä ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span><span>${incomesToday.reduce((s, i) => s + (parseFloat(String(i.total).replace(/[^0-9.-]+/g,"")) || 0), 0).toLocaleString()}.-</span>
                    </div>
                </div>
            </div>

            <div class="glass-card shadow-lg border-t-4 border-red-400 bg-slate-50/30 p-8">
                <h3 class="text-lg font-bold text-red-500 mb-6 border-b-2 border-dashed pb-2 text-center">üí∏ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                <div class="space-y-4 mb-10 min-h-[120px]">
                    ${expensesToday.length > 0 ? expensesToday.map(ex => `
                        <div class="p-4 bg-white rounded-2xl border-2 border-dashed border-red-100 flex justify-between items-center shadow-sm">
                            <div><p class="text-xs font-bold text-slate-600">üìâ ${ex.detail}</p><p class="text-[9px] text-gray-400 font-bold">‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å: ${ex.account}</p></div>
                            <span class="text-red-500 font-bold">- ${parseFloat(ex.amount).toLocaleString()}.-</span>
                        </div>
                    `).join('') : '<p class="text-center text-gray-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>'}
                </div>
                <div class="gold-bg p-5 rounded-[2rem] text-white shadow-xl mt-6 border border-[#E4C580]/50">
                    <div class="flex justify-between items-center px-2">
                        <div>
                            <p class="text-[10px] uppercase opacity-90 font-bold tracking-wider">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (NET)</p>
                            <h2 class="text-3xl font-bold tracking-tighter">‡∏ø${(incomesToday.reduce((s, i) => s + (parseFloat(String(i.total).replace(/[^0-9.-]+/g,"")) || 0), 0) - expensesToday.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0)).toLocaleString()}.-</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
}

     

/* ============================= */

/* ====== CUSTOMER LIST ======== */

/* ============================= */



let currentPageSize = 10;



/* --- ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ list (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏µ‡∏Å‡∏Å‡∏≤‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Login ‡πÑ‡∏î‡πâ) --- */
function renderCustomerList(target) {
    target.innerHTML = `
    <div class="glass-card mb-6 flex flex-wrap gap-4 items-center font-black italic uppercase">
        <select id="pageSize" class="border border-pink-100 px-4 py-2 rounded-xl text-xs">
            <option value="10">10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
            <option value="25">25 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
            <option value="50">50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
        </select>
        <select id="branchFilter" class="border border-pink-100 px-4 py-2 rounded-xl text-xs">
            <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
            <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ</option>
            <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</option>
        </select>
        <input id="searchInput" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / HN / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" class="flex-1 border border-pink-100 px-5 py-2 rounded-xl text-xs outline-none">
        <button id="searchBtn" class="gold-bg text-white px-6 py-2 rounded-xl text-xs shadow-lg">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button onclick="openModalForAdd()" id="addCustomerBtn" class="bg-black text-white px-6 py-2 rounded-xl text-xs shadow-lg"> + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ </button>
    </div>

    <div class="glass-card shadow-2xl">
        <table class="w-full text-left text-xs">
            <thead class="bg-pink-50 border-b text-[#D48197]">
                <tr>
                    <th class="p-3">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th class="p-3">‡∏£‡∏π‡∏õ</th><th class="p-3">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                    <th class="p-3">HN</th><th class="p-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-3">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
                    <th class="p-3">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th class="p-3">‡∏™‡∏≤‡∏Ç‡∏≤</th><th class="p-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody id="customerTableBody"></tbody>
        </table>
    </div>`;

    // ===== ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏¢: ‡∏õ‡∏¥‡∏î‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö Login ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ =====
    document.getElementById("pageSize").addEventListener("change", function(e){
        currentPageSize = parseInt(e.target.value);
        renderCustomerTable(customerDB);
    }); 

    document.getElementById("searchBtn").addEventListener("click", applyCustomerFilter);
    
    renderCustomerTable(customerDB);
}

/* --- filter --- */

function applyCustomerFilter() {
    const keyword = document.getElementById("searchInput").value.toLowerCase();

    const branch = document.getElementById("branchFilter").value;

    let filtered = customerDB.filter(c => {

        const matchKeyword =

            c.fullname?.toLowerCase().includes(keyword) ||

            c.hn?.toLowerCase().includes(keyword) ||

            c.phone?.includes(keyword);



        const matchBranch =

            branch === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || c.branch === branch;



        return matchKeyword && matchBranch;

    });


    renderCustomerTable(filtered);

}

/* --- ‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --- */

function deleteCustomer(index) {



    if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){

        customerDB.splice(index,1);

        localStorage.setItem("customerDB", JSON.stringify(customerDB));

        renderCustomerTable(customerDB);

    }

}


/* --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --- */

function editCustomer(index){

    openModalForEdit(index);

}


/* --- render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏â‡∏ö‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç + ‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° Dropdown) --- */
function renderCustomerTable(data) {
    const tbody = document.getElementById("customerTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    const limitedData = data.slice(0, currentPageSize);
    limitedData.forEach((c, index) => {
        const realIndex = customerDB.findIndex(item => item.hn === c.hn);
        tbody.innerHTML += `
            <tr class="border-b hover:bg-pink-50 transition">
                <td class="p-3 text-[10px]">${index + 1}</td>
                <td class="p-3">
                    <img src="${c.photo || 'https://via.placeholder.com/150'}" class="customer-photo shadow-sm">
                </td>
                <td class="p-3">${c.createdAt || '-'}</td>
                <td class="p-3 font-bold">${c.hn || '-'}</td>
                <td class="p-3">${c.fullname || '-'}</td>
                <td class="p-3">${c.nickname || '-'}</td>
                <td class="p-3">${c.phone || '-'}</td>
                <td class="p-3">${c.branch || '-'}</td>
                <td class="p-3 text-center min-w-[160px] relative">
                    <div class="inline-flex items-center bg-[#D48197] text-white rounded-full p-1 shadow-md relative">
                        <button onclick="openModalForEdit(${realIndex})" 
                                class="px-4 py-1 text-[11px] font-bold border-r border-white/30 hover:bg-white/10 rounded-l-full">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button onclick="toggleActionMenu(event, ${index})" 
                                class="px-2 py-1 text-[11px] hover:bg-white/10 rounded-r-full transition-all">
                             ‚ñº
                        </button>
                        
                        <div id="action-menu-${index}" 
                             class="hidden absolute right-0 top-10 w-48 bg-white border border-pink-100 rounded-2xl shadow-2xl z-[999] overflow-hidden text-left font-black italic">
                            <button onclick="viewCustomerDetail(${realIndex})" class="w-full p-4 text-[11px] text-gray-600 hover:bg-pink-50 border-b flex items-center gap-2">
                                üëÅÔ∏è ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                            </button>
                            <button onclick="printOPD(${realIndex})" class="w-full p-4 text-[11px] text-gray-600 hover:bg-pink-50 border-b flex items-center gap-2">
                                üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå OPD Card
                            </button>
                            <button class="w-full p-4 text-[11px] bg-gray-50 text-gray-400 cursor-not-allowed border-b flex items-center gap-2" disabled>
                                üö´ ‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
                            </button>
                            <button onclick="deleteCustomer(${realIndex})" class="w-full p-4 text-[11px] text-red-500 hover:bg-red-50 flex items-center gap-2 font-bold">
                                üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ
                            </button>
                        </div>
                    </div>
                </td>
            </tr>`;
    });
}
    
      

        /* --- [4.5 PROFILE: ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤] --- */

        function showCustomerDetail(index) {

            const c = customerDB[index];

            const content = document.getElementById('dynamicContent');

            content.innerHTML = `

                <div class="glass-card mb-6 border-t-8 border-[#C5A059] animate-in slide-in-from-top duration-500 font-black italic uppercase">

                    <div class="flex flex-col md:flex-row justify-between items-center gap-8 font-black uppercase italic">

                        <div class="flex items-center gap-8">

                            <div class="w-32 h-32 rounded-[3rem] gold-bg flex items-center justify-center text-white text-5xl font-black shadow-2xl italic font-black">ACE</div>

                            <div><h2 class="text-4xl text-gray-800 tracking-tighter font-black italic uppercase">${c.fullname}</h2><p class="text-sm text-gray-400 mt-1 font-black italic uppercase">CODE: ${c.hn} | ‡∏™‡∏≤‡∏Ç‡∏≤: ${c.branch}</p></div>

                        </div>

                        <div class="flex gap-3 font-black uppercase italic">

                            <button class="gold-bg text-white px-8 py-4 rounded-[1.5rem] font-black text-xs shadow-xl italic font-black">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>

                            <div class="relative group"><button class="bg-white border-2 border-gray-100 px-8 py-4 rounded-[1.5rem] text-xs font-black shadow-sm group-hover:bg-gray-50 italic uppercase font-black">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ‚ñº</button>

                                <div class="hidden group-hover:block absolute right-0 w-56 bg-white shadow-2xl rounded-2xl border border-pink-50 z-[200] overflow-hidden font-black italic"><button class="w-full text-left p-5 text-[11px] hover:bg-pink-50 border-b font-black italic uppercase">üìÑ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>

                            </div>

                        </div>

                    </div>

                </div>

                <div class="flex gap-2 border-b border-pink-100 mb-8 overflow-x-auto font-black italic uppercase font-black italic font-black">

                    <div class="profile-tab active uppercase font-black italic font-black">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div><div class="profile-tab font-black italic font-black">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏±‡∏Å‡∏©‡∏≤</div><div class="profile-tab font-black italic font-black">‡∏Ñ‡∏≠‡∏£‡πå‡∏™ <span class="bg-red-500 text-white text-[9px] px-1.5 rounded-full ml-1 font-black italic font-black">1</span></div><div class="profile-tab font-black italic font-black">‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div><div class="profile-tab font-black italic font-black">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div><div class="profile-tab font-black italic font-black">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><div class="profile-tab font-black italic font-black">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>

                </div>

                <div class="glass-card font-black italic uppercase">

                    <h4 class="ace-pink uppercase mb-6 underline decoration-pink-100 text-lg font-black italic tracking-tighter uppercase font-black">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h4>

                    <p class="text-gray-800 uppercase italic font-black tracking-tighter">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${c.phone}</p>

                    <p class="text-red-500 mt-2 italic font-black tracking-tighter underline">üö® ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>

                </div>`;

}



/* --- [‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å 8 ‡πÅ‡∏ó‡πá‡∏ö] --- */

function showCustomerProfile(index) {

    const c = customerDB[index];

    const target = document.getElementById('dynamicContent');

    

    // 1Ô∏è‚É£ HEADER CARD: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô

    target.innerHTML = `

        <div class="glass-card mb-6 border-t-8 border-[#C5A059] animate-in slide-in-from-top duration-500 font-black italic uppercase">

            <div class="flex flex-col md:flex-row justify-between items-center gap-8 font-black uppercase italic">

                <div class="flex items-center gap-8">

                    <div class="w-32 h-32 rounded-[3rem] gold-bg flex items-center justify-center text-white text-5xl font-black shadow-2xl italic">ACE</div>

                    <div>

                        <h2 class="text-4xl text-gray-800 tracking-tighter font-black italic uppercase italic">${c.fullname}</h2>

                        <p class="text-sm text-[#C5A059] mt-1 font-black italic uppercase tracking-widest italic">CODE: ${c.hn} | ‡∏™‡∏≤‡∏Ç‡∏≤: ${c.branch}</p>

                        <div class="mt-4 flex gap-2">

                            <span class="bg-green-100 text-green-600 px-4 py-1 rounded-full text-[10px] font-black uppercase italic">‚óè ‡∏õ‡∏Å‡∏ï‡∏¥</span>

                            <span class="bg-purple-100 text-purple-600 px-4 py-1 rounded-full text-[10px] font-black uppercase italic">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å</span>

                        </div>

                    </div>

                </div>

                <div class="flex gap-3">

                    <button class="bg-[#337373] text-white px-8 py-4 rounded-[1.5rem] font-black text-xs shadow-xl italic font-black">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>

                    <button onclick="renderCustomerList(document.getElementById('dynamicContent'))" class="bg-white border-2 border-gray-100 px-8 py-4 rounded-[1.5rem] text-xs font-black shadow-sm italic uppercase font-black">üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>

                </div>

            </div>

        </div>



        <div class="flex gap-1 border-b border-pink-100 mb-8 overflow-x-auto font-black italic uppercase italic">

            <div class="profile-tab active" onclick="switchTab(1)">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>

            <div class="profile-tab" onclick="switchTab(2)">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</div>

            <div class="profile-tab" onclick="switchTab(3)">‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>

            <div class="profile-tab" onclick="switchTab(4)">‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>

            <div class="profile-tab" onclick="switchTab(5)">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô-‡∏´‡∏•‡∏±‡∏á</div>

            <div class="profile-tab" onclick="switchTab(6)">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</div>

            <div class="profile-tab" onclick="switchTab(7)">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>

        </div>



        <div id="tabBody" class="glass-card font-black italic uppercase min-h-[350px]">

            <h4 class="ace-pink uppercase mb-6 underline decoration-pink-100 text-lg font-black italic tracking-tighter uppercase font-black italic">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h4>

            <div class="grid grid-cols-2 gap-8">

<div class="group">

<label class="text-[10px] text-gray-400 uppercase tracking-widest">

‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô

</label>

<input type="text" id="newNickname"

value="${c.nickname || ''}"

class="w-full border-b-2 ...">



</div>



                <div><p class="text-[10px] text-gray-400">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</p><p class="text-xl italic underline decoration-pink-200">${c.phone}</p></div>

                <div><p class="text-[10px] text-gray-400">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏™‡∏≤‡∏Ç‡∏≤</p><p class="text-xl ace-pink italic underline decoration-gold-200">${c.branch}</p></div>

                <div class="col-span-2 bg-red-50 p-6 rounded-[2.5rem] border border-red-100 shadow-sm mt-4">

                    <p class="text-red-500 font-black italic uppercase tracking-tighter italic">üö® ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>

                </div>

            </div>

        </div>`;

}



function switchTab(id) {

    document.querySelectorAll('.profile-tab').forEach((t, i) => t.classList.toggle('active', i+1 === id));

    // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏Ñ‡πà‡∏∞

}

        



        /* --- [4.6 UTILITIES: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ] --- */

     function openModalForAdd(){



    editingIndex = null;



    clearModal();



    document.getElementById("modalTitle").innerText = "‚ú® ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà";



    generateHN(); // üëà ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ



    const modal = document.getElementById("customerModal");

    modal.classList.remove("hidden");

    modal.classList.add("flex");

}




function toggleDropdown(index) {



    document.querySelectorAll("[id^='dropdown-']")

        .forEach(el => el.classList.add("hidden"));



    const menu = document.getElementById(`dropdown-${index}`);

    menu.classList.toggle("hidden");

}



document.addEventListener("click", function (e) {

    if (!e.target.closest(".relative")) {

        document.querySelectorAll("[id^='dropdown-']")

            .forEach(el => el.classList.add("hidden"));

    }

});



/* ============================= */

/* ‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ */

/* ============================= */



function deleteCustomer(index) {

    if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {

        customerDB.splice(index, 1);

        renderCustomerTable(customerDB);

    }

}


/* =======================================================

   HEADER CONTROL (CLEAN VERSION - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡πâ‡∏≥)

   ======================================================= */



// üïí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤

function updateHeaderTime() {

    const timeEl = document.getElementById('headerLastUpdate');

    if (timeEl) {

        timeEl.innerText = new Date().toLocaleTimeString('th-TH', { hour12: false });

    }

}



// üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

window.refreshAllData = function() {
    updateHeaderTime();
    const currentPageTitle = document.getElementById('pageTitle').innerText;
    const targetContent = document.getElementById('dynamicContent');

    if (currentPageTitle === 'DASHBOARD' || currentPageTitle === 'DASHBOARD ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°') {
        // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ currentPeriod ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡∏î‡πâ‡∏ß‡∏¢
        renderDashboard(targetContent, currentPeriod);
    }
    else if (currentPageTitle === '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥') {

        renderCustomerList(targetContent);

    }


    console.log("ACE Clinic System: Updated at " + new Date().toLocaleTimeString());

};



// üìä ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤

window.changePeriod = function(period, btn) {



    document.querySelectorAll('.btn-period')

        .forEach(b => b.classList.remove('active'));



    btn.classList.add('active');



    refreshAllData();

};
// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)
let currentPeriod = 'day'; 

window.changePeriod = function(period, btn) {
    // 1. ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏õ‡∏∏‡πà‡∏°
    document.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    currentPeriod = period;
    
    // 3. ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    refreshAllData();
};



// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤

window.addEventListener('DOMContentLoaded', () => {



    const dateInput = document.getElementById('headerDatePicker');

    if (dateInput) dateInput.valueAsDate = new Date();



    updateHeaderTime();

});



// ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

setInterval(updateHeaderTime, 1000);



document.addEventListener("DOMContentLoaded", function(){

  const modal = document.getElementById("customerModal");

  if(modal){

    modal.classList.add("hidden");

    modal.classList.remove("flex");

  }

});

/* =======================================================
   üîë 1. LOGIN SYSTEM (‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏ö‡πÑ‡∏õ)
   ======================================================= */
window.doLogin = function() {
    const u = document.getElementById('uIn').value;
    const p = document.getElementById('pIn').value;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ users ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    const user = users.find(x => x.email === u && x.pass === p);
    
    if (user) {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainDashboard').classList.remove('hidden');
        document.getElementById('userNameLabel').innerText = `${user.name}`;
        
        // ‡∏ß‡∏≤‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        if (typeof renderMenuByRole === 'function') {
            renderMenuByRole(user.role);
        }
        
        // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
        loadPage(1, 'Dashboard ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°');
    } else { 
        Swal.fire({
            icon: 'error',
            title: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ (1111 / 1111)',
            confirmButtonColor: '#D48197'
        });
    }
};

/* =======================================================
   üöÄ 2. CORE NAVIGATION: ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ( loadPage )
   ======================================================= */
function loadPage(id, title) {
    // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    const titleEl = document.getElementById('pageTitle');
    if (titleEl) titleEl.innerText = title.toUpperCase();
    
    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏µ‡πÄ‡∏°‡∏ô‡∏π Sidebar (Active Class)
    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active-menu'));
    const allSidebarItems = document.querySelectorAll('.sidebar-item');
    allSidebarItems.forEach(item => {
        if(item.innerText.includes(title)) item.classList.add('active-menu');
    });

    const target = document.getElementById('dynamicContent');
    if (!target) return;

    // 3. ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤ (ID Mapping)
    if (id === 1) {
        renderDashboard(target);
    } else if (id === 2) {
        renderCustomerList(target);
    } else if (id === 3) {
        renderSalesPage();
    } else if (id === 4) {
        renderAppointmentPage();
    } else if (id === 6) {
        renderReportPage();
    } else if (id === 7) {
        renderStaffManagement(); 
    } else if (id === 9) {
        renderExpensePage();
    } else if (id === 11) {
        renderPayrollSystem();     // ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    } else if (id === 12) {
        renderAttendanceRecord();  // üìà ‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤/‡∏™‡∏≤‡∏¢ (ID ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
    } else if (id === 51) {
        renderCourseMasterPage();
    } else if (id === 52) {
        renderQueuePage();
    } else if (id === 53) {
        renderStockPage();
    } else if (id === 66) {
        renderDFReportPage();
    } else if (id === 8) {
        renderSettingsPage();
    } else {
        target.innerHTML = `<div class="glass-card py-32 text-center text-slate-300 font-bold uppercase text-xl italic">‡πÄ‡∏°‡∏ô‡∏π ${title} <br> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤...</div>`;
    }
}

/* =======================================================
   üíé ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π ‡πÅ‡∏•‡∏∞ ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (View Detail / OPD)
   ======================================================= */

window.toggleActionMenu = function(event, index) {
    event.stopPropagation();
    const menuId = `action-menu-${index}`;
    document.querySelectorAll("[id^='action-menu-']").forEach(m => {
        if(m.id !== menuId) m.classList.add('hidden');
    });
    const currentMenu = document.getElementById(menuId);
    if(currentMenu) currentMenu.classList.toggle('hidden');
};

/* --- [‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏â‡∏ö‡∏±‡∏ö LUXURY - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á] --- */
window.viewCustomerDetail = function(index) {
    const c = customerDB[index];
    window.activeCustomer = c; 
    
    const target = document.getElementById('dynamicContent');
    let billHistoryDB = JSON.parse(localStorage.getItem('billHistoryDB')) || [];
    
    target.innerHTML = `
        <div class="bg-white rounded-[3rem] shadow-2xl p-10 animate-in zoom-in duration-300 border border-pink-50">
            <div class="flex justify-between items-center mb-10">
                <div class="flex items-center gap-4">
                    <h2 class="text-4xl font-black ace-pink italic">üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
                    <span class="bg-purple-100 text-purple-600 px-4 py-1 rounded-full text-[10px] font-black italic uppercase">HN: ${c.hn}</span>
                    <button onclick="openBillingTab('${c.fullname}')" 
                        class="bg-slate-600 text-white px-5 py-2 rounded-xl text-[11px] font-black shadow-lg hover:bg-slate-700 transition-all uppercase">‡∏ï‡πà‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à / ‡∏ï‡∏µ‡∏ö‡∏¥‡∏•</button>
                </div>
                <button onclick="loadPage(2, '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥')" class="text-3xl text-gray-300 hover:text-red-400">‚úï</button>
            </div>

            <div class="flex flex-col lg:flex-row gap-10">
                <div class="w-full lg:w-80 space-y-6">
                    <div class="bg-white border border-pink-50 rounded-[2.5rem] p-8 shadow-sm text-center">
                        <div class="w-40 h-52 bg-pink-50 border-2 border-dashed border-pink-200 rounded-3xl mx-auto mb-6 flex items-center justify-center font-bold">
                            <span class="text-gray-300 font-black italic text-xs">ID PHOTO</span>
                        </div>
                        <h3 class="text-2xl font-black text-gray-700 italic">${c.fullname}</h3>
                        <p class="ace-pink font-black italic text-sm">@${c.nickname || '-'}</p>
                        <div class="mt-8 space-y-3 text-left text-[11px] font-black italic">
                            <div class="flex justify-between border-b pb-2"><span>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</span><span class="text-gray-700">19/08/1999</span></div>
                            <div class="flex justify-between border-b pb-2"><span>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span><span class="ace-pink">${c.phone}</span></div>
                            <div class="flex justify-between border-b pb-2"><span>‡∏™‡∏≤‡∏Ç‡∏≤:</span><span class="text-green-500">${c.branch}</span></div>
                            <div class="flex justify-between text-red-500"><span>‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</span><span>‡∏ø0.00</span></div>
                        </div>
                    </div>
                </div>

                <div class="flex-1">
                    <div class="flex flex-wrap gap-2 mb-8">
                        <button onclick="switchProfileTab(1, ${index})" id="tab-1" class="profile-tab active px-6 py-2 rounded-2xl font-black italic text-xs transition-all">‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
                        <button onclick="switchProfileTab(2, ${index})" id="tab-2" class="profile-tab bg-slate-50 text-slate-400 px-6 py-2 rounded-2xl font-black italic text-xs transition-all">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
                        <button onclick="switchProfileTab(3, ${index})" id="tab-3" class="profile-tab bg-slate-50 text-slate-400 px-6 py-2 rounded-2xl font-black italic text-xs transition-all">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</button>
                        <button onclick="switchProfileTab(4, ${index})" id="tab-4" class="profile-tab bg-slate-50 text-slate-400 px-6 py-2 rounded-2xl font-black italic text-xs transition-all">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</button>
                    </div>
                    <div id="profileTabBody" class="bg-white border border-pink-50 rounded-[3rem] p-0 min-h-[500px] shadow-sm relative overflow-hidden"></div>
                </div>
            </div>
        </div>`;
    switchProfileTab(1, index);
};

/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (‡∏£‡∏ß‡∏° Tab 1, 3, 4 ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) --- */
window.switchProfileTab = function(tabId, customerIndex) {
    const body = document.getElementById('profileTabBody');
    const customer = customerDB[customerIndex]; 
    
    document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`tab-${tabId}`)?.classList.add('active');

    // üìä ‡πÅ‡∏ó‡πá‡∏ö 1: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏£‡∏¥‡∏á
    if (tabId === 1) { 
        const courses = customer.courses || [];
        if (courses.length === 0) {
            body.innerHTML = `<div class="p-20 text-center animate-in fade-in"><p class="text-slate-300 font-normal">üìä ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p></div>`;
        } else {
            body.innerHTML = `
                <div class="p-4 animate-in fade-in space-y-3">
                    <div class="grid grid-cols-1 gap-2">
                        ${courses.map(c => `
                            <div class="bg-white border border-pink-100 p-1 rounded-2xl flex justify-between items-center shadow-sm">
                                <div>
                                    <p class="text-[8px] text-pink-400 font-normal uppercase mb-0.5">SERVICE COURSE</p>
                                    <p class="text-slate-700 font-normal text-base">${c.name}</p>
                                    <p class="text-[8px] text-slate-300 font-normal uppercase mt-0.5">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠: ${c.date}</p>
                                </div>
                                <div class="text-right bg-pink-50 px-4 py-1 rounded-xl border border-pink-50">
                                    <p class="text-[8px] text-pink-400 font-normal uppercase mb-0.5">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                                    <p class="text-xl font-normal ace-pink">${c.amount} <span class="text-[10px]">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }
    }
    // üßæ ‡πÅ‡∏ó‡πá‡∏ö 3: ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏ß‡∏á‡∏ï‡∏≤ üëÅÔ∏è)
    else if (tabId === 3) {
        const allBills = JSON.parse(localStorage.getItem('billHistoryDB')) || [];
        const myBills = allBills.filter(b => b.hn === customer.hn);
        
        if (myBills.length === 0) {
            body.innerHTML = `<div class="p-10 text-center text-slate-400 font-normal italic">üßæ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>`;
        } else {
            body.innerHTML = `
                <div class="p-1 animate-in fade-in">
                    <table class="w-full text-left font-normal text-[12px]">
                        <thead class="bg-pink-50/50 text-[#FF4B91] uppercase text-[11px] font-bold">
                            <tr>
                                <th class="p-1 pl-4 font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="p-1 font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                                <th class="p-1 font-bold">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                                <th class="p-1 text-center w-[40px] font-bold">‡∏î‡∏π</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-600">
                            ${myBills.map((b, bIdx) => `
                                <tr class="border-b border-pink-50/30 hover:bg-pink-50/10 transition-all">
                                    <td class="p-0.5 pl-4 font-normal">${b.date}</td>
                                    <td class="p-0.5 font-normal">‡∏ø${parseFloat(b.total.replace(/[^0-9.-]+/g,"")).toLocaleString()}</td>
                                    <td class="p-0.5 text-[11px] font-normal">${b.payment}</td>
                                    <td class="p-0.5 text-center">
                                        <button onclick="openOldReceipt(${bIdx}, '${customer.hn}')" 
                                            class="bg-slate-50 p-0.5 rounded shadow-sm hover:bg-pink-100 transition-all scale-100">
                                            <span style="font-size: 10px;">üëÅÔ∏è</span>
                                        </button>
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>`;
        }
    }
    // üìÇ ‡πÅ‡∏ó‡πá‡∏ö 4: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å OPD)
    else if (tabId === 4) {
        const treatments = customer.treatments || []; 
        if (treatments.length === 0) {
            body.innerHTML = `<div class="p-20 text-center italic text-slate-300">üìÇ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</div>`;
        } else {
            body.innerHTML = `
                <div class="p-6 space-y-4">
                    <h4 class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-widest">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h4>
                    <div class="grid grid-cols-1 gap-3">
                        ${treatments.slice().reverse().map((t, idx) => `
                            <div class="bg-white border border-pink-100 p-4 rounded-2xl shadow-sm hover:border-[#FF4B91]/30 transition-all">
                                <span class="bg-pink-50 text-[#FF4B91] text-[10px] px-3 py-1 rounded-full font-bold uppercase">üìÖ ${t.date} | üïí ${t.time}</span>
                                <div class="bg-slate-50 p-4 rounded-xl mt-3 text-slate-700 text-sm whitespace-pre-line">${t.detail}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }
    }
    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    else {
        body.innerHTML = `<div class="p-20 text-center text-slate-300 font-bold italic uppercase">‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤...</div>`;
    }
};

window.printOPD = function(index) {
    const c = customerDB[index];
    const target = document.getElementById('dynamicContent');
    
    window.autoFillCourse = function(courseName, amount, totalPrice) {
        const typeSelect = document.getElementById('opdTypeSelector');
        if (typeSelect.value !== 'skin_injection') {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó OPD ‡πÄ‡∏õ‡πá‡∏ô "‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏â‡∏µ‡∏î‡∏ú‡∏¥‡∏ß" ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞');
            return;
        }
        const tables = document.querySelectorAll('#opd-dynamic-layout table');
        let allCells = []; 
        tables.forEach(table => {
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => allCells.push(row.cells[2]));
        });
        let startIndex = allCells.findIndex(cell => cell.innerText === "");
        if (startIndex === -1) return;
        for (let i = 0; i < amount; i++) {
            if (allCells[startIndex + i]) {
                allCells[startIndex + i].innerText = `${courseName} ${i+1}/${amount}`;
            }
        }
    };

    const getAge = (dateString) => {
        if (!dateString) return "-";
        const today = new Date();
        const birth = new Date(dateString.split('/').reverse().join('-'));
        let age = today.getFullYear() - birth.getFullYear();
        if (today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) age--;
        return age;
    };

    window.renderOPDByType = function(type) {
        const printableArea = document.getElementById('opd-dynamic-layout');
        let layoutHtml = '';

        if (type === 'skin_injection') {
            const row = (i) => `<tr class="border-b border-slate-300 h-7">
                <td class="p-1 text-center border-r font-bold bg-slate-50">${i}</td>
                <td class="p-1 border-r w-20"></td>
                <td class="p-1 border-r font-normal text-[9px] text-slate-700 text-left pl-2"></td>
                <td class="p-1 w-24"></td>
            </tr>`;
            layoutHtml = `
                <div class="mt-[1cm] animate-in fade-in">
                    <div class="text-center mb-1"><p class="text-[11px] font-bold ace-pink uppercase tracking-widest underline">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏â‡∏µ‡∏î‡∏ú‡∏¥‡∏ß)</p></div>
                    <div class="grid grid-cols-2 gap-2">
                        <table class="w-full border border-slate-400 text-center">
                            <thead class="bg-slate-100 text-[9px]"><tr><th class="p-1 border-r w-8 font-bold">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà</th><th class="p-1 border-r font-bold w-20">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-1 border-r font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™</th><th class="p-1 font-bold w-24">‡∏ú‡∏π‡πâ‡∏ó‡∏≥ / ‡πÄ‡∏ã‡πá‡∏ô</th></tr></thead>
                            <tbody>${[1,2,3,4,5,6,7].map(i => row(i)).join('')}</tbody>
                        </table>
                        <table class="w-full border border-slate-400 text-center">
                            <thead class="bg-slate-100 text-[9px]"><tr><th class="p-1 border-r w-8 font-bold">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà</th><th class="p-1 border-r font-bold w-20">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-1 border-r font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™</th><th class="p-1 font-bold w-24">‡∏ú‡∏π‡πâ‡∏ó‡∏≥ / ‡πÄ‡∏ã‡πá‡∏ô</th></tr></thead>
                            <tbody>${[8,9,10,11,12,13,14].map(i => row(i)).join('')}</tbody>
                        </table>
                    </div>
                    <div class="mt-2 no-print">
                        <textarea id="treatmentNotesSkin" class="w-full h-12 border border-dotted border-slate-300 p-2 text-xs outline-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ô‡∏µ‡πâ..."></textarea>
                    </div>
                    <div class="hidden print:block text-[10px] mt-2 italic border-t border-slate-100 pt-1" id="printNotesSkin"></div>
                </div>`;
        } else if (type === 'botox_filler' || type === 'varicose_veins') {
            layoutHtml = `
                <div class="mt-4 border border-slate-300 p-4 h-[440px] bg-white animate-in fade-in text-left">
                    <p class="text-[11px] font-bold ace-pink text-center mb-4 uppercase tracking-widest underline">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (${type === 'botox_filler' ? 'Botox/Filler' : '‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≠‡∏î'})</p>
                    <div class="flex h-full">
                        <div class="w-1/2 border-r border-dashed border-slate-300 pr-4"></div>
                        <div class="w-1/2 pl-4 text-[11px] space-y-3 font-normal">
                            <p><b>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</b> .....................................................</p>
                            <p><b>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠/Lot:</b> .....................................................</p>
                            <p><b>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (Unit/CC):</b> .....................................</p>
                            <div class="mt-4">
                                <p class="mb-1 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</p>
                                <textarea id="treatmentNotesSpec" class="w-full h-40 border border-dotted border-slate-300 p-2 text-sm outline-none no-print" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                                <div class="hidden print:block whitespace-pre-line text-sm border border-slate-50 p-2 min-h-[100px]" id="printNotesSpec"></div>
                            </div>
                        </div>
                    </div>
                </div>`;
        } else {
            layoutHtml = `
                <div class="mt-4 border border-slate-300 h-[440px] bg-slate-50/10 p-4 animate-in fade-in text-left">
                    <p class="text-[11px] font-bold ace-pink text-center mb-4 uppercase tracking-widest underline">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</p>
                    <textarea id="treatmentNotesGeneral" class="w-full h-80 bg-transparent border-none outline-none no-print text-sm" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                    <div class="hidden print:block whitespace-pre-line text-sm" id="printNotesGeneral"></div>
                </div>`;
        }
        printableArea.innerHTML = layoutHtml;
    };

    target.innerHTML = `
        <div class="max-w-4xl mx-auto p-4 font-normal text-slate-800 bg-slate-100 min-h-screen">
            <div class="no-print mb-4 space-y-2 text-left">
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-pink-100">
                    <p class="text-[10px] font-bold text-pink-500 mb-2 uppercase tracking-widest">üõí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á :</p>
                    <div class="flex flex-wrap gap-2">
                        ${(c.courses || []).map(course => {
                            const p = parseFloat(String(course.price).replace(/[^0-9.-]+/g,"")) || 0;
                            return `<button onclick="autoFillCourse('${course.name}', ${course.amount}, ${p})" class="bg-pink-50 hover:bg-pink-500 hover:text-white border border-pink-200 px-4 py-2 rounded-xl text-[11px] font-bold transition-all shadow-sm">‚ûï ${course.name}</button>`;
                        }).join('')}
                    </div>
                </div>
                <div class="bg-[#337373] p-3 rounded-2xl shadow-sm flex items-center justify-between text-white">
                    <div class="flex items-center gap-4">
                        <label class="text-xs font-bold uppercase">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó OPD :</label>
                        <select id="opdTypeSelector" onchange="renderOPDByType(this.value)" class="bg-white text-[#337373] px-5 py-2 rounded-xl text-xs font-bold outline-none">
                            <option value="general">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                            <option value="botox_filler">üíâ Botox / Filler</option>
                            <option value="skin_injection">‚ú® ‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏â‡∏µ‡∏î‡∏ú‡∏¥‡∏ß (‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏≠‡πÇ‡∏ï‡πâ)</option>
                            <option value="varicose_veins">ü¶µ ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≠‡∏î</option>
                        </select>
                    </div>
                    <button onclick="renderOPDByType(document.getElementById('opdTypeSelector').value)" class="text-[10px] bg-[#2a5e5e] hover:bg-[#1f4747] px-4 py-2 rounded-xl transition-all font-bold">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á / ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>

            <div id="opd-card-printable" class="bg-white p-6 shadow-sm border border-slate-200 mx-auto" style="width: 21cm; height: 14.8cm; line-height: 1.1; overflow: hidden;">
                <div class="flex justify-between items-start mb-2 text-left">
                    <div class="flex gap-2">
                        <img src="ace-logo.jpg" class="w-12 h-12 object-contain" onerror="this.src='https://via.placeholder.com/50?text=ACE'">
                        <div class="text-[10px] font-normal">
                            <h2 class="text-sm font-bold text-slate-900">‡πÄ‡∏≠‡∏ã ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ</h2>
                            <p>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï : ‡πë‡πë‡πë‡πê‡πë‡πê‡πê‡πï‡πë‡πñ‡πñ | ‡πÇ‡∏ó‡∏£ : 097-0942875</p>
                            <p>456/7 ‡∏´‡∏°‡∏π‡πà 10 ‡∏ï.‡∏ö‡∏≤‡∏á‡∏õ‡∏•‡∏≤ ‡∏≠.‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ ‡∏à.‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ 10540</p>
                        </div>
                    </div>
                    <div class="text-right text-[10px] font-normal">
                        <p class="text-sm font-bold">HN : <span class="ace-pink">${c.hn}</span></p>
                        <p class="text-red-600 font-bold uppercase">‡πÅ‡∏û‡πâ‡∏¢‡∏≤ : <span class="font-normal underline text-slate-900">${c.allergy || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</span></p>
                        <p>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß : <span class="font-normal">${c.chronicDisease || '-'}</span></p>
                        <p>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ : <span class="font-normal">${c.currentMedication || '-'}</span></p>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-y-0.5 text-[10px] mb-2 pb-2 border-y border-slate-200 pt-1 font-normal text-left">
                    <div class="col-span-2"><b>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• :</b> ${c.fullname}</div>
                    <div><b>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô :</b> ${c.nickname || '-'}</div>
                    <div><b>‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î :</b> ${c.birthDate || '-'}</div>
                    <div><b>‡∏≠‡∏≤‡∏¢‡∏∏ :</b> ${getAge(c.birthDate)} ‡∏õ‡∏µ</div>
                    <div class="col-span-3"><b>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ :</b> ${c.phone}</div>
                    <div class="col-span-2"><b>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ç‡∏≤‡∏ï‡∏¥‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô :</b> ${c.emergencyContact || '-'}</div>
                    <div class="col-span-2"><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà :</b> ${c.address || '-'}</div>
                </div>

                <div id="opd-dynamic-layout"></div>
            </div>

            <div class="flex justify-between items-center no-print mt-6 px-4">
                <button onclick="loadPage(2, '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤')" class="text-slate-400 font-bold text-xs uppercase">üîô ‡∏Å‡∏•‡∏±‡∏ö</button>
                <div class="flex gap-3">
                    <button onclick="saveTreatmentHistory(${index})" class="bg-slate-700 text-white px-8 py-3 rounded-2xl font-bold text-xs shadow-md">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="handleOPDPrint()" class="bg-[#D4AF37] text-white px-10 py-3 rounded-2xl font-bold text-xs shadow-xl">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
                </div>
            </div>
        </div>
    `;
    renderOPDByType('general'); 
};

window.handleOPDPrint = function() {
    const type = document.getElementById('opdTypeSelector').value;
    if (type === 'general') {
        const notes = document.getElementById('treatmentNotesGeneral');
        document.getElementById('printNotesGeneral').innerText = notes ? notes.value : '';
    } else if (type === 'botox_filler' || type === 'varicose_veins') {
        const notes = document.getElementById('treatmentNotesSpec');
        document.getElementById('printNotesSpec').innerText = notes ? notes.value : '';
    } else if (type === 'skin_injection') {
        const notes = document.getElementById('treatmentNotesSkin');
        document.getElementById('printNotesSkin').innerText = notes ? notes.value : '';
    }
    window.print();
};
document.addEventListener('click', () => {
    document.querySelectorAll("[id^='action-menu-']").forEach(m => m.classList.add('hidden'));
});

/* =======================================================
    üí∏ ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏µ‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å / ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô / ‡∏ï‡∏±‡∏ß‡∏ï‡∏£‡∏á‡∏ö‡∏≤‡∏á)
   ======================================================= */
window.renderSalesPage = function() {
    const target = document.getElementById('dynamicContent');
    if (!target) return;
    
    const incomes = JSON.parse(localStorage.getItem('accountDB')) || [];
    const today = new Date().toISOString().split('T')[0];
    
    const dateFilter = document.getElementById('billDateFilter')?.value || today;
    const currentSearch = document.getElementById('billSearchInput')?.value || "";
    const statusFilter = document.getElementById('billStatusFilter')?.value || "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    const billPageSize = parseInt(document.getElementById('billPageSize')?.value) || 10;

    // üéØ ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á (Filter) ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏¥‡∏•
    let filteredData = incomes.filter(item => {
        if (item.type !== "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö") return false; 
        const nameVal = String(item.customerName || item.customer || "").toLowerCase();
        const hnVal = String(item.hn || "").toLowerCase();
        const searchVal = currentSearch.toLowerCase().trim();
        return (nameVal.includes(searchVal) || hnVal.includes(searchVal)) &&
               (statusFilter === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || item.status === statusFilter) &&
               (!dateFilter || item.date === dateFilter);
    });

    filteredData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    const totalPages = Math.ceil(filteredData.length / billPageSize) || 1;
    if (typeof window.currentBillPage === 'undefined') window.currentBillPage = 1;
    const startIndex = (window.currentBillPage - 1) * billPageSize;
    const paginatedData = filteredData.slice(startIndex, startIndex + billPageSize);

    target.innerHTML = `
    <div class="animate-in fade-in duration-500 font-light pb-20 -mt-6 text-left">
        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-pink-100 no-print mb-6">
            <div class="flex flex-nowrap items-end gap-4 overflow-x-auto pb-2 scrollbar-hide">
                
                <div class="flex flex-col gap-1 shrink-0">
                    <label class="text-[10px] font-bold text-[#D48197] uppercase ml-2">‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö</label>
                    <select id="billPageSize" onchange="window.currentBillPage=1; renderSalesPage()" class="border border-pink-100 px-4 py-2.5 rounded-2xl text-[13px] font-light bg-slate-50 outline-none shadow-sm min-w-[120px] text-slate-600 appearance-none cursor-pointer">
                        <option value="10" ${billPageSize === 10 ? 'selected' : ''}>10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                        <option value="30" ${billPageSize === 30 ? 'selected' : ''}>30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                        <option value="50" ${billPageSize === 50 ? 'selected' : ''}>50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                    </select>
                </div>

                <div class="flex flex-col gap-1 shrink-0">
                    <label class="text-[10px] font-bold text-[#D48197] uppercase ml-2">‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                    <select id="billStatusFilter" onchange="window.currentBillPage=1; renderSalesPage()" class="border border-pink-100 px-4 py-2.5 rounded-2xl text-[13px] font-light bg-slate-50 outline-none shadow-sm min-w-[140px] text-slate-600 appearance-none cursor-pointer">
                        <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ${statusFilter === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' ? 'selected' : ''}>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="‡∏õ‡∏Å‡∏ï‡∏¥" ${statusFilter === '‡∏õ‡∏Å‡∏ï‡∏¥' ? 'selected' : ''}>‚è≥ ‡∏õ‡∏Å‡∏ï‡∏¥</option>
                        <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ${statusFilter === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                        <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ${statusFilter === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ? 'selected' : ''}>‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                    </select>
                </div>

                <div class="flex flex-col gap-1 shrink-0">
                    <label class="text-[10px] font-bold text-[#D48197] uppercase ml-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏µ‡∏ö‡∏¥‡∏•</label>
                    <input type="date" id="billDateFilter" value="${dateFilter}" onchange="window.currentBillPage=1; renderSalesPage()" class="border border-pink-100 px-4 py-2.5 rounded-2xl text-[13px] font-light bg-slate-50 outline-none text-slate-600 shadow-sm cursor-pointer">
                </div>

                <div class="flex flex-col gap-1 flex-1 min-w-[250px]">
                    <label class="text-[10px] font-bold text-[#D48197] uppercase ml-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏ä‡∏∑‡πà‡∏≠/HN)</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input type="text" id="billSearchInput" value="${currentSearch}" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter..." onkeyup="if(event.key === 'Enter') { window.currentBillPage=1; renderSalesPage(); }" class="w-full border border-pink-100 pl-10 pr-4 py-2.5 rounded-2xl text-[13px] font-light bg-slate-50 outline-none focus:ring-1 focus:ring-pink-200 transition-all text-slate-700">
                            <span class="absolute left-4 top-2.5 text-slate-300">üîç</span>
                        </div>
                        <button onclick="window.currentBillPage=1; renderSalesPage()" class="bg-[#D48197] text-white px-6 py-2 rounded-2xl text-[11px] font-bold shadow-md hover:bg-black transition-all shrink-0">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>
                </div>

                <button onclick="openNewBillProcess()" class="bg-black text-white px-6 py-2.5 rounded-2xl text-[11px] font-bold shadow-xl hover:bg-[#D48197] transition-all uppercase flex items-center gap-2 shrink-0 mb-0.5">
                    <span class="bg-white text-black w-5 h-5 rounded-full flex items-center justify-center text-sm font-bold">+</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                </button>
            </div>
        </div>

      <div class="bg-white rounded-[3rem] shadow-2xl border border-pink-100 p-8 min-h-[400px]">
    <table class="w-full text-center text-sm border-separate border-spacing-y-0">
        <thead>
            <tr style="height: 55px;">
                <th class="bg-[#D48197] text-white font-normal px-4 rounded-l-[1.5rem]">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</th>
                <th class="bg-[#D48197] text-white font-normal px-2">HN</th>
                <th class="bg-[#D48197] text-white font-normal px-4 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ</th>
                <th class="bg-[#D48197] text-white font-normal px-4 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th class="bg-[#D48197] text-white font-normal px-2 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th class="bg-[#D48197] text-white font-normal px-2 text-center">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                <th class="bg-[#D48197] text-white font-normal px-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="bg-[#D48197] text-white font-normal px-4 rounded-r-[1.5rem]">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
        </thead>
       <tbody class="text-slate-600 font-normal">
            ${paginatedData.length > 0 ? paginatedData.map((item, i) => `
                <tr class="border-b border-pink-50 hover:bg-pink-50/20 transition-all font-normal" style="height: 60px;">
                    <td class="p-2 text-[11px] text-slate-400 font-normal">${item.date}</td>
                    <td class="p-2 font-normal text-[#D48197]">${item.hn || '-'}</td>
                    <td class="p-2 text-left font-normal text-slate-800">${item.customer || item.customerName}</td>
                    <td class="p-2 text-left text-[11px] leading-tight text-slate-400 font-normal">
                        ${(item.items || []).map(p => `‚Ä¢ ${p.name}`).join('<br>')}
                    </td>
                    <td class="p-2 text-right font-normal text-slate-800">
                        ‡∏ø${parseFloat(String(item.total || 0).replace(/[^0-9.-]+/g,"")).toLocaleString()}
                    </td>
                    <td class="p-2 text-[11px] text-center font-normal">${item.payment || '-'}</td>
                    <td class="p-2 text-center">
    <span class="px-3 py-1 rounded-full text-[10px] font-normal 
        ${item.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'bg-green-100 text-green-600' : 
          item.status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ? 'bg-red-100 text-red-600' : 'bg-yellow-100 text-yellow-600'}">
        ${item.status || '‡∏õ‡∏Å‡∏ï‡∏¥'}
    </span>
</td>
                   <td class="p-2 text-center relative" style="overflow: visible !important;">
    <div class="inline-flex items-center bg-[#D48197] text-white rounded-full p-1 shadow-md scale-90 relative" 
         style="z-index: 50;" onclick="this.closest('tr').style.zIndex = '9999';">
        
        <button onclick="window.viewBillOnly('${item.id}')" 
                class="px-5 py-1.5 text-[11px] font-normal border-r border-white/30 hover:bg-white/10 rounded-l-full flex items-center gap-2 uppercase">
            <span class="text-sm">‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</span> 
        </button>

        <button onclick="event.stopPropagation(); window.safeToggleMenu(event, ${i})" 
                class="px-3 py-1.5 text-[10px] hover:bg-white/10 rounded-r-full transition-all cursor-pointer">
            ‚ñº
        </button>
        
        <div id="action-menu-${i}" 
             class="hidden absolute right-0 top-full mt-3 w-64 bg-white border border-pink-100 rounded-[2rem] shadow-2xl z-[999999] overflow-hidden text-left font-normal animate-in fade-in slide-in-from-top-2 duration-300">
            <div class="p-4 space-y-1 bg-white relative">
                <button onclick="window.openOldReceiptById('${item.id}')" class="w-full p-3.5 text-[13px] text-slate-600 hover:bg-pink-50 rounded-2xl flex items-center gap-4 transition-all group">
                    <img src="https://cdn-icons-png.flaticon.com/128/443/443324.png" class="w-5 h-5 grayscale group-hover:grayscale-0"> 
                    <span>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</span>
                </button>
                
                <button onclick="window.printFullTaxInvoice('${item.id}', '${item.hn}')" class="w-full p-3.5 text-[13px] text-slate-600 hover:bg-pink-50 rounded-2xl flex items-center gap-4 transition-all group">
                    <img src="https://cdn-icons-png.flaticon.com/128/2912/2912773.png" class="w-5 h-5 grayscale group-hover:grayscale-0"> 
                    <span>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</span>
                </button>
                
                <div class="border-t border-pink-50/50 my-2"></div>
                <button onclick="window.cancelBillProcess('${item.id}', '${item.hn}')" class="w-full p-3.5 text-[13px] text-red-400 hover:bg-red-50 rounded-2xl flex items-center gap-4 transition-all font-normal">
                    <span class="text-xl">‚ùå</span> <span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•</span>
                </button>
            </div>
        </div>
    </div>
</td>
                </tr>
            `).join('') : `<tr><td colspan="8" class="p-20 text-center italic text-slate-300 text-base font-normal">üö¶ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡πà‡∏∞</td></tr>`}
        </tbody>
            </table>
        </div>
    </div>`;
};

/* --- üéØ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå 3 ‡∏Å‡∏•‡πà‡∏≠‡∏á + ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á + ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö --- */
window.openNewBillProcess = function() {
    const target = document.getElementById('dynamicContent');
    const today = new Date().toISOString().split('T')[0];
    window.currentBillItems = []; 

    target.innerHTML = `
        <div class="animate-in fade-in duration-500 p-4 -mt-6 text-left font-normal tracking-tight bg-white min-h-screen">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-pink-100 mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-normal text-[#FF4B91] uppercase">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ / ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà</h2>
                    <p class="text-[10px] text-slate-400 font-normal uppercase mt-1 italic">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${today}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="confirmFinalPayment()" class="bg-[#D48197] text-white px-8 py-3 rounded-2xl text-xs font-normal shadow-lg hover:brightness-110 transition-all uppercase">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="renderSalesPage()" class="bg-slate-400 text-white px-6 py-3 rounded-2xl text-xs font-normal shadow-md hover:bg-slate-50 transition-all uppercase">X</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-6">
                <div class="lg:col-span-2 flex justify-center items-start">
                    <div class="w-32 h-32 rounded-3xl bg-pink-50 border-2 border-dashed border-pink-200 flex items-center justify-center overflow-hidden">
                        <img id="billCustPhoto" src="" class="w-full h-full object-cover hidden">
                        <span id="billPhotoIcon" class="text-4xl text-pink-200">üë§</span>
                    </div>
                </div>

                <div class="lg:col-span-10">
                    <div class="relative mb-6">
                        <label class="text-[10px] text-[#FF4B91] font-normal uppercase ml-2 mb-1 block">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ (HN ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠)</label>
                        <input type="text" id="custSearchForBillInp" oninput="searchCustomerForBill(this.value)" 
                               placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå HN ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ 3 ‡∏Å‡∏•‡πà‡∏≠‡∏á..." 
                               class="w-full border border-pink-200 p-4 rounded-2xl outline-none text-sm bg-[#FFF9FA] font-normal shadow-sm">
                        <div id="customerSearchResult" class="absolute left-0 right-0 bg-white shadow-2xl rounded-2xl mt-1 hidden border border-pink-100 max-h-60 overflow-y-auto z-[9999]"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-[1.5rem] border border-cyan-100 shadow-sm space-y-2">
                            <p class="text-[11px] text-cyan-600 border-b border-cyan-50 pb-1 font-normal">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ: <span id="billHN" class="text-slate-700">-</span></p>
                            <p class="text-[11px] text-cyan-600 border-b border-cyan-50 pb-1 font-normal">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•: <span id="billFullName" class="text-slate-700">-</span></p>
                            <p class="text-[11px] text-cyan-600 border-b border-cyan-50 pb-1 font-normal">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: <span id="billNickName" class="text-slate-700">-</span></p>
                        </div>
                        <div class="bg-white p-5 rounded-[1.5rem] border border-cyan-100 shadow-sm space-y-2">
                            <p class="text-[11px] text-cyan-600 border-b border-cyan-50 pb-1 font-normal">‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥: <span id="billNationality" class="text-slate-700">-</span></p>
                            <p class="text-[11px] text-cyan-600 border-b border-cyan-50 pb-1 font-normal">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: <span id="billPhone" class="text-slate-700">-</span></p>
                            <p class="text-[11px] text-cyan-600 font-normal">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏±‡∏Å‡∏©‡∏≤: <span id="billRight" class="text-slate-700">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span></p>
                        </div>
                        <div class="bg-white p-5 rounded-[1.5rem] border border-cyan-100 shadow-sm space-y-2">
                            <div class="flex justify-between text-[11px] text-cyan-600 border-b border-cyan-50 pb-1">
                                <span>‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô:</span><span id="billCredit" class="text-slate-700 font-normal">0</span>
                            </div>
                            <div class="mt-1">
                                <label class="text-[9px] text-red-400 uppercase font-bold">üö® ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ:</label>
                                <p id="billAllergy" class="text-xs text-red-600 font-normal">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="billingFormArea" class="hidden">
                <div class="bg-pink-50/30 p-8 rounded-[2.5rem] border border-dashed border-pink-200 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-5 items-end">
                        <div class="md:col-span-6 relative">
                            <label class="text-[10px] text-slate-400 ml-2 block uppercase font-normal">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡∏≤</label>
                            <input type="text" id="itemName" oninput="searchProduct(this.value)" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™..." class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm bg-white font-normal shadow-sm">
                            <div id="searchResult" class="absolute z-50 w-full bg-white shadow-xl rounded-2xl mt-1 hidden max-h-48 overflow-y-auto border border-pink-50"></div>
                        </div>
                        <div class="md:col-span-2">
                            <input type="number" id="billPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm text-center bg-white font-normal">
                        </div>
                        <div class="md:col-span-2">
                            <input type="number" id="billQty" value="1" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm text-center bg-white font-normal">
                        </div>
                        <div class="md:col-span-2">
                            <button onclick="addItemToBill()" class="w-full bg-[#FF4B91] text-white py-3 rounded-2xl text-[11px] font-normal shadow-md">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-[2rem] shadow-xl border border-pink-100 p-8 min-h-[300px]">
                    <table class="w-full text-center text-sm font-normal">
                        <thead class="bg-cyan-50 text-cyan-700">
                            <tr style="height: 50px;">
                                <th class="rounded-l-2xl font-normal px-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="font-normal">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="text-right font-normal">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="text-right font-normal">‡∏£‡∏ß‡∏° (‡∏ø)</th><th class="rounded-r-2xl font-normal">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="billItemsList" class="text-slate-600 font-normal"></tbody>
                    </table>

                    <div class="mt-8 pt-8 border-t border-slate-100 flex flex-col md:flex-row justify-between items-end gap-6">
                        <div class="w-full md:w-80 text-left">
                            <label class="text-[10px] text-slate-400 uppercase font-bold ml-2">üí≥ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                            <select id="billPaymentMethod" class="w-full bg-slate-50 border border-pink-100 rounded-2xl p-4 text-sm outline-none mt-1 font-normal">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô --</option>
                                <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                                <option value="‡πÇ‡∏≠‡∏ô (QR)">üì± ‡πÇ‡∏≠‡∏ô (QR)</option>
                                <option value="‡πÇ‡∏≠‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">üè¢ ‡πÇ‡∏≠‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</option>
                                <option value="Shopee">üõçÔ∏è Shopee</option>
                                <option value="Gowabi">üéüÔ∏è Gowabi</option>
                            </select>
                        </div>
                        <div class="text-right font-normal">
                            <p class="text-[10px] text-slate-400 font-bold uppercase">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                            <h5 id="grandTotalDisplay" class="text-6xl text-[#FF4B91] font-normal tracking-tighter">‡∏ø0.00</h5>
                        </div>
                    </div>
                </div>
            </div>
            <div id="noCustomerHint" class="text-center text-slate-300 italic pt-24 animate-pulse">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏µ‡∏ö‡∏¥‡∏•‡∏Ñ‡πà‡∏∞</div>
        </div>`;
};

/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ --- */
window.searchCustomerForBill = function(val) {
    const resDiv = document.getElementById('customerSearchResult');
    if (!val || val.length < 1) { resDiv.classList.add('hidden'); return; }
    const matches = customerDB.filter(c => (c.fullname && c.fullname.includes(val)) || (c.hn && c.hn.includes(val)));
    if (matches.length > 0) {
        resDiv.innerHTML = matches.map(c => `<div onclick="selectCustomerToBill('${c.hn}')" class="p-4 hover:bg-pink-50 cursor-pointer border-b border-pink-50 flex justify-between items-center font-normal bg-white"><span class="text-sm text-slate-700">${c.fullname}</span><span class="text-[10px] bg-cyan-100 text-cyan-700 px-2 py-0.5 rounded-full uppercase">${c.hn}</span></div>`).join('');
        resDiv.classList.remove('hidden');
    } else { resDiv.classList.add('hidden'); }
};

/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á --- */
window.selectCustomerToBill = function(hn) {
    const c = customerDB.find(item => item.hn === hn);
    if (!c) return;
    window.activeCustomer = c;
    document.getElementById('billHN').innerText = c.hn || '-';
    document.getElementById('billFullName').innerText = c.fullname || '-';
    document.getElementById('billNickName').innerText = c.nickname || '-';
    document.getElementById('billPhone').innerText = c.phone || '-';
    document.getElementById('billAllergy').innerText = c.allergy || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ';
    
    const img = document.getElementById('billCustPhoto');
    const icon = document.getElementById('billPhotoIcon');
    if (c.photo) { img.src = c.photo; img.classList.remove('hidden'); icon.classList.add('hidden'); } 
    else { img.classList.add('hidden'); icon.classList.remove('hidden'); }

    document.getElementById('billingFormArea').classList.remove('hidden');
    document.getElementById('noCustomerHint').classList.add('hidden');
    document.getElementById('customerSearchResult').classList.add('hidden');
    document.getElementById('custSearchForBillInp').value = c.fullname;
};
/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏¥‡∏• (‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏£‡∏á 100%) --- */
function renderBillItems() {
    const listBody = document.getElementById('billItemsList');
    let grandTotal = 0;

    if (currentBillItems.length === 0) {
        listBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-300 font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</td></tr>`;
    } else {
        listBody.innerHTML = currentBillItems.map((item, index) => {
            grandTotal += item.total;
            return `
                <tr class="border-b border-pink-50 hover:bg-pink-50/20 transition-all font-bold">
                    <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded-lg text-[10px] uppercase">${item.cat === 'medicine' ? '‡∏¢‡∏≤/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡∏Ñ‡∏≠‡∏£‡πå‡∏™'}</span></td>
                    <td class="p-4 text-slate-700">${item.name}</td>
                    <td class="p-4 text-center text-slate-600">${item.qty}</td>
                    <td class="p-4 text-right text-slate-600">‡∏ø${item.price.toLocaleString()}</td>
                    <td class="p-4 text-right ace-pink">‡∏ø${item.total.toLocaleString()}</td>
                   <td class="p-4 text-center">
    <button onclick="removeItemFromBill(${index})" 
            class="bg-slate-100 p-2 rounded-lg hover:bg-red-100 text-red-400 transition-all">‚úï</button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    document.getElementById('grandTotalDisplay').innerText = '‡∏ø' + grandTotal.toLocaleString();
}

    /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô --- */
let selectedPaymentMethod = ""; 

window.selectPaymentType = function(btn, type) {
    document.querySelectorAll('#paymentMethods button').forEach(b => {
        b.classList.remove('border-pink-500', 'text-pink-500', 'bg-pink-50');
    });
    btn.classList.add('border-pink-500', 'text-pink-500', 'bg-pink-50');
    selectedPaymentMethod = type; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
};

/* --- üíæ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏• (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) --- */
window.confirmFinalPayment = function() {
    try {
        const paymentSelect = document.getElementById('billPaymentMethod');
        const paymentValue = paymentSelect ? paymentSelect.value : "";
        const dateInput = document.getElementById('billDate');
        const billDate = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
        const totalRaw = document.getElementById('grandTotalDisplay').innerText;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ 3 ‡∏Å‡∏•‡πà‡∏≠‡∏á
        const customerName = document.getElementById('billFullName').innerText;
        const customerHN = document.getElementById('billHN').innerText;

        if (customerHN === "-" || currentBillItems.length === 0 || !paymentValue) {
            alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ñ‡πà‡∏∞');
            return;
        }

        // üéØ 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å (accountDB)
        const newBillEntry = {
            id: Date.now(),
            date: billDate,
            hn: customerHN,
            customerName: customerName,
            customer: customerName, 
            items: [...currentBillItems],
            total: totalRaw,
            payment: paymentValue,
            status: "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô",
            type: "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö",
            timestamp: new Date().getTime()
        };

        // üéØ 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• accountDB ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        let accountDB = JSON.parse(localStorage.getItem('accountDB')) || [];
        accountDB.push(newBillEntry);
        localStorage.setItem('accountDB', JSON.stringify(accountDB));

        // üéØ 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏£‡∏≠‡∏∏‡∏°‡∏≤)
        if (window.activeCustomer) {
            if (!window.activeCustomer.courses) window.activeCustomer.courses = [];
            currentBillItems.forEach(item => {
                window.activeCustomer.courses.push({
                    name: item.name,
                    amount: item.qty || 1,
                    date: billDate
                });
            });
            const idx = customerDB.findIndex(c => c.hn === window.activeCustomer.hn);
            if (idx !== -1) {
                customerDB[idx] = window.activeCustomer;
                localStorage.setItem('customerDB', JSON.stringify(customerDB));
            }
        }

        alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${customerName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞!`);

        // üéØ 4. ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        renderSalesPage(); 

    } catch (e) { 
        console.error("Error saving bill:", e);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message); 
    }
};
/* =======================================================
   üíé ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à / ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ
   ======================================================= */

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå
window.showReceiptPreview = function(billData) {
    const target = document.getElementById('dynamicContent');
    target.innerHTML = `
        <div class="animate-in zoom-in duration-300 flex flex-col items-center p-10 bg-slate-50 min-h-screen font-bold">
            <div id="printableReceipt" class="bg-white w-[500px] p-10 shadow-2xl border border-pink-100 rounded-sm text-slate-800">
                <div class="text-center border-b-2 border-[#FF4B91] pb-6 mb-6">
                    <h2 class="text-2xl text-[#FF4B91] font-black uppercase tracking-tighter">ACE CLINIC RECEIPT</h2>
                    <p class="text-[10px] text-slate-400 mt-1 uppercase font-bold">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠ (INCOMING)</p>
                </div>
                <div class="flex justify-between text-[11px] mb-6">
                    <div><p>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${billData.customer}</p><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${billData.date}</p></div>
                    <div class="text-right uppercase"><p>INV-${Date.now().toString().slice(-6)}</p><p>‡∏™‡∏≤‡∏Ç‡∏≤: ‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ</p></div>
                </div>
                <table class="w-full text-[11px] mb-8">
                    <thead class="border-b border-slate-100"><tr><th class="py-2 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="py-2 text-right">‡∏£‡∏ß‡∏° (‡∏ø)</th></tr></thead>
                    <tbody>
                        ${currentBillItems.map(item => `
                            <tr class="border-b border-slate-50">
                                <td class="py-3">${item.name} x ${item.qty}</td>
                                <td class="py-3 text-right">${item.total.toLocaleString()}</td>
                            </tr>`).join('')}
                    </tbody>
                </table>
                <div class="text-right space-y-1 mb-10">
                    <p class="text-lg">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span class="text-[#FF4B91] text-2xl font-black">‡∏ø${billData.total}</span></p>
                    <p class="text-[10px] text-slate-400 font-bold">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á: ${billData.payment}</p>
                </div>
            </div>
            <div class="flex gap-4 mt-10 no-print">
    <button onclick="window.print()" class="bg-[#FF4B91] text-white px-10 py-3 rounded-2xl font-bold shadow-xl">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
    
    <button onclick="renderSalesPage()" 
    class="bg-white border border-slate-200 px-10 py-3 rounded-2xl font-bold text-slate-400 hover:bg-slate-50 transition-all">
    üîô ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏¥‡∏•
</button>
</div>
        </div>`;
};

// 2. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏µ‡πÅ‡∏î‡∏á)
window.renderExpenseTable = function() {
    const listArea = document.getElementById('expenseListTable');
    if (!listArea) return;
    listArea.innerHTML = `
        <div class="overflow-hidden rounded-[1.5rem] border border-red-50 shadow-sm mt-8 animate-in fade-in">
            <table class="w-full text-left font-bold">
                <thead class="bg-red-50 text-[11px] text-red-500 uppercase">
                    <tr><th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="p-4 text-center">‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th class="p-4 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</th></tr>
                </thead>
                <tbody class="text-[13px] text-slate-600 font-bold" id="expenseDataBody">
                    <tr><td colspan="4" class="p-10 text-center text-slate-300">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ...</td></tr>
                </tbody>
            </table>
        </div>`;
};

/* =======================================================
    üìà 1. ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô)
   ======================================================= */
window.renderReportPage = function() {
    const target = document.getElementById('dynamicContent');
    if(!target) return;

    target.innerHTML = `
        <div class="animate-in fade-in duration-500 font-light p-4 -mt-6 text-left pb-20">
            <div class="flex justify-between items-center mb-10 bg-white p-8 rounded-[3rem] shadow-sm border border-pink-100">
                <div>
                    <h2 class="text-2xl font-bold ace-pink italic leading-none text-left">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (ACE Reports)</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mt-2 italic tracking-widest text-left">Online Real-time System</p>
                </div>
                <div class="bg-pink-50 px-6 py-3 rounded-2xl border border-pink-100 text-center">
                    <p class="text-[9px] text-[#D48197] font-bold uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</p>
                    <p class="text-sm font-black text-slate-700 uppercase tracking-tighter italic">Status: Connected</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                
                <div class="space-y-4">
                    <div class="flex items-center gap-3 mb-4 ml-4"><span class="text-2xl">üì¶</span><h3 class="text-sm font-bold text-slate-500 uppercase italic">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</h3></div>
                    <div class="flex flex-col gap-2">
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', 'reportInventory()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏', 'reportLowStock()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤', 'reportDrugUsage()')}
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center gap-3 mb-4 ml-4"><span class="text-2xl">üë•</span><h3 class="text-sm font-bold text-slate-500 uppercase italic">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3></div>
                    <div class="flex flex-col gap-2">
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', 'reportNewCustomers()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', 'reportSalesByType()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏â‡∏µ‡∏î (3/6/12 ‡∏î.)', 'reportCRM()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', 'reportRemainingCourse()')}
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center gap-3 mb-4 ml-4"><span class="text-2xl">üí∞</span><h3 class="text-sm font-bold text-slate-500 uppercase italic">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3></div>
                    <div class="flex flex-col gap-2">
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡πÇ‡∏≠‡∏ô/‡∏ö‡∏±‡∏ï‡∏£)', 'reportRevenue()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ DF/‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô', 'reportStaffDF()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ)', 'reportProfitLoss()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£ ‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤/‡∏°‡∏≤‡∏™‡∏≤‡∏¢', 'reportAttendance()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'reportPayroll()')}
                    </div>
                </div>

            </div>
            
            <div class="mt-20 border-t border-pink-100 pt-10 text-center opacity-30">
                <p class="text-[9px] text-slate-300 font-bold uppercase tracking-[0.5em] italic">Luxury Management Intelligence</p>
            </div>
        </div>
    `;
};
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
function renderReportButton(title, action) {
    return `
        <button onclick="${action}" class="w-full text-left bg-white p-5 rounded-[1.5rem] border border-pink-50 shadow-sm hover:shadow-xl hover:-translate-y-0.5 transition-all group flex justify-between items-center outline-none">
            <span class="text-[12px] font-bold text-slate-600 group-hover:text-[#D48197] transition-colors uppercase tracking-tighter">${title}</span>
            <div class="w-6 h-6 rounded-full bg-slate-50 flex items-center justify-center group-hover:bg-pink-50 transition-all">
                <span class="text-slate-200 group-hover:text-[#D48197] transition-all text-[8px]">‚ùØ</span>
            </div>
        </button>
    `;
}
/* --- üîô ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô --- */
window.backToCustomerProfile = function() {
    if (window.activeCustomer) {
        // üéØ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å DB ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        const idx = customerDB.findIndex(c => c.hn === window.activeCustomer.hn);
        if (idx !== -1) {
            viewCustomerDetail(idx);
            document.getElementById('pageTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";
        } else {
            loadPage(2, '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥');
        }
    } else {
        loadPage(2, '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥');
    }
};

/* --- üëÅÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏≤‡∏á) --- */
window.openOldReceipt = function(index, hn) {
    try {
        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
        const allBills = JSON.parse(localStorage.getItem('billHistoryDB')) || [];
        
        // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏≤‡∏ö‡∏¥‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ HN ‡∏ô‡∏µ‡πâ
        const myBills = allBills.filter(b => b.hn === hn);
        
        // 3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏î (Index)
        const selectedBill = myBills[index];
        
        if (selectedBill) {
            // üéØ ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ (selectedBill.items) 
            // ‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤/‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡πà‡∏∞
            window.currentBillItems = selectedBill.items || [];
            
            // 4. ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
            showReceiptPreview(selectedBill);
            
            // 5. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏π Luxury
            document.getElementById('pageTitle').innerText = "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á";
        } else {
            alert("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
        }
    } catch (e) {
        console.error("Error opening old receipt:", e);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏Ñ‡πà‡∏∞");
    }
};

/* =======================================================
    üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (APPOINTMENT SYSTEM LUXURY) - [‡∏ä‡∏∏‡∏î‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î]
   ======================================================= */

let selectedCoursesForApp = []; 
let currentAppPage = 1; 
let appRowsPerPage = 10; 

/* =======================================================
    üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (APPOINTMENT SYSTEM LUXURY) - [‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏á 100%]
   ======================================================= */
window.renderAppointmentPage = function() {
    const target = document.getElementById('dynamicContent');
    if (!target) return;
    
    const appointments = JSON.parse(localStorage.getItem('appointmentDB')) || [];
    const today = new Date().toISOString().split('T')[0];
    const dateFilter = document.getElementById('filterDate')?.value || today;
    const currentSearch = document.getElementById('appSearchInput')?.value || "";
    const statusFilter = document.getElementById('statusFilter')?.value || "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    const appRowsPerPage = parseInt(document.getElementById('appPageSize')?.value) || 10;

    const formatDateTH = (dateStr) => {
        if (!dateStr) return "-";
        const [y, m, d] = dateStr.split("-");
        return `${d}-${m}-${y}`;
    };

    let filteredData = appointments.filter(ap => {
        const matchSearch = ap.customerName.toLowerCase().includes(currentSearch.toLowerCase()) || 
                           (ap.hn && ap.hn.toLowerCase().includes(currentSearch.toLowerCase()));
        const matchStatus = statusFilter === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || ap.status === statusFilter;
        const matchDate = !dateFilter || ap.date === dateFilter;
        return matchSearch && matchStatus && matchDate;
    });

    filteredData.sort((a, b) => a.time.localeCompare(b.time));

    const totalPages = Math.ceil(filteredData.length / appRowsPerPage) || 1;
    const startIndex = (currentAppPage - 1) * appRowsPerPage;
    const paginatedData = filteredData.slice(startIndex, startIndex + appRowsPerPage);

    target.innerHTML = `
    <div class="animate-in fade-in duration-500 font-extralight uppercase pb-20">
        <div class="glass-card mb-8 border border-pink-200 shadow-sm p-4 rounded-3xl">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex flex-wrap gap-2 items-center flex-1">
                    <select id="appPageSize" onchange="currentAppPage=1; renderAppointmentPage()" class="border border-pink-200 px-3 py-2 rounded-xl text-[10px] outline-none bg-white font-extralight">
                        <option value="10" ${appRowsPerPage==10?'selected':''}>10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                        <option value="30" ${appRowsPerPage==30?'selected':''}>30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                    </select>
                    <select id="statusFilter" onchange="currentAppPage=1; renderAppointmentPage()" class="border border-pink-200 px-3 py-2 rounded-xl text-[10px] outline-none bg-white font-extralight">
                        <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ${statusFilter === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' ? 'selected' : ''}>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${statusFilter === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>üü° ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                        <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ${statusFilter === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>üü¢ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                        <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ${statusFilter === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ? 'selected' : ''}>üî¥ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                        <option value="‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î" ${statusFilter === '‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î' ? 'selected' : ''}>üîµ ‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î</option>
                    </select>
                    <input type="date" id="filterDate" onchange="currentAppPage=1; renderAppointmentPage()" value="${dateFilter}" class="border border-pink-200 px-3 py-2 rounded-xl text-[10px] outline-none bg-white font-extralight">
                    <div class="relative flex items-center min-w-[200px]">
                        <input id="appSearchInput" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ / HN" value="${currentSearch}" 
                            onkeyup="if(event.key === 'Enter') { currentAppPage=1; renderAppointmentPage(); }"
                            class="w-full border border-pink-200 px-4 py-2 rounded-xl text-[10px] outline-none bg-white pr-14">
                        <button onclick="currentAppPage=1; renderAppointmentPage()" class="absolute right-1 top-1 bottom-1 bg-black text-white px-3 rounded-lg text-[9px]">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="printDailyReport()" class="w-28 bg-slate-100 text-slate-500 px-4 py-2 rounded-xl text-[9px] font-extralight">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏î</button>
                    <button onclick="openAppointmentModal()" class="w-28 bg-black text-white px-4 py-2 rounded-xl text-[9px] font-extralight">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[2rem] shadow-2xl border border-pink-200 p-8 mt-4" style="min-height: 700px; overflow: visible !important;">
            <table class="w-full text-center text-[12px] border-separate border-spacing-y-0" style="overflow: visible !important;">
                <thead>
                    <tr style="height: 50px;">
                        <th class="bg-[#D48197] text-white font-normal px-4 rounded-l-[1.5rem]">‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡∏Ñ‡∏¥‡∏ß</th>
                        <th class="bg-[#D48197] text-white font-normal px-2">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                        <th class="bg-[#D48197] text-white font-normal px-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th class="bg-[#D48197] text-white font-normal px-2">HN</th>
                        <th class="bg-[#D48197] text-white font-normal px-4 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th class="bg-[#D48197] text-white font-normal px-2">‡πÄ‡∏ã‡∏•‡∏•‡πå</th>
                        <th class="bg-[#D48197] text-white font-normal px-2">‡πÅ‡∏û‡∏ó‡∏¢‡πå</th>
                        <th class="bg-[#D48197] text-white font-normal px-2">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                        <th class="bg-[#D48197] text-white font-normal px-4 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™</th>
                        <th class="bg-[#D48197] text-white font-normal px-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th class="bg-[#D48197] text-white font-normal px-4 rounded-r-[1.5rem]">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody class="text-slate-500 font-extralight">
                    ${paginatedData.length > 0 ? paginatedData.map((ap, i) => {
                        const realIndex = appointments.findIndex(item => item.createdAt === ap.createdAt);
                        const customers = JSON.parse(localStorage.getItem('customerDB')) || [];
                        const customerInfo = customers.find(c => c.hn === ap.hn);
                        const sellerName = customerInfo ? (customerInfo.sellerName || '-') : '-';

                        return `
                        <tr class="border-b border-pink-50 hover:bg-pink-50/20 transition-all font-extralight text-slate-600" style="height: 60px;">
                            <td class="p-1">
                                <button onclick="toggleConfirmApp(${realIndex})" 
                                    class="w-4 h-4 rounded-full border flex items-center justify-center mx-auto ${ap.isConfirm ? 'bg-[#D48197] border-[#D48197] text-white' : 'border-slate-200'}">
                                    <span style="font-size: 7px;">‚úîÔ∏è</span>
                                </button>
                            </td>
                            <td class="p-1">${startIndex + i + 1}</td>
                            <td class="p-1 text-[9px] leading-tight">${formatDateTH(ap.date)}<br><span class="text-[#D48197]">${ap.time}</span></td>
                            <td class="p-1 font-bold">${ap.hn || '-'}</td>
                            <td class="p-1 text-left font-normal text-slate-700">${ap.customerName}</td>
                            <td class="p-1 text-[#D48197] italic font-medium">${sellerName}</td>
                            <td class="p-1 truncate">‡∏û‡∏ç.${ap.doctor}</td>
                            <td class="p-1 truncate">${ap.staff || '-'}</td>
                            <td class="p-1 text-left leading-tight font-extralight">${ap.course || '-'}</td>
                            <td class="p-1 text-center"><span class="text-[8px] uppercase ${ap.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'text-green-500' : 'text-yellow-500'}">${ap.status}</span></td>
                            
                            <td class="p-1 text-center" style="position: relative; overflow: visible !important;">
                                <div class="relative flex items-center justify-center" style="overflow: visible !important;">
                                    <div class="inline-flex items-center bg-[#D48197] text-white rounded-full shadow-sm scale-90 relative">
                                        <button onclick="editAppointment(${realIndex})" class="pl-4 pr-3 py-2 border-r border-white/20 hover:bg-black/10 text-[12px] uppercase font-extralight">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                        <button onclick="event.preventDefault(); event.stopPropagation(); window.toggleAppActionMenu(event, ${realIndex})" class="px-2.5 py-2 hover:bg-black/10 flex items-center justify-center">
                                            <span style="font-size: 9px;">‚ñº</span>
                                        </button>
                                    </div>
                                    <div id="app-action-menu-${realIndex}" class="hidden absolute right-0 bg-white border border-pink-100 rounded-2xl shadow-2xl text-left text-slate-600 font-normal w-48" style="top: 40px; z-index: 99999 !important;">
                                        <div class="flex flex-col">
                                            <button onclick="sendToServiceQueue(${realIndex})" class="w-full px-5 py-3 text-[11px] text-green-600 hover:bg-green-50 border-b border-gray-50 flex items-center gap-3 transition-colors font-normal">üîÑ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß</button>
                                            <button onclick="alert('üóìÔ∏è ‡∏î‡∏π‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')" class="w-full px-5 py-3 text-[11px] text-gray-500 hover:bg-gray-50 border-b border-gray-50 flex items-center gap-3 transition-colors font-normal">üóìÔ∏è ‡∏î‡∏π‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                            <button onclick="printAppointmentTicket(${realIndex})" class="w-full px-5 py-3 text-[11px] text-blue-600 hover:bg-blue-50 border-b border-gray-50 flex items-center gap-3 transition-colors font-normal">üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏±‡∏î</button>
                                            <button onclick="deleteAppointment(${realIndex})" class="w-full px-5 py-3 text-[11px] text-red-500 hover:bg-red-50 flex items-center gap-3 font-bold transition-colors font-normal">üóëÔ∏è ‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>`;
                    }).join('') : `<tr><td colspan="11" class="p-20 text-center italic text-slate-300">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢...</td></tr>`}
                </tbody>
            </table>
        </div>

        <div class="flex justify-center items-center gap-4 mt-8 mb-10 font-extralight">
            <button onclick="currentAppPage=Math.max(1, currentAppPage-1); renderAppointmentPage()" ${currentAppPage === 1 ? 'disabled' : ''} class="px-6 py-2 bg-white border border-pink-200 rounded-2xl disabled:opacity-30 text-[10px] hover:bg-pink-50 transition-all">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
            <span class="text-[11px] text-[#D48197]">‡∏´‡∏ô‡πâ‡∏≤ ${currentAppPage} / ${totalPages}</span>
            <button onclick="currentAppPage=Math.min(totalPages, currentAppPage+1); renderAppointmentPage()" ${currentAppPage === totalPages ? 'disabled' : ''} class="px-6 py-2 bg-white border border-pink-200 rounded-2xl disabled:opacity-30 text-[10px] hover:bg-pink-50 transition-all">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
    </div>`;
};

window.printAppointmentTicket = function(index) {
    // ‡∏î‡∏∂‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    const db = JSON.parse(localStorage.getItem('appointmentDB')) || [];
    const ap = db[index];
    if(!ap) return;

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏ß-‡∏î-‡∏õ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå
    const d = ap.date.split("-");
    const formattedDate = `${d[2]}-${d[1]}-${d[0]}`;

    const p = window.open('', '_blank');
    p.document.write(`
        <html>
            <body style="font-family:Sarabun,sans-serif;text-align:center;padding:40px;">
                <div style="border:2px dashed #FF4B91;padding:30px;border-radius:30px;display:inline-block;text-align:left;width:300px;">
                    <h2 style="color:#FF4B91;text-align:center;">ACE CLINIC</h2>
                    <hr style="border:0.5px solid #eee;">
                    <b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${ap.customerName}<br>
                    <b>HN:</b> ${ap.hn}<br>
                    <b>‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${formattedDate} ${ap.time} ‡∏ô.<br>
                    <b>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™:</b> ${ap.course || '-'}<br>
                    <hr style="border:0.5px solid #eee;">
                    <center><small>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î 10 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞</small></center>
                </div>
                <script>window.print();window.close();<\/script>
            </body>
        </html>
    `);
    p.document.close();
};


// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ß‡∏≤ + ‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå Google + ‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏)
window.openAppointmentModal = function(editIndex = null) {
    const appointments = JSON.parse(localStorage.getItem('appointmentDB')) || [];
    const editData = editIndex !== null ? appointments[editIndex] : null;
    selectedCoursesForApp = editData ? editData.course.split(', ') : [];

    const modalWrap = document.createElement('div');
    modalWrap.id = "appModal";
    modalWrap.className = "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[9999] animate-in fade-in duration-300 font-normal";
    
    modalWrap.innerHTML = `
        <div class="bg-white w-full max-w-2xl rounded-[3rem] p-12 shadow-2xl border border-pink-200 animate-in zoom-in duration-300 overflow-y-auto max-h-[95vh] font-normal">
            <div class="flex justify-between items-center mb-10 font-normal">
                <h3 class="text-3xl font-black text-slate-800 uppercase tracking-tighter font-normal">${editData ? 'üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢' : '‚ú® ‡∏•‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'}</h3>
                <button onclick="closeAppModal()" class="text-slate-300 hover:text-pink-50 transition-all text-3xl font-light font-normal">‚úï</button>
            </div>
            <div class="space-y-5 text-left font-bold uppercase font-normal">
                <div class="relative font-normal">
                    <label class="text-[11px] text-[#FF4B91] ml-2 block font-normal">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / HN</label>
                    <input type="text" id="appCustSearch" value="${editData ? editData.customerName : ''}" oninput="searchCustomerForApp(this.value)" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç HN..." class="w-full border border-pink-200 p-4 rounded-2xl outline-none focus:border-[#FF4B91] text-sm bg-white font-normal">
                    <div id="appCustResults" class="absolute left-0 right-0 bg-white shadow-2xl rounded-2xl mt-1 hidden border border-pink-100 max-h-48 overflow-y-auto z-[10001] font-normal"></div>
                </div>
                <div class="grid grid-cols-2 gap-6 font-normal">
                    <div class="font-normal">
                        <label class="text-[11px] text-[#FF4B91] ml-2 block font-normal">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</label>
                        <input type="date" id="appDate" value="${editData ? editData.date : ''}" class="w-full border border-pink-200 p-4 rounded-2xl outline-none text-sm bg-white font-normal">
                    </div>

                    <div class="font-normal">
                        <label class="text-[11px] text-[#FF4B91] ml-2 block font-normal">‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î</label>
                        <div class="flex gap-1 font-normal">
                            <select id="appHour" class="w-1/2 border border-pink-200 p-4 rounded-2xl text-sm font-normal">
                                ${Array.from({length: 24}, (_, i) => `<option value="${String(i).padStart(2,'0')}" ${editData && editData.time.split(':')[0] == i ? 'selected' : ''}>${String(i).padStart(2,'0')}</option>`).join('')}
                            </select>
                            <select id="appMin" class="w-1/2 border border-pink-200 p-4 rounded-2xl text-sm font-normal">
                                <option value="00" ${editData && editData.time.split(':')[1] == '00' ? 'selected' : ''}>00</option>
                                <option value="10" ${editData && editData.time.split(':')[1] == '10' ? 'selected' : ''}>10</option>
                                <option value="20" ${editData && editData.time.split(':')[1] == '20' ? 'selected' : ''}>20</option>
                                <option value="30" ${editData && editData.time.split(':')[1] == '30' ? 'selected' : ''}>30</option>
                                <option value="40" ${editData && editData.time.split(':')[1] == '40' ? 'selected' : ''}>40</option>
                                <option value="50" ${editData && editData.time.split(':')[1] == '50' ? 'selected' : ''}>50</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-6 font-normal">
                    <div class="font-normal">
                        <label class="text-[11px] text-[#FF4B91] ml-2 block font-normal">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</label>
                        <select id="appDoc" class="w-full border border-pink-200 p-4 rounded-2xl text-sm font-normal bg-white font-normal">
                            <option value="‡∏´‡∏°‡∏≠‡πÅ‡∏Å‡πâ‡∏ß" ${editData && editData.doctor === '‡∏´‡∏°‡∏≠‡πÅ‡∏Å‡πâ‡∏ß' ? 'selected' : ''}>‡∏û‡∏ç.‡πÅ‡∏Å‡πâ‡∏ß</option>
                            <option value="‡∏´‡∏°‡∏≠‡∏õ‡∏•‡∏≤" ${editData && editData.doctor === '‡∏´‡∏°‡∏≠‡∏õ‡∏•‡∏≤' ? 'selected' : ''}>‡∏û‡∏ç.‡∏õ‡∏•‡∏≤</option>
                        </select>
                    </div>
                    <div class="font-normal">
                        <label class="text-[11px] text-[#FF4B91] ml-2 block font-normal">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</label>
                        <select id="appStatus" class="w-full border border-pink-200 p-4 rounded-2xl text-sm font-normal bg-white font-normal">
                            <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${editData && editData.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>üü° ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                            <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ${editData && editData.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>üü¢ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                            <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ${editData && editData.status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ? 'selected' : ''}>üî¥ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                            <option value="‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î" ${editData && editData.status === '‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î' ? 'selected' : ''}>üîµ ‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î</option>
                        </select>
                    </div>
                </div>
                <div class="font-normal">
                    <label class="text-[11px] text-[#FF4B91] ml-2 block font-normal">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≥</label>
                    <input type="text" id="appStaff" value="${editData ? editData.staff : ''}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" class="w-full border border-pink-200 p-4 rounded-2xl text-sm font-normal mb-2 bg-white font-normal">
                    <div class="relative font-normal">
    <label class="text-[11px] text-[#FF4B91] ml-2 block font-normal">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™</label>
    <input type="text" id="appCourse" onfocus="searchCourseForApp()" oninput="searchCourseForApp()" placeholder="‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏™..." class="w-full border border-pink-200 p-4 rounded-2xl outline-none text-sm bg-white font-normal">
    <div id="appCourseResults" class="absolute left-0 right-0 bg-white shadow-2xl rounded-2xl mt-1 hidden border border-pink-100 max-h-48 overflow-y-auto z-[10001] font-normal"></div>
    <div id="selectedCoursesContainer" class="mt-3 flex flex-wrap gap-2 pr-2 font-normal"></div>
</div>


<div class="font-normal">
    <label class="text-[11px] text-[#FF4B91] ml-2 block font-normal">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
    <textarea id="appNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." class="w-full border border-pink-200 p-4 rounded-2xl text-sm font-normal h-24 resize-none bg-white font-normal">${editData ? editData.note : ''}</textarea>
</div>
                </div>
                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl font-normal">
                    <span class="text-[10px] text-slate-500 font-bold font-normal tracking-wider">üóìÔ∏è ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô Google ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</span>
                    <label class="relative inline-flex items-center cursor-pointer font-normal">
                        <input type="checkbox" id="syncGoogle" class="sr-only peer font-normal">
                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-[#FF4B91] after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all font-normal"></div>
                    </label>
                </div>
                <div class="flex justify-end mt-4 font-normal font-normal">
                    <button onclick="saveNewAppointment(${editIndex})" class="bg-black text-white px-8 py-3 rounded-2xl font-black shadow-xl hover:scale-[1.02] transition-all text-[11px] font-normal uppercase tracking-widest font-normal">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modalWrap);
    if(!editData) {
        document.getElementById('appDate').valueAsDate = new Date();
    } else {
        renderSelectedCourses();
    }
};

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏•‡∏ö/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
window.changeAppPage = function(step) { currentAppPage += step; renderAppointmentPage(); };

window.printAppointmentTicket = function(index) {
    // ‡∏î‡∏∂‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    const db = JSON.parse(localStorage.getItem('appointmentDB')) || [];
    const ap = db[index];
    if(!ap) return;

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏ß-‡∏î-‡∏õ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå
    const d = ap.date.split("-");
    const formattedDate = `${d[2]}-${d[1]}-${d[0]}`;

    const p = window.open('', '_blank');
    p.document.write(`
        <html>
            <body style="font-family:Sarabun,sans-serif;text-align:center;padding:40px;">
                <div style="border:2px dashed #FF4B91;padding:30px;border-radius:30px;display:inline-block;text-align:left;width:300px;">
                    <h2 style="color:#FF4B91;text-align:center;">ACE CLINIC</h2>
                    <hr style="border:0.5px solid #eee;">
                    <b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${ap.customerName}<br>
                    <b>HN:</b> ${ap.hn}<br>
                    <b>‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${formattedDate} ${ap.time} ‡∏ô.<br>
                    <b>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™:</b> ${ap.course || '-'}<br>
                    <hr style="border:0.5px solid #eee;">
                    <center><small>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î 10 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞</small></center>
                </div>
                <script>window.print();window.close();<\/script>
            </body>
        </html>
    `);
    p.document.close();
};

window.searchCustomerForApp = function(val) {
    const resDiv = document.getElementById('appCustResults');
    if (!val) { resDiv.classList.add('hidden'); return; }
    const db = JSON.parse(localStorage.getItem('customerDB')) || [];
    const matches = db.filter(c => c.fullname.toLowerCase().includes(val.toLowerCase()) || c.hn.toLowerCase().includes(val.toLowerCase()));
    if (matches.length > 0) {
        resDiv.innerHTML = matches.map(c => `<div onclick="selectCustForApp('${c.fullname}', '${c.hn}')" class="p-4 hover:bg-pink-50 cursor-pointer border-b border-pink-50 flex justify-between font-normal"><span class="text-sm font-bold">${c.fullname}</span><span class="text-[10px] bg-slate-100 px-2 py-1 rounded-full uppercase font-bold">${c.hn}</span></div>`).join('');
        resDiv.classList.remove('hidden');
    } else { resDiv.classList.add('hidden'); }
};

window.selectCustForApp = function(name, hn) {
    const inp = document.getElementById('appCustSearch');
    inp.value = name; inp.dataset.hn = hn;
    document.getElementById('appCustResults').classList.add('hidden');
    selectedCoursesForApp = []; renderSelectedCourses();
};

window.searchCourseForApp = function() {
    const resDiv = document.getElementById('appCourseResults');
    const hn = document.getElementById('appCustSearch').dataset.hn;
    if (!hn) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞"); return; }
    const db = JSON.parse(localStorage.getItem('customerDB')) || [];
    const customer = db.find(c => c.hn === hn);
    const courses = customer ? customer.courses || [] : [];
    if (courses.length > 0) {
        resDiv.innerHTML = courses.map(c => {
            const total = c.totalAmount || 10;
            const currentRound = (total - c.amount) + 1;
            return `<div onclick="selectCourseForApp('${c.name}', ${currentRound}, ${total})" class="p-4 hover:bg-pink-50 cursor-pointer border-b border-pink-50 flex justify-between font-normal"><span class="text-sm font-bold">${c.name}</span><span class="text-[10px] text-pink-400 font-bold">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${currentRound}/${total}</span></div>`;
        }).join('');
        resDiv.classList.remove('hidden');
    } else { resDiv.innerHTML = `<div class="p-4 text-center text-slate-300 text-xs font-normal">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏™‡∏∞‡∏™‡∏°</div>`; resDiv.classList.remove('hidden'); }
};

window.selectCourseForApp = function(name, round, total) {
    const courseText = `${name} (${round}/${total})`;
    if (!selectedCoursesForApp.includes(courseText)) {
        selectedCoursesForApp.push(courseText); renderSelectedCourses();
    }
    document.getElementById('appCourseResults').classList.add('hidden');
    document.getElementById('appCourse').value = "";
};

window.renderSelectedCourses = function() {
    const container = document.getElementById('selectedCoursesContainer');
    if (container) {
        container.innerHTML = selectedCoursesForApp.map((c, i) => `<div class="bg-pink-50 text-[#FF4B91] border border-pink-200 px-3 py-1.5 rounded-xl text-[10px] font-bold flex items-center gap-2 font-normal animate-in slide-in-from-left"><span>‚ú® ${c}</span><button onclick="removeCourseFromApp(${i})" class="hover:text-red-500 font-normal">‚úï</button></div>`).join('');
    }
};

window.removeCourseFromApp = function(i) {
    selectedCoursesForApp.splice(i, 1); renderSelectedCourses();
};

window.saveNewAppointment = function(editIndex = null) {
    const hnInput = document.getElementById('appCustSearch');
    const name = hnInput.value;
    if (!name || selectedCoursesForApp.length === 0) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ñ‡πà‡∏∞"); return; }
    const newApp = {
        hn: hnInput.dataset.hn || "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", customerName: name, date: document.getElementById('appDate').value,
        time: document.getElementById('appHour').value + ":" + document.getElementById('appMin').value,
        doctor: document.getElementById('appDoc').value, staff: document.getElementById('appStaff').value || "-",
        course: selectedCoursesForApp.join(', '), status: document.getElementById('appStatus').value,
        note: document.getElementById('appNote').value, createdAt: new Date().getTime()
    };
    let db = JSON.parse(localStorage.getItem('appointmentDB')) || [];
    if (editIndex !== null && editIndex !== undefined && editIndex !== "") db[editIndex] = newApp; 
    else db.push(newApp);
    localStorage.setItem('appointmentDB', JSON.stringify(db));
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); closeAppModal(); renderAppointmentPage();
};

window.deleteAppointment = function(index) {
    if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        let db = JSON.parse(localStorage.getItem('appointmentDB')) || [];
        db.splice(index, 1); localStorage.setItem('appointmentDB', JSON.stringify(db));
        renderAppointmentPage();
    }
};

window.toggleAppActionMenu = function(event, index) {
    event.stopPropagation();
    const menuId = `app-action-menu-${index}`;
    document.querySelectorAll("[id^='app-action-menu-']").forEach(m => { if(m.id !== menuId) m.classList.add('hidden'); });
    const currentMenu = document.getElementById(menuId);
    if(currentMenu) currentMenu.classList.toggle('hidden');
};

window.editAppointment = function(index) { openAppointmentModal(index); };
window.closeAppModal = function() { const m = document.getElementById('appModal'); if (m) m.remove(); };
document.addEventListener('click', () => { document.querySelectorAll("[id^='app-action-menu-']").forEach(m => m.classList.add('hidden')); });

window.printDailyReport = function() {
    const appointments = JSON.parse(localStorage.getItem('appointmentDB')) || [];
    const dateFilter = document.getElementById('filterDate')?.value;
    
    if (!dateFilter) {
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞");
        return;
    }

    const dailyList = appointments.filter(ap => ap.date === dateFilter);
    if (dailyList.length === 0) { alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"); return; }
    
    dailyList.sort((a, b) => a.time.localeCompare(b.time));

    const p = window.open('', '_blank');
    p.document.write(`
        <html>
            <head>
                <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ - ACE Clinic</title>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
                    
                    @page {
                        size: A4 landscape;
                        margin: 0.5cm; /* üéØ ‡∏•‡∏î‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
                    }

                    body { 
                        font-family: 'Sarabun', sans-serif; 
                        padding: 20px; 
                        margin: 0; 
                        background: #f4f4f4; 
                        display: flex;
                        justify-content: center;
                    }

                    .no-print-btn { 
                        position: fixed; 
                        top: 20px; 
                        right: 20px; 
                        background: #D48197; 
                        color: white; 
                        border: none; 
                        padding: 12px 25px; 
                        border-radius: 30px; 
                        font-weight: bold; 
                        cursor: pointer; 
                        box-shadow: 0 4px 15px rgba(212,129,151,0.4); 
                        z-index: 1000; 
                    }

                    /* üéØ ‡∏õ‡∏£‡∏±‡∏ö container ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ã‡∏°. ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏à‡∏ô‡∏•‡πâ‡∏ô */
                    .report-container { 
                        background: white; 
                        padding: 25px; 
                        width: 95vw; /* ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏° 100% */
                        max-width: 1100px; 
                        min-height: 100%;
                        box-sizing: border-box;
                        border-radius: 15px;
                        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
                    }

                    .header { 
                        text-align: center; 
                        margin-bottom: 15px; 
                        border-bottom: 2px solid #D48197; 
                        padding-bottom: 10px; 
                    }

                    .header h1 { color: #D48197; margin: 0; font-size: 24px; }
                    .header p { margin: 5px 0 0; font-size: 13px; font-weight: bold; color: #555; }

                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        table-layout: fixed; /* üéØ ‡∏•‡πá‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô % ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏±‡∏ô‡∏à‡∏ô‡∏•‡πâ‡∏ô */
                    }

                    th { 
                        background: #FFF0F5; 
                        color: #D48197; 
                        padding: 10px 2px; 
                        font-size: 12px; 
                        border: 1px solid #eee; 
                    }

                    td { 
                        border: 1px solid #eee; 
                        padding: 6px 4px; 
                        font-size: 11px; 
                        word-wrap: break-word; 
                        vertical-align: top;
                        outline: none;
                        color: #444;
                    }

                    /* üéØ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏õ‡πá‡∏ô % ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
                    .col-num { width: 3%; }
                    .col-hn { width: 7%; }
                    .col-time { width: 5%; }
                    .col-phone { width: 10%; }
                    .col-name { width: 15%; }
                    .col-cell { width: 7%; }
                    .col-doc { width: 13%; }
                    .col-course { width: 30%; }
                    .col-sign { width: 10%; }

                    .signature-line {
                        border-bottom: 1px solid #ddd;
                        width: 90%;
                        display: inline-block;
                        height: 20px;
                        margin-top: 5px;
                    }

                    @media print {
    aside, header, .no-print, button, select { display: none !important; }
    #dynamicContent { position: absolute; left: 0; top: 0; width: 100%; }
    @page { size: A4 landscape; margin: 1cm; }
}
                </style>
            </head>
            <body>
                <button class="no-print-btn" onclick="window.print()">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô)</button>
                
                <div class="report-container">
                    <div class="header">
                        <h1>ACE CLINIC</h1>
                        <p>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateFilter.split('-').reverse().join('-')}</p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th class="col-num">#</th>
                                <th class="col-hn">HN</th>
                                <th class="col-time">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th class="col-phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                                <th class="col-name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="col-cell">‡πÄ‡∏ã‡∏•‡∏•‡πå</th>
                                <th class="col-doc">‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                                <th class="col-course">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™</th>
                                <th class="col-sign">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dailyList.map((ap, i) => {
                                const customers = JSON.parse(localStorage.getItem('customerDB')) || [];
                                const cInfo = customers.find(c => c.hn === ap.hn);
                                const seller = cInfo?.sellerName || "-";
                                const phone = cInfo?.phone || ap.phone || "-";
                                return `
                                <tr>
                                    <td align="center">${i + 1}</td>
                                    <td align="center" contenteditable="true"><b>${ap.hn || '-'}</b></td>
                                    <td align="center" contenteditable="true">${ap.time}</td>
                                    <td align="center" contenteditable="true">${phone}</td>
                                    <td contenteditable="true" style="padding-left: 5px;">${ap.customerName}</td>
                                    <td align="center" contenteditable="true" style="color:#D48197; font-weight:600;">${seller}</td>
                                    <td contenteditable="true" style="padding-left: 5px;">
                                        <b>‡∏û‡∏ç.${ap.doctor}</b><br>
                                        <small style="color:#999;">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${ap.staff || '-'}</small>
                                    </td>
                                    <td contenteditable="true" style="padding-left: 5px; font-size: 10px; line-height: 1.2;">${ap.course || '-'}</td>
                                    <td align="center"><div class="signature-line"></div></td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 15px; text-align: right; font-size: 9px; color: #aaa;">
                        ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}
                    </div>
                </div>
            </body>
        </html>
    `);
    p.document.close();
};
window.toggleConfirmApp = function(index) {
    let db = JSON.parse(localStorage.getItem('appointmentDB')) || [];
    if (db[index]) {
        // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏° (‡∏à‡∏£‡∏¥‡∏á/‡πÄ‡∏ó‡πá‡∏à)
        db[index].isConfirm = !db[index].isConfirm; 
        localStorage.setItem('appointmentDB', JSON.stringify(db));
        // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
        renderAppointmentPage(); 
    }
};

/* --- ‚ú® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å OPD ‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≠‡∏£‡πå‡∏°) --- */
window.saveTreatmentHistory = function(index) {
    const typeSelect = document.getElementById('opdTypeSelector');
    const selectedType = typeSelect ? typeSelect.value : 'general';
    let detailToSave = "";

    // 1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏â‡∏µ‡∏î‡∏ú‡∏¥‡∏ß" ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á 14 ‡∏ä‡πà‡∏≠‡∏á
    if (selectedType === 'skin_injection') {
        const tables = document.querySelectorAll('#opd-dynamic-layout table');
        let records = [];
        tables.forEach(table => {
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const courseText = row.cells[2].innerText.trim();
                if (courseText) {
                    records.push(`‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${row.cells[0].innerText}: ${courseText}`);
                }
            });
        });
        detailToSave = records.length > 0 ? "üíâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏â‡∏µ‡∏î‡∏ú‡∏¥‡∏ß:\n" + records.join("\n") : "";
    } 
    // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Botox ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≠‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    else {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const notes = document.getElementById('treatmentNotes');
        detailToSave = notes ? notes.value.trim() : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ (‡∏ß‡∏≤‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏á‡πÉ‡∏ô‡πÉ‡∏ö OPD)";
    }

    if (!detailToSave) {
        alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏∞");
        return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    const record = {
        date: new Date().toLocaleDateString('th-TH'),
        time: new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
        detail: detailToSave,
        fileName: `OPD_${selectedType.toUpperCase()}_${Date.now()}`
    };

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô Array treatments ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ
    if (!customerDB[index].treatments) customerDB[index].treatments = [];
    customerDB[index].treatments.push(record);

    // ‡πÄ‡∏ã‡∏ü‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (localStorage)
    localStorage.setItem('customerDB', JSON.stringify(customerDB));
    
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤ '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞!");
};
/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå --- */
window.prepareAndPrintOPD = function() {
    const notes = document.getElementById('treatmentNotes').value;
    document.getElementById('printableNotesDisplay').innerText = notes;
    window.print();
};
/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ --- */
window.deleteTreatmentRecord = function(customerIndex, recordIndex) {
    if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        customerDB[customerIndex].treatments.splice(recordIndex, 1);
        localStorage.setItem('customerDB', JSON.stringify(customerDB));
        // ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        switchProfileTab(4, customerIndex);
    }
};
/* --- ‚ú® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç HN ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (HN + ‡∏õ‡∏µ‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä + ‡∏£‡∏±‡∏ô‡∏ô‡∏¥‡πà‡∏á) --- */
function generateHN() {
    // ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
    let hnRunning = localStorage.getItem("hnRunning") ? parseInt(localStorage.getItem("hnRunning")) : 1;
    
    // ‡∏î‡∏∂‡∏á‡∏õ‡∏µ‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä 2 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡πâ‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 2569 -> 69)- */
    const thaiYear = (new Date().getFullYear() + 543).toString().slice(-2);
    
    // ‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ä‡πà‡∏ô 0001)- */
    const runningNumber = String(hnRunning).padStart(4, "0");

    // ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô HN690001- */
    const hn = "HN" + thaiYear + runningNumber;

    document.getElementById("modalHN").value = hn;
}

/* =======================================================
   üíé ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• + ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)
   ======================================================= */

let currentPhotoData = ""; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û Base64

// üì∏ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
window.handlePhotoUpload = function(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            currentPhotoData = e.target.result;
            const preview = document.getElementById("photoPreview");
            const placeholder = document.getElementById("uploadPlaceholder");
            if(preview) preview.src = currentPhotoData;
            if(preview) preview.classList.remove("hidden");
            if(placeholder) placeholder.classList.add("hidden");
        };
        reader.readAsDataURL(file);
    }
};

// ‚ú® 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà"
window.openModalForAdd = function() {
    editingIndex = null;
    currentPhotoData = ""; 
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î
    const fields = [
        "modalFirstName", "modalLastName", "modalNickname", 
        "modalBirthDate", "modalPhone", "modalEmail", 
        "modalLine", "modalAllergy", "modalSeller", "modalAddress"
    ];
    fields.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = "";
    });

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
    const preview = document.getElementById("photoPreview");
    const placeholder = document.getElementById("uploadPlaceholder");
    if(preview) preview.classList.add("hidden");
    if(placeholder) placeholder.classList.remove("hidden");

    // üéØ ‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç HN ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    generateHN(); 

    const modal = document.getElementById("customerModal");
    if(modal) {
        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }
};
// üìù 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + ‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå + ‡∏ï‡∏±‡∏ß‡∏ö‡∏≤‡∏á)
window.openModalForEdit = function(index) {
    editingIndex = index;
    const c = customerDB[index];

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ö‡∏≤‡∏á‡∏Ñ‡πà‡∏∞
    document.getElementById("modalTitle").innerText = "üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";
    document.getElementById("modalTitle").className = "text-2xl font-bold text-slate-800 uppercase tracking-tight"; 

    document.getElementById("modalHN").value = c.hn || "";
    
    // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ä‡πà‡∏≠‡∏á
    const nameParts = c.fullname ? c.fullname.split(' ') : ["", ""];
    document.getElementById("modalFirstName").value = nameParts[0] || "";
    document.getElementById("modalLastName").value = nameParts[1] || "";
    
    document.getElementById("modalNickname").value = c.nickname || "";
    document.getElementById("modalBirthDate").value = c.birthDate || "";
    document.getElementById("modalPhone").value = c.phone || "";
    document.getElementById("modalEmail").value = c.email || "";
    document.getElementById("modalLine").value = c.line || "";
    document.getElementById("modalAllergy").value = c.allergy || "";
    document.getElementById("modalAddress").value = c.address || "";
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå: ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å
    const sellerField = document.getElementById("modalSeller");
    if (sellerField) {
        sellerField.value = c.sellerName || "";
        
        // üîí ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
        if (c.sellerName && c.sellerName.trim() !== "") {
            sellerField.disabled = true;
            sellerField.classList.add("bg-slate-100", "text-slate-400"); // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏î‡∏π‡∏´‡∏£‡∏π
        } else {
            sellerField.disabled = false;
            sellerField.classList.remove("bg-slate-100", "text-slate-400");
        }
    }

    if(document.getElementById("modalBranch")) document.getElementById("modalBranch").value = c.branch || "‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ";
    if(document.getElementById("modalStatus")) document.getElementById("modalStatus").value = c.status || "‡∏õ‡∏Å‡∏ï‡∏¥";

    // üñºÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°
    const preview = document.getElementById("photoPreview");
    const placeholder = document.getElementById("uploadPlaceholder");
    if (c.photo) {
        currentPhotoData = c.photo;
        if(preview) {
            preview.src = c.photo;
            preview.classList.remove("hidden");
        }
        if(placeholder) placeholder.classList.add("hidden");
    } else {
        currentPhotoData = "";
        if(preview) preview.classList.add("hidden");
        if(placeholder) placeholder.classList.remove("hidden");
    }

    // ‡πÅ‡∏™‡∏î‡∏á Modal
    const modal = document.getElementById("customerModal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");

    // ‚ú® ‡πÅ‡∏ñ‡∏°: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á Input ‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô Modal ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ö‡∏≤‡∏á
    const allInputs = modal.querySelectorAll('input, textarea, select');
    allInputs.forEach(input => {
        input.classList.remove('font-bold', 'font-black');
        input.classList.add('font-light', 'text-slate-700'); 
    });
};

// ‚ú® 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç HN
function generateHN() {
    let rn = localStorage.getItem("hnRunning") ? parseInt(localStorage.getItem("hnRunning")) : 1;
    const thaiYear = (new Date().getFullYear() + 543).toString().slice(-2);
    const formattedNumber = String(rn).padStart(4, "0");
    const hn = "HN" + thaiYear + formattedNumber;
    const hnField = document.getElementById("modalHN");
    if(hnField) hnField.value = hn;
}

// ‚ú® 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
window.saveCustomer = function() {
    const fName = document.getElementById("modalFirstName").value.trim();
    const lName = document.getElementById("modalLastName").value.trim();
    const phone = document.getElementById("modalPhone").value.trim();

    if(!fName || !lName || !phone) {
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞");
        return;
    }

    const data = {
        hn: document.getElementById("modalHN").value,
        fullname: fName + " " + lName,
        nickname: document.getElementById("modalNickname").value,
        birthDate: document.getElementById("modalBirthDate").value,
        phone: phone,
        email: document.getElementById("modalEmail").value,
        line: document.getElementById("modalLine").value,
        allergy: document.getElementById("modalAllergy").value || '‡πÑ‡∏°‡πà‡∏°‡∏µ',
        address: document.getElementById("modalAddress").value,
        sellerName: document.getElementById("modalSeller").value,
        branch: document.getElementById("modalBranch").value,
        status: document.getElementById("modalStatus").value,
        photo: currentPhotoData, // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ
        createdAt: new Date().toLocaleDateString("th-TH")
    };

    if(editingIndex !== null) {
        customerDB[editingIndex] = {...customerDB[editingIndex], ...data};
    } else {
        customerDB.push(data);
        let currentRn = localStorage.getItem("hnRunning") ? parseInt(localStorage.getItem("hnRunning")) : 1;
        localStorage.setItem("hnRunning", currentRn + 1);
    }

    localStorage.setItem("customerDB", JSON.stringify(customerDB));
    renderCustomerTable(customerDB);
    closeModal();
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞!");
};

/* --- üíé ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ --- */
window.toggleAppActionMenu = function(event, index) {
    event.stopPropagation();
    const menuId = `app-action-menu-${index}`;
    
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    document.querySelectorAll("[id^='app-action-menu-']").forEach(m => {
        if(m.id !== menuId) m.classList.add('hidden');
    });
    
    // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î
    const currentMenu = document.getElementById(menuId);
    if(currentMenu) currentMenu.classList.toggle('hidden');
};

// ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
document.addEventListener('click', () => {
    document.querySelectorAll("[id^='app-action-menu-']").forEach(m => m.classList.add('hidden'));
});
/* =======================================================
    üñ±Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π "‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£" ‡∏Å‡∏≤‡∏á‡∏≠‡∏≠‡∏Å/‡∏û‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö
   ======================================================= */
window.toggleServiceSubmenu = function() {
    const submenu = document.getElementById('serviceSubmenu');
    const arrow = document.getElementById('serviceArrow');
    
    if (submenu.style.maxHeight === "0px" || submenu.style.maxHeight === "") {
        submenu.style.maxHeight = "300px"; 
        submenu.style.opacity = "1";
        submenu.style.marginTop = "5px";
        arrow.style.transform = "rotate(180deg)";
    } else {
        submenu.style.maxHeight = "0px";
        submenu.style.opacity = "0";
        submenu.style.marginTop = "0px";
        arrow.style.transform = "rotate(0deg)";
    }
};

/* =======================================================
    üíé 1. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡∏î‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏¥‡∏î‡∏ö‡∏ô)
   ======================================================= */
/* --- üìã 1. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏ñ‡∏ß) --- */
window.renderCourseMasterPage = function() {
    const target = document.getElementById('dynamicContent');
    target.innerHTML = `
        <div class="animate-in fade-in duration-500 p-4 -mt-6">
            <div class="flex justify-between items-center mb-4 bg-white p-6 rounded-[2rem] shadow-sm border border-pink-100">
                <div class="flex items-center gap-6">
                    <div>
                        <h2 class="text-xl font-black ace-pink italic leading-none text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</h2>
                        <p class="text-[9px] text-slate-400 font-bold uppercase mt-1 text-left">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏±‡∏á‡∏¢‡∏≤</p>
                    </div>
                    <div class="relative">
                        <input type="text" id="searchCourseInput" onkeyup="updateCourseMasterTable()" 
                            placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." 
                            class="w-64 bg-slate-50 border border-pink-100 rounded-xl px-4 py-2 text-[12px] font-light focus:outline-none focus:ring-2 focus:ring-pink-200 transition-all">
                    </div>
                </div>
                <button onclick="openAddCourseModal()" class="bg-black text-white px-8 py-3 rounded-2xl text-[12px] font-bold shadow-lg hover:bg-[#D48197] transition-all">
                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-2xl border border-pink-200 overflow-hidden">
                <table class="w-full text-center border-collapse table-fixed">
                    <thead class="bg-[#D48197] text-white font-normal uppercase italic text-[13px]">
                        <tr style="height: 60px;">
                            <th class="w-16">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th class="w-24">‡∏£‡∏´‡∏±‡∏™</th>
                            <th class="text-left pl-10">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™ / ‡∏¢‡∏≤</th>
                            <th class="w-32">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                            <th class="w-32 text-right pr-8">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th class="w-24 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th class="w-48 text-left pl-8">‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô/‡πÅ‡∏û‡∏ó‡∏¢‡πå)</th>
                            <th class="w-32 rounded-r-[2.5rem]">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="courseMasterTableBody" class="text-slate-500 font-light"></tbody>
                </table>
            </div>
        </div>`;
    updateCourseMasterTable();
};
/* =======================================================
    üîÑ 2. ‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏ß)
   ======================================================= */
window.renderQueuePage = function() {
    const target = document.getElementById('dynamicContent');
    if(!target) return;

    // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let allQueue = JSON.parse(localStorage.getItem('todayQueueDB')) || [];
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (23/02/2026)
    const todayStr = new Date().toLocaleDateString('th-TH');
    if (!window.currentQDateFilter) window.currentQDateFilter = todayStr;
    
    const statusFilter = document.getElementById('qStatusFilter')?.value || "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    const pageSize = parseInt(document.getElementById('qPageSize')?.value) || 10;
    const searchTerm = document.getElementById('qSearchInput')?.value.toLowerCase() || "";

    // üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let filteredData = allQueue.filter(q => {
        const qDate = q.date || todayStr;
        const matchDate = qDate === window.currentQDateFilter;
        const matchSearch = (q.name || "").toLowerCase().includes(searchTerm) || (q.hn || "").toLowerCase().includes(searchTerm);
        const matchStatus = statusFilter === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || q.status === statusFilter;
        return matchDate && matchSearch && matchStatus;
    });

    filteredData.sort((a, b) => (a.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ? 1 : -1));
    const paginatedData = filteredData.slice(0, pageSize);

    target.innerHTML = `
        <div class="animate-in fade-in duration-500 font-light p-4 -mt-6 text-left"> 
            
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-pink-100 mb-6 flex flex-col gap-4">
                
                <div class="flex justify-between items-center border-b border-pink-50 pb-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-xl font-bold ace-pink italic leading-none">‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>
                        <div class="h-4 w-[1px] bg-pink-200"></div>
                        <p class="text-[12px] text-slate-500 font-light">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="text-pink-500 font-bold">${window.currentQDateFilter}</span></p>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="loadPage(66, '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ DF')" class="bg-[#D48197] text-white px-5 py-2.5 rounded-2xl text-[10px] font-bold shadow-lg hover:bg-black transition-all uppercase tracking-wider">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠</button>
                         
                         <button onclick="notifyNextQueue()" class="bg-black text-white px-5 py-2.5 rounded-2xl text-[10px] font-bold shadow-lg hover:scale-105 transition-all uppercase flex items-center gap-2">
                            <span class="animate-bounce">üîî</span> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                         </button>
                    </div>
                </div>

                <div class="flex items-center gap-3 overflow-x-auto whitespace-nowrap pt-2">
                    <select id="qPageSize" onchange="renderQueuePage()" class="border border-pink-100 rounded-xl px-3 py-2 text-[12px] outline-none bg-slate-50 font-light cursor-pointer">
                        <option value="10" ${pageSize == 10 ? 'selected' : ''}>10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                        <option value="30" ${pageSize == 30 ? 'selected' : ''}>30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                    </select>

                    <select id="qStatusFilter" onchange="renderQueuePage()" class="border border-pink-100 rounded-xl px-3 py-2 text-[12px] outline-none bg-slate-50 font-light cursor-pointer">
                        <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ${statusFilter === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' ? 'selected' : ''}>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£" ${statusFilter === '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‚è≥ ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
                    </select>

                    <div class="relative flex items-center bg-slate-50 border border-pink-100 rounded-xl px-3 py-2 min-w-[160px]">
                        <input type="date" id="qDateInput" onchange="window.currentQDateFilter = new Date(this.value).toLocaleDateString('th-TH'); renderQueuePage();" class="bg-transparent outline-none text-[12px] font-light cursor-pointer w-full">
                    </div>

                    <div class="relative flex-1 min-w-[200px]">
                        <input type="text" id="qSearchInput" value="${searchTerm}" placeholder="‡∏Ñ‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ HN..." onkeyup="if(event.key==='Enter') renderQueuePage()" class="w-full border border-pink-100 bg-slate-50 rounded-xl px-10 py-2 text-[12px] outline-none font-light">
                        <span class="absolute left-4 top-2 text-slate-300">üîç</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-[3rem] shadow-2xl border border-pink-100 overflow-hidden p-8">
                <table class="w-full text-center text-[12px] border-separate border-spacing-y-0">
                    <thead>
                        <tr style="height: 55px;">
                            <th class="bg-[#D48197] text-white font-normal px-4 rounded-l-[1.5rem] w-24">‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th class="bg-[#D48197] text-white font-normal px-2 w-24">HN</th>
                            <th class="bg-[#D48197] text-white font-normal px-6 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</th>
                            <th class="bg-[#D48197] text-white font-normal px-6 text-left">‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£</th>
                            <th class="bg-[#D48197] text-white font-normal px-4 w-32">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="bg-[#D48197] text-white font-normal px-4 rounded-r-[1.5rem] w-40">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody class="text-slate-600 font-light">
    ${paginatedData.length > 0 ? paginatedData.map((q, i) => `
        <tr class="border-b border-pink-50 hover:bg-pink-50/10 transition-all ${q.isCalling ? 'animate-blink' : ''}" style="height: 75px;">
            <td class="p-2 text-slate-400 font-light italic">${q.time || '--:--'}</td>
            <td class="p-2 font-normal text-[#D48197]">${q.hn || '-'}</td>
            <td class="p-2 text-left font-normal text-slate-800 text-[14px]">
                ${q.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}
                ${q.acceptedBy ? `<br><span class="text-[9px] text-green-500 font-bold uppercase">‚úîÔ∏è ‡∏£‡∏±‡∏ö‡πÇ‡∏î‡∏¢: ${q.acceptedBy}</span>` : ''}
            </td>
            <td class="p-2 text-left text-[11px] leading-tight text-slate-500 font-light italic">${q.course || '-'}</td>
            <td class="p-2 text-center">
                <span class="px-4 py-1.5 rounded-full text-[9px] font-bold ${q.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'bg-green-50 text-green-500' : 'bg-yellow-50 text-yellow-600 animate-pulse'}">${q.status || '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£'}</span>
            </td>
            <td class="p-2 text-center">
                <div class="flex items-center justify-center gap-3">
                    ${q.status !== '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? `<button onclick="openProcessServiceModal('${q.queueId}')" class="bg-black text-white px-5 py-2 rounded-xl text-[10px] font-bold hover:bg-[#D48197] transition-all">‚ú® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>` : `<span class="text-slate-300 text-[10px] italic">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà ${q.finishTime || '-'}</span>`}
                    <button onclick="deleteQueueItem('${q.queueId}')" class="p-2 opacity-20 hover:opacity-100 transition-all"><img src="https://cdn-icons-png.flaticon.com/128/3096/3096673.png" class="w-5 h-5"></button>
                </div>
            </td>
        </tr>
    `).join('') : `<tr><td colspan="6" class="p-20 text-center italic text-slate-300 font-light">üö¶ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</td></tr>`}
</tbody>
                </table>
            </div>
        </div>`;
};


/* --- üîç ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏ö‡∏ö Real-time --- */
window.filterQueueTable = function() {
    const input = document.getElementById("searchQueueInput");
    const filter = input.value.toLowerCase();
    const rows = document.querySelectorAll(".queue-row");

    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        if (text.includes(filter)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
};
/* --- üîî ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏ß (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) --- */
window.notifyNextQueue = function() {
    let todayQueue = JSON.parse(localStorage.getItem('todayQueueDB')) || [];
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£"
    const nextInLine = todayQueue.find(q => q.status === "‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£");
    
    if (nextInLine) {
        // 1. üì± ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏±‡πà‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

        // 2. üì≤ ‡∏™‡πà‡∏á Push Notification ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
        if (Notification.permission === "granted") {
            const notification = new Notification("üîî ACE CLINIC: ‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà!", {
                body: `‡∏Ñ‡∏∏‡∏ì ${nextInLine.name} ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞\n‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${nextInLine.course}`,
                icon: 'https://cdn-icons-png.flaticon.com/128/3119/3119338.png',
                vibrate: [200, 100, 200]
            });
            notification.onclick = function() { window.focus(); this.close(); };
        }

        // 3. ‚ú® ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
        Swal.fire({
            title: '<span class="ace-pink font-bold italic text-2xl">üîî ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</span>',
            html: `
                <div class="p-6 text-center font-light">
                    <p class="text-2xl font-bold text-slate-700 mb-1">${nextInLine.name}</p>
                    <p class="text-[#D48197] italic text-base mb-4">${nextInLine.course}</p>
                    
                    <div class="bg-slate-50 rounded-[2rem] p-5 border border-slate-100 space-y-3">
                        <div class="flex justify-between items-center px-2">
                            <span class="text-[10px] text-slate-400 uppercase font-bold text-left">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ó‡∏≥:</span>
                            <span class="text-[13px] text-slate-700 font-normal text-right">${nextInLine.staff || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                        </div>
                        <div class="flex justify-between items-center px-2">
                            <span class="text-[10px] text-slate-400 uppercase font-bold text-left">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏ó‡∏≥:</span>
                            <span class="text-[13px] text-blue-600 font-normal text-right">${nextInLine.doctor || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                        </div>
                    </div>

                    <hr class="my-5 border-pink-50">
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest italic">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß</p>
                </div>
            `,
            confirmButtonText: '‚úÖ ‡∏â‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß',
            confirmButtonColor: '#000000',
            showCancelButton: true,
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            borderRadius: '2.5rem'
        }).then((result) => {
            if (result.isConfirmed) {
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏ü‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö
                nextInLine.status = "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß";
                nextInLine.isCalling = true; 
                localStorage.setItem('todayQueueDB', JSON.stringify(todayQueue));
                
                // ‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ
                Swal.fire({
                    toast: true, position: 'top-end', icon: 'success',
                    title: `‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏∏‡∏ì ${nextInLine.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 
                    showConfirmButton: false, timer: 2000
                });

                if (typeof renderQueuePage === "function") renderQueuePage();
            }
        });
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
        Swal.fire({
            text: '‚ú® ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞',
            icon: 'success',
            confirmButtonColor: '#D48197',
            borderRadius: '2rem'
        });
    }
};

/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß --- */
window.deleteQueueItem = function(qId) {
    if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏´‡∏≤‡∏Å‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏∞)")) {
        let db = JSON.parse(localStorage.getItem('todayQueueDB')) || [];
        const targetIdx = db.findIndex(item => item.queueId === qId);
        
        if (targetIdx !== -1) {
            const item = db[targetIdx];
            // üéØ ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™
            if (item.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô") {
                let customerDB = JSON.parse(localStorage.getItem('customerDB')) || [];
                const cIdx = customerDB.findIndex(c => c.hn === item.hn);
                if (cIdx !== -1) {
                    // ‡∏´‡∏≤‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏ß‡∏Å‡∏Å‡∏•‡∏±‡∏ö 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    const courseIdx = customerDB[cIdx].courses.findIndex(bc => bc.name === item.course);
                    if (courseIdx !== -1) {
                        customerDB[cIdx].courses[courseIdx].amount = (parseInt(customerDB[cIdx].courses[courseIdx].amount) + 1);
                        localStorage.setItem('customerDB', JSON.stringify(customerDB));
                    }
                }
            }
            // ‡∏•‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏Å
            db.splice(targetIdx, 1);
            localStorage.setItem('todayQueueDB', JSON.stringify(db));
            renderQueuePage();
        }
    }
};
/* =======================================================
    üì¶ 3. ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏≤‡∏â‡∏µ‡∏î (‡∏î‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏¥‡∏î‡∏ö‡∏ô)
   ======================================================= */
window.renderStockPage = function() {
    const target = document.getElementById('dynamicContent');
    if(!target) return;

    const today = "23/02/2026"; // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    target.innerHTML = `
        <div class="animate-in fade-in duration-500 font-light p-4 -mt-6 text-left"> 
            
            <div class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-pink-100 mb-6 flex items-center gap-3 overflow-x-auto whitespace-nowrap">
                <div class="min-w-[130px]">
                    <select id="stockPageSize" onchange="updateStockTable()" 
                        class="w-full border border-pink-100 rounded-2xl px-4 py-2.5 text-[12px] outline-none bg-slate-50 cursor-pointer font-light">
                        <option value="10">10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                        <option value="30">30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                        <option value="50">50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                    </select>
                </div>

                <div class="relative min-w-[160px]">
                    <input type="text" value="${today}" readonly
                        class="w-full border border-pink-100 rounded-2xl px-4 py-2 text-[12px] outline-none bg-slate-50 font-light text-center h-[42px]">
                </div>

                <div class="flex-1 flex gap-2 min-w-[300px]">
                    <div class="relative flex-1">
                        <input type="text" id="stockSearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ HN ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå..." 
                            onkeyup="if(event.key==='Enter') updateStockTable()"
                            class="w-full border border-pink-100 bg-slate-50 rounded-2xl px-10 py-2.5 text-[12px] outline-none font-light shadow-inner">
                        <span class="absolute left-4 top-3 text-slate-300">üîç</span>
                    </div>
                    <button onclick="updateStockTable()" 
                        class="bg-black text-white px-8 py-2 rounded-2xl text-[12px] font-bold shadow-lg hover:bg-[#D48197] transition-all h-[42px] flex-shrink-0">
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-[3rem] shadow-2xl border border-pink-100 overflow-hidden p-8">
                <div class="flex justify-between items-center mb-6 px-4">
                    <div>
                        <h2 class="text-xl font-bold ace-pink italic leading-none">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
                        <p class="text-[10px] text-slate-400 font-light italic mt-1">‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openDrugMasterSettings()" class="bg-white text-[#D48197] border border-[#D48197] px-5 py-2 rounded-xl text-[10px] font-bold hover:bg-pink-50 transition-all">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</button>
                        <button onclick="openLabelModal()" class="bg-slate-100 text-slate-500 px-5 py-2 rounded-xl text-[10px] font-bold">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤</button>
                        <button onclick="openAddStockModal()" class="bg-[#D48197] text-white px-6 py-2.5 rounded-2xl text-[10px] font-bold shadow-xl hover:bg-black transition-all uppercase tracking-wider">+ ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å</button>
                    </div>
                </div>

                <table class="w-full text-center text-[12px] border-separate border-spacing-y-0">
                    <thead>
                        <tr style="height: 55px;">
                            <th class="bg-[#D48197] text-white font-normal px-4 rounded-l-[1.5rem] w-16">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th class="bg-[#D48197] text-white font-normal px-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
                            <th class="bg-[#D48197] text-white font-normal px-6 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                            <th class="bg-[#D48197] text-white font-normal px-4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th class="bg-[#D48197] text-white font-normal px-4 italic">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
                            <th class="bg-[#D48197] text-white font-normal px-4">üö® ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                            <th class="bg-[#D48197] text-white font-normal px-4 rounded-r-[1.5rem] w-32">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody" class="text-slate-600 font-light">
                        </tbody>
                </table>
            </div>
        </div>`;
    
    updateStockTable();
};
/* =======================================================
    üõ†Ô∏è 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏™ (Modal)
   ======================================================= */
window.openAddCourseModal = function() {
    const modalWrap = document.createElement('div');
    modalWrap.id = "courseModal";
    modalWrap.className = "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] animate-in fade-in duration-300 font-normal";
    
    modalWrap.innerHTML = `
        <div class="bg-white w-full max-w-xl rounded-[3rem] p-10 shadow-2xl border border-pink-200 animate-in zoom-in duration-300">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold ace-pink uppercase font-normal">‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏™/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h3>
                <button onclick="closeCourseModal()" class="text-slate-300 hover:text-pink-500 transition-all text-2xl">‚úï</button>
            </div>
            
            <div class="space-y-4 text-left font-normal">
                <div>
                    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
                    <select id="newCourseCat" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm bg-white font-normal">
                        <option value="‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å">üíâ ‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å (Botox)</option>
                        <option value="‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå">üíâ ‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå (Filler)</option>
                        <option value="‡∏â‡∏µ‡∏î‡∏ú‡∏¥‡∏ß">‚ú® ‡∏â‡∏µ‡∏î‡∏ú‡∏¥‡∏ß/‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô</option>
                        <option value="‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå">üíÜ ‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå‡∏´‡∏ô‡πâ‡∏≤</option>
                        <option value="‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå">‚ö° ‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå (Laser)</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™ *</label>
                    <input type="text" id="newCourseName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Glitter 2 CC, Meso Fat..." class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm font-normal">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="newCoursePrice" placeholder="0.00" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm font-normal">
                    </div>
                    <div>
                        <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</label>
                        <input type="number" id="newCourseAmount" placeholder="10" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm font-normal">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">üí∞ ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (DF)</label>
                        <input type="number" id="newCourseDF" placeholder="0.00" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm font-normal">
                    </div>
                    <div>
                        <label class="text-[10px] text-blue-400 font-bold uppercase ml-2">üë®‚Äç‚öïÔ∏è ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå (Doctor DF)</label>
                        <input type="number" id="newCourseDoctorDF" placeholder="0.00" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm font-normal">
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-10 font-normal">
                <button onclick="closeCourseModal()" class="px-8 py-3 rounded-2xl text-[11px] font-bold bg-slate-100 text-slate-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveNewMasterCourse()" class="px-10 py-3 rounded-2xl text-[11px] font-bold bg-black text-white shadow-xl hover:bg-[#D48197] transition-all uppercase">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏™</button>
            </div>
        </div>
    `;
    document.body.appendChild(modalWrap);
};
/* =======================================================
    üíæ 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ß‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞)
   ======================================================= */
window.saveNewMasterCourse = function() {
    const name = document.getElementById('newCourseName').value.trim();
    const cat = document.getElementById('newCourseCat').value;
    const price = document.getElementById('newCoursePrice').value || 0;
    const amount = document.getElementById('newCourseAmount').value || 1;
    const staffDF = document.getElementById('newCourseDF').value || 0;
    const doctorDF = document.getElementById('newCourseDoctorDF').value || 0;

    if (!name) { 
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞"); 
        return; 
    }

    const newCourse = {
        id: "C-" + Math.floor(1000 + Math.random() * 9000), // ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏ß‡∏¢‡πÅ‡∏ö‡∏ö C-2473
        name: name,
        category: cat,
        price: parseFloat(price),
        amount: parseInt(amount),
        staffDF: parseFloat(staffDF),
        doctorDF: parseFloat(doctorDF),
        createdAt: new Date().toLocaleDateString('th-TH')
    };

    let masterDB = JSON.parse(localStorage.getItem('courseMasterDB')) || [];
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤"
    const saveBtn = document.querySelector('#courseModal button[onclick*="saveNewMasterCourse"]');
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏ index ‡πÑ‡∏ß‡πâ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥)
    masterDB.unshift(newCourse); 
    
    localStorage.setItem('courseMasterDB', JSON.stringify(masterDB));

    alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏™ "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞!`);
    closeCourseModal();
    
    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (typeof updateCourseMasterTable === "function") {
        updateCourseMasterTable(); 
    } else {
        renderCourseMasterPage();
    }
};
/* =======================================================
    üìä 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏≤
   ======================================================= */
window.updateStockTable = function() {
    // 1. ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (ID ‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
    const tbody = document.getElementById('stockTableBody');
    if (!tbody) return;

    // üéØ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥
    tbody.innerHTML = ''; 

    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
    const stockDB = JSON.parse(localStorage.getItem('clinicStockDB')) || [];
    const searchTerm = document.getElementById('stockSearchInput')?.value.toLowerCase() || "";
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    const filteredStock = stockDB.filter(s => (s.name || "").toLowerCase().includes(searchTerm));

    // 3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á (colspan="7")
    if (filteredStock.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="p-12 text-center italic text-slate-300 font-normal">üì¶ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</td></tr>`;
        return;
    }

    // 4. ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÑ‡∏õ
    tbody.innerHTML = filteredStock.map((s, idx) => {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 30 ‡∏ß‡∏±‡∏ô)
        const isExpiring = s.expDate && new Date(s.expDate) < new Date(new Date().setDate(new Date().getDate() + 30));
        
        return `
            <tr class="border-b border-pink-50 hover:bg-pink-50/20 transition-all font-normal text-slate-600" style="height: 75px;">
                <td class="p-2 text-center text-[10px] text-slate-400 font-normal">${idx + 1}</td>
                <td class="p-2 text-center text-slate-500 italic font-light">${s.receiveDate || s.date || '23/02/2026'}</td>
                <td class="p-4 text-left">
                    <div class="font-bold text-slate-700 text-[14px] leading-tight">${s.name}</div>
                    <div class="text-[9px] text-pink-400 italic mt-1 font-light uppercase">üì¶ ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏Å: ${s.unit || '‡∏ä‡∏¥‡πâ‡∏ô'}</div>
                </td>
                <td class="p-2 text-center font-black ace-pink text-base">
                    ${s.qty} <span class="text-[10px] font-normal text-slate-400">${s.unit || '‡∏´‡∏ô‡πà‡∏ß‡∏¢'}</span>
                </td>
                <td class="p-2 text-center text-slate-500 font-normal">
                    ‡∏ø${parseFloat(s.cost || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}
                </td>
                <td class="p-2 text-center">
                    <span class="px-3 py-1.5 rounded-full text-[10px] ${isExpiring ? 'bg-red-50 text-red-500 font-bold' : 'bg-slate-50 text-slate-400'}">
                        ${s.expDate || s.exp || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                    </span>
                </td>
                <td class="p-2 text-center">
                    <div class="flex items-center justify-center gap-3">
                        <button onclick="editStock(${idx})" class="text-[11px] text-slate-400 hover:text-pink-500 transition-all font-bold">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="deleteStockItem(${idx})" class="p-2 opacity-20 hover:opacity-100 transition-all">
                            <img src="https://cdn-icons-png.flaticon.com/128/3096/3096673.png" class="w-4 h-4">
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
};
/* =======================================================
    üõ†Ô∏è 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤ (Label Modal)
   ======================================================= */
window.openLabelModal = function() {
    const modalWrap = document.createElement('div');
    modalWrap.id = "labelModal";
    modalWrap.className = "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] animate-in fade-in duration-300 font-normal";
    
    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô Dropdown
    const customers = JSON.parse(localStorage.getItem('customerDB')) || [];
    const customerOptions = customers.map(c => `<option value="${c.fullname}">${c.fullname} (${c.hn})</option>`).join('');

    modalWrap.innerHTML = `
        <div class="bg-white w-full max-w-2xl rounded-[3rem] p-10 shadow-2xl border border-pink-200 animate-in zoom-in duration-300 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black ace-pink italic uppercase">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
                <button onclick="closeLabelModal()" class="text-slate-300 hover:text-pink-500 transition-all text-2xl">‚úï</button>
            </div>
            
            <div class="grid grid-cols-2 gap-6 text-left font-normal">
                <div class="col-span-2">
                    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                    <select id="lblCustName" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm bg-white font-normal">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ --</option>
                        ${customerOptions}
                    </select>
                </div>
                <div>
                   <div>
    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
    <input type="text" id="lblDrugName" 
        oninput="autoFillDrugInfo(this.value)" 
        list="drugSuggestions" 
        placeholder="‡πÄ‡∏ä‡πà‡∏ô Nabota 100u" 
        class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm">
        
    <datalist id="drugSuggestions">
        ${(JSON.parse(localStorage.getItem('drugMasterDB')) || []).map(d => `<option value="${d.name}">`).join('')}
    </datalist>
</div>                    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="lblDate" value="${new Date().toISOString().split('T')[0]}" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm">
                </div>
                <div class="col-span-2">
                    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</label>
                    <textarea id="lblUsage" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm h-20"></textarea>
                </div>
                <div class="col-span-2">
                    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏™‡∏£‡∏£‡∏û‡∏Ñ‡∏∏‡∏ì / ‡∏Ç‡πâ‡∏≠‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ</label>
                    <textarea id="lblDetail" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏£‡∏£‡∏û‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≤..." class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm h-20"></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-8">
                <button onclick="closeLabelModal()" class="px-8 py-3 rounded-2xl text-[10px] font-bold bg-slate-50 text-slate-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="previewAndPrintLabel()" class="px-10 py-3 rounded-2xl text-[10px] font-bold bg-black text-white shadow-xl hover:bg-[#D48197] transition-all uppercase">üëÅÔ∏è ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏¥‡πâ‡∏ô</button>
            </div>
        </div>
    `;
    document.body.appendChild(modalWrap);
};

/* =======================================================
    üñ®Ô∏è 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏õ‡∏£‡∏¥‡πâ‡∏ô (‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£ 9 x 5.5 cm)
   ======================================================= */
window.previewAndPrintLabel = function() {
    const data = {
        customer: document.getElementById('lblCustName').value,
        name: document.getElementById('lblDrugName').value,
        date: document.getElementById('lblDate').value.split('-').reverse().join('/'),
        usage: document.getElementById('lblUsage').value,
        detail: document.getElementById('lblDetail').value
    };

    if (!data.customer || !data.name) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞"); return; }

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>ACE Clinic Drug Label</title>
                <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Sarabun', sans-serif; display: flex; justify-content: center; padding-top: 20px; }
                    /* üéØ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô 9 x 5.5 cm */
                    .label-card { 
                        width: 9cm; height: 5.5cm; 
                        border: 2px solid #D48197; border-radius: 10px; 
                        padding: 15px; box-sizing: border-box; 
                        position: relative; overflow: hidden;
                    }
                    .logo { color: #D48197; font-weight: 800; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 8px; text-align: center; }
                    .info { font-size: 11px; line-height: 1.4; color: #333; }
                    .info b { color: #D48197; font-size: 9px; text-transform: uppercase; }
                    .footer { position: absolute; bottom: 8px; right: 15px; font-size: 8px; color: #aaa; }
                    @media print { .no-print { display: none; } body { padding: 0; } }
                </style>
            </head>
            <body>
                <div class="label-card">
                    <div class="logo">ACE CLINIC</div>
                    <div class="info">
                        <div style="margin-bottom: 5px;"><b>‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ:</b> ${data.customer}</div>
                        <div style="margin-bottom: 5px;"><b>‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤:</b> ${data.name} <span style="float:right;"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${data.date}</span></div>
                        <div style="border-top: 1px dashed #eee; padding-top: 5px;">
                            <b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</b> ${data.usage}<br>
                            <b>‡∏™‡∏£‡∏£‡∏û‡∏Ñ‡∏∏‡∏ì:</b> ${data.detail}
                        </div>
                    </div>
                    <div class="footer">Luxury Clinic Management System</div>
                </div>
                <div class="no-print" style="position:fixed; bottom:20px;">
                    <button onclick="window.print()" style="padding:10px 30px; background:#D48197; color:white; border:none; border-radius:20px; cursor:pointer;">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤</button>
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
};

window.closeLabelModal = function() { const m = document.getElementById('labelModal'); if (m) m.remove(); };

/* =======================================================
    ‚öôÔ∏è 1. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏ï‡∏£‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Master Data)
   ======================================================= */
window.openDrugMasterSettings = function() {
    const modalWrap = document.createElement('div');
    modalWrap.id = "drugMasterModal";
    modalWrap.className = "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10002] animate-in fade-in duration-300 font-normal";
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    const drugDB = JSON.parse(localStorage.getItem('drugMasterDB')) || [];
    const drugListHtml = drugDB.length > 0 ? drugDB.map((d, idx) => `
        <tr class="border-b border-pink-50 text-[10px]">
            <td class="p-2 font-bold text-slate-700">${d.name}</td>
            <td class="p-2 text-center">
                <button onclick="deleteDrugMaster(${idx})" class="text-red-400 hover:text-red-600 transition-all uppercase font-bold">[‡∏•‡∏ö]</button>
            </td>
        </tr>
    `).join('') : `<tr><td colspan="2" class="p-4 text-center text-slate-300 italic text-[10px]">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</td></tr>`;

    modalWrap.innerHTML = `
        <div class="bg-white w-full max-w-lg rounded-[3rem] p-10 shadow-2xl border border-pink-200 animate-in zoom-in duration-300 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black ace-pink italic uppercase">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</h3>
                <button onclick="this.closest('#drugMasterModal').remove()" class="text-slate-300 hover:text-red-500 transition-all text-2xl font-normal">‚úï</button>
            </div>

            <div class="space-y-4 text-left font-normal border-b border-pink-100 pb-6 mb-6">
                <div>
                    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ / ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</label>
                    <input type="text" id="mDrugName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Nabota 100u" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm font-normal">
                </div>
                <div>
                    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ (‡∏ß‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏¢‡∏≤)</label>
                    <textarea id="mDrugUsage" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ..." class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm h-16 font-normal"></textarea>
                </div>
                <div>
                    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏™‡∏£‡∏£‡∏û‡∏Ñ‡∏∏‡∏ì / ‡∏Ç‡πâ‡∏≠‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ</label>
                    <textarea id="mDrugDetail" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏£‡∏£‡∏û‡∏Ñ‡∏∏‡∏ì..." class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm h-16 font-normal"></textarea>
                </div>
                <button onclick="saveDrugMaster()" class="w-full py-3 rounded-2xl text-[11px] font-bold bg-black text-white shadow-xl hover:bg-[#D48197] transition-all uppercase">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</button>
            </div>

            <div class="text-left font-normal">
                <p class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-2 italic">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</p>
                <div class="bg-slate-50 rounded-2xl overflow-hidden border border-slate-100">
                    <table class="w-full">
                        <thead class="bg-slate-100 text-[9px] uppercase text-slate-500">
                            <tr><th class="p-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</th><th class="p-2 w-16">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                        </thead>
                        <tbody>${drugListHtml}</tbody>
                    </table>
                </div>
            </div>
        </div>`;
    document.body.appendChild(modalWrap);
};

/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ --- */
window.deleteDrugMaster = function(idx) {
    if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        let drugDB = JSON.parse(localStorage.getItem('drugMasterDB')) || [];
        drugDB.splice(idx, 1);
        localStorage.setItem('drugMasterDB', JSON.stringify(drugDB));
        
        // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞
        document.getElementById('drugMasterModal').remove();
        openDrugMasterSettings();
    }
};

/* =======================================================
    üì¶ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á: ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å (Modal)
   ======================================================= */
window.openAddStockModal = function() {
    const modalWrap = document.createElement('div');
    modalWrap.id = "stockModal";
    modalWrap.className = "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] animate-in fade-in duration-300 font-normal";
    
    const drugDB = JSON.parse(localStorage.getItem('drugMasterDB')) || [];
    const drugSuggestions = drugDB.map(d => `<option value="${d.name}">`).join('');

    modalWrap.innerHTML = `
        <div class="bg-white w-full max-w-lg rounded-[3rem] p-10 shadow-2xl border border-pink-200 animate-in zoom-in duration-300">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black ace-pink italic uppercase font-normal">üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</h3>
                <button onclick="closeStockModal()" class="text-slate-300 hover:text-pink-500 transition-all text-2xl font-normal">‚úï</button>
            </div>
            
            <div class="space-y-4 text-left font-normal">
                <div>
                    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <input type="date" id="stockDate" value="${new Date().toISOString().split('T')[0]}" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm font-normal">
                </div>
                
                <div>
                    <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå *</label>
                    <input type="text" id="stockItemName" list="stockSuggestions" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å Nabota..." class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm font-normal">
                    <datalist id="stockSuggestions">${drugSuggestions}</datalist>
                </div>

                <div class="grid grid-cols-3 gap-3"> <div>
                        <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö</label>
                        <input type="number" id="stockQty" placeholder="0" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm font-normal">
                    </div>
                    <div>
                        <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</label>
                        <input type="text" id="stockUnit" placeholder="‡∏Å‡∏•‡πà‡∏≠‡∏á/‡∏Ç‡∏ß‡∏î" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm font-normal">
                    </div>
                    <div>
                        <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</label>
                        <input type="number" id="stockCost" placeholder="0.00" class="w-full border border-pink-100 p-3 rounded-2xl outline-none text-sm font-normal">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] text-red-400 font-bold uppercase ml-2">üö® ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
                    <input type="date" id="stockExp" class="w-full border border-red-100 p-3 rounded-2xl outline-none text-sm font-normal text-red-500">
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-10">
                <button onclick="closeStockModal()" class="px-8 py-3 rounded-2xl text-[11px] font-bold bg-slate-100 text-slate-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveStockItem()" class="px-10 py-3 rounded-2xl text-[11px] font-bold bg-black text-white shadow-xl hover:bg-[#D48197] transition-all uppercase">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</button>
            </div>
        </div>`;
    document.body.appendChild(modalWrap);
};

/* =======================================================
    üíæ ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞ ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ï‡πä‡∏≠‡∏Å (‡∏ß‡∏≤‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)
   ======================================================= */
window.closeStockModal = function() {
    const modal = document.getElementById('stockModal');
    if (modal) {
        modal.remove(); 
    }
};


window.saveStockItem = function() {
    const name = document.getElementById('stockItemName').value.trim();
    const qty = document.getElementById('stockQty').value || 0;
    const unit = document.getElementById('stockUnit').value.trim() || '‡∏´‡∏ô‡πà‡∏ß‡∏¢'; 
    const cost = document.getElementById('stockCost').value || 0;
    const date = document.getElementById('stockDate').value;
    const exp = document.getElementById('stockExp').value;

    if (!name || qty <= 0) { 
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞"); 
        return; 
    }

    const newItem = {
        name: name,
        qty: qty,
        unit: unit, 
        cost: parseFloat(cost).toLocaleString(),
        date: date.split('-').reverse().join('/'),
        exp: exp ? exp.split('-').reverse().join('/') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
    };

    let stockDB = JSON.parse(localStorage.getItem('clinicStockDB')) || [];
    stockDB.unshift(newItem);
    localStorage.setItem('clinicStockDB', JSON.stringify(stockDB));

    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞!");
    
    // üéØ ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à
    closeStockModal(); 
    
    // üéØ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (typeof updateStockTable === "function") {
        updateStockTable();
    }
};

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
window.deleteStockItem = function(idx) {
    // 1. ‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    if (confirm("‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏∞?")) {
        
        // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LocalStorage ‡∏°‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
        let db = JSON.parse(localStorage.getItem('clinicStockDB')) || [];
        
        // 3. ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Array ‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (index) ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
        db.splice(idx, 1);
        
        // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        localStorage.setItem('clinicStockDB', JSON.stringify(db));
        
        // 5. üéØ ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß
        // ‡∏ã‡∏∂‡πà‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateStockTable ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÅ‡∏Å‡πâ‡∏Å‡∏±‡∏ô ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡∏°‡∏≠
        updateStockTable();
        
        console.log("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà " + idx + " ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
    }
};

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏¢‡∏≤
window.closeStockModal = function() {
    const m = document.getElementById('stockModal');
    if (m) m.remove();
};

/* =======================================================
    üöÄ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏Ñ‡∏¥‡∏ß‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Queue Management Logic)
   ======================================================= */
window.sendToServiceQueue = function(index) {
    // 1. ‡∏î‡∏∂‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    let appointments = JSON.parse(localStorage.getItem('appointmentDB')) || [];
    const appData = appointments[index];

    if (!appData) return;

    let todayQueue = JSON.parse(localStorage.getItem('todayQueueDB')) || [];

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥
    const isInQueue = todayQueue.find(q => q.hn === appData.hn && q.status !== "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
    if (isInQueue) {
        if (!confirm("‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏∞?")) return;
    }

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ "‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß"
    const newQueueItem = {
        queueId: "Q-" + Math.floor(1000 + Math.random() * 9000),
        hn: appData.hn,
        name: appData.customerName,
        course: appData.course,
        doctor: appData.doctor,
        staff: appData.staff,
        time: new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
        status: "‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£",
        appointmentRef: appData.createdAt
    };

    // üéØ 3. ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢" ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    appointments[index].status = "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
    localStorage.setItem('appointmentDB', JSON.stringify(appointments));

    // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏¥‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    todayQueue.push(newQueueItem);
    localStorage.setItem('todayQueueDB', JSON.stringify(todayQueue));

    // 5. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏£‡πå‡∏õ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ "‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß"
    alert(`‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏∏‡∏ì ${newQueueItem.name} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞`);
    loadPage(52, '‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß'); 
    
    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏≤‡∏£‡πå‡∏õ‡∏´‡∏ô‡πâ‡∏≤)
    if (typeof renderAppointmentPage === 'function') {
        renderAppointmentPage();
    }
};
/* =======================================================
    üíâ 1. ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö + ‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î)
   ======================================================= */
window.openProcessServiceModal = function(qId) {
    const todayQueue = JSON.parse(localStorage.getItem('todayQueueDB')) || [];
    
    // üéØ 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏à‡∏≤‡∏Å ID ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
    const q = todayQueue.find(item => item.queueId === qId);
    if(!q) return;

    // üí° 2. ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    q.isCalling = false; 
    localStorage.setItem('todayQueueDB', JSON.stringify(todayQueue));
    
    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (typeof renderQueuePage === "function") renderQueuePage();

    // üí∞ 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏£‡πå‡∏™
    const masterCourses = JSON.parse(localStorage.getItem('courseMasterDB')) || [];
    const courseDetail = masterCourses.find(c => c.name === q.course);
    
    const defaultStaffDF = courseDetail ? (courseDetail.staffDF || 0) : 0;
    const defaultDoctorDF = courseDetail ? (courseDetail.doctorDF || 0) : 0;

    // üì¶ 4. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏≤
    const stockDB = JSON.parse(localStorage.getItem('clinicStockDB')) || [];
    const stockOptions = stockDB.map(s => `
        <option value="${s.name}">${s.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${s.qty} ${s.unit})</option>
    `).join('');

    // üé® 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Modal (UI Luxury ‡∏ï‡∏≤‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå ACE Clinic)
    const modalWrap = document.createElement('div');
    modalWrap.id = "processModal";
    modalWrap.className = "fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[10005] font-light";
    
    modalWrap.innerHTML = `
        <div class="bg-white w-full max-w-5xl rounded-[3.5rem] overflow-hidden shadow-2xl flex flex-col md:flex-row min-h-[700px] animate-in zoom-in duration-300">
            <div class="w-full md:w-2/5 bg-pink-50 flex flex-col items-center justify-center p-10 border-r border-pink-100">
                <div class="w-52 h-52 bg-white rounded-[4rem] shadow-inner flex items-center justify-center border-4 border-white mb-6">
                    <span class="text-7xl">üíâ</span>
                </div>
                <h3 class="text-2xl font-bold text-slate-800 italic">${q.name}</h3>
                <div class="mt-8 bg-white/60 p-6 rounded-[2rem] w-full border border-white">
                    <p class="text-[10px] text-[#D48197] font-black uppercase text-center mb-2 italic tracking-widest">üìå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥ :</p>
                    <p class="text-sm font-normal text-slate-700 text-center leading-relaxed">${q.course}</p>
                </div>
            </div>

            <div class="flex-1 p-12 text-left relative overflow-y-auto" style="max-height: 90vh;">
                <button onclick="this.closest('#processModal').remove()" class="absolute top-8 right-10 text-slate-300 text-3xl hover:text-pink-400 transition-all">‚úï</button>
                <h4 class="text-xl font-bold ace-pink uppercase italic mb-8 underline decoration-pink-100 decoration-4 underline-offset-8">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠</h4>
                
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">üë©‚Äç‚öïÔ∏è ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ó‡∏≥</label>
                            <input type="text" id="procStaffName" value="${q.staff || ''}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" class="w-full border-2 border-pink-50 p-4 rounded-2xl outline-none text-sm font-light focus:border-pink-200 transition-all">
                        </div>
                        <div>
                            <label class="text-[10px] text-[#D48197] font-bold uppercase ml-2">üë®‚Äç‚öïÔ∏è ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏ó‡∏≥</label>
                            <input type="text" id="procDoctorName" value="${q.doctor || ''}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå" class="w-full border-2 border-pink-50 p-4 rounded-2xl outline-none text-sm font-light focus:border-pink-200 transition-all">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-slate-400 font-bold uppercase ml-2">üíµ ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (DF)</label>
                            <input type="number" id="staffDF" value="${defaultStaffDF}" class="w-full border-2 border-slate-50 p-4 rounded-2xl outline-none text-base font-normal text-slate-600">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-400 font-bold uppercase ml-2">üíµ ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå (DF)</label>
                            <input type="number" id="doctorDF" value="${defaultDoctorDF}" class="w-full border-2 border-slate-50 p-4 rounded-2xl outline-none text-base font-normal text-slate-600">
                        </div>
                    </div>

                    <div class="bg-slate-50 p-6 rounded-[2.5rem] border border-slate-100 shadow-inner">
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-4 ml-1 italic">üì¶ ‡∏´‡∏±‡∏Å‡∏•‡∏î‡∏¢‡∏≤/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏â‡∏µ‡∏î</p>
                        <div class="flex gap-2">
                            <select id="procStockItem" class="flex-1 border border-pink-100 p-3 rounded-xl outline-none text-[12px] bg-white font-light">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå --</option>
                                ${stockOptions}
                            </select>
                            <input type="number" id="procQty" placeholder="0" class="w-20 border border-pink-100 p-3 rounded-xl outline-none text-sm text-center font-bold">
                            <button type="button" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')" class="bg-black text-white px-6 rounded-xl text-[10px] font-bold uppercase hover:bg-[#D48197] transition-all">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 italic">üìî ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <textarea id="procNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£..." class="w-full border-2 border-pink-50 p-4 rounded-2xl outline-none text-sm h-24 font-light focus:border-pink-200 transition-all"></textarea>
                    </div>
                </div>

                <div class="flex justify-end mt-10">
                    <button type="button" onclick="finishService('${q.queueId}')" 
                        class="w-full py-5 rounded-3xl text-[12px] font-bold bg-[#D48197] text-white shadow-2xl hover:bg-black transition-all uppercase tracking-[0.2em]">
                        ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                    </button>
                </div>
            </div>
        </div>`;
    document.body.appendChild(modalWrap);
};
/* =======================================================
    ‚úÖ 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢ ID ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)
   ======================================================= */
window.finishService = function(qId) {
    let allQueue = JSON.parse(localStorage.getItem('todayQueueDB')) || [];
    const q = allQueue.find(item => item.queueId === qId);
    if(!q) return;

    // --- üìç ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏≤‡∏â‡∏µ‡∏î (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà) ---
    const usedItem = document.getElementById('procStockItem')?.value; 
    const usedQty = parseInt(document.getElementById('procQty')?.value) || 0;

    if (usedItem && usedQty > 0) {
        let stockDB = JSON.parse(localStorage.getItem('clinicStockDB')) || [];
        const itemIdx = stockDB.findIndex(s => s.name === usedItem);

        if (itemIdx !== -1) {
            // ‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á
            stockDB[itemIdx].qty = parseInt(stockDB[itemIdx].qty) - usedQty;
            localStorage.setItem('clinicStockDB', JSON.stringify(stockDB));
            console.log(`üì¶ ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å: ${usedItem} ‡∏≠‡∏≠‡∏Å ${usedQty} ‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        }
    }
    // -----------------------------------------------------------------------

    // --- üìç ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏£‡∏≠‡∏∏‡∏°‡∏≤ (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô) ---
    const staffDF = parseFloat(document.getElementById('staffDF').value) || 0;
    const doctorDF = parseFloat(document.getElementById('doctorDF').value) || 0;
    const procNote = document.getElementById('procNote').value;
    const procStaff = document.getElementById('procStaffName').value;
    const procDoctor = document.getElementById('procDoctorName').value;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß
    q.status = "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
    q.staff = procStaff;
    q.doctor = procDoctor;
    q.staffDF = staffDF;
    q.doctorDF = doctorDF;
    q.note = procNote;
    q.finishTime = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

    // ‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if (q.courseIndex !== undefined) {
        let customers = JSON.parse(localStorage.getItem('clinicCustomers')) || [];
        let cust = customers.find(c => c.hn === q.hn);
        if (cust && cust.courses[q.courseIndex]) {
            cust.courses[q.courseIndex].remains -= 1;
            localStorage.setItem('clinicCustomers', JSON.stringify(customers));
        }
    }

    localStorage.setItem('todayQueueDB', JSON.stringify(allQueue));
    
    // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    if (document.getElementById('processModal')) document.getElementById('processModal').remove();
    
    Swal.fire({
        icon: 'success',
        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
        text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞',
        timer: 2000,
        showConfirmButton: false
    });

    renderQueuePage();
};
/* =======================================================
    üí∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ (DF REPORT) - ‡∏â‡∏ö‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF + ‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô
   ======================================================= */
window.renderDFReportPage = function() {
    const target = document.getElementById('dynamicContent');
    const today = new Date().toISOString().split('T')[0];
    const todayQueue = JSON.parse(localStorage.getItem('todayQueueDB')) || [];
    const staffList = [...new Set(todayQueue.map(q => q.staff).filter(s => s))];
    const doctorList = [...new Set(todayQueue.map(q => q.doctor).filter(d => d))];

    target.innerHTML = `
        <div class="animate-in fade-in duration-500 font-normal p-4 -mt-6">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-pink-100 no-print mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-black ace-pink italic uppercase leading-none">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h2>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="bg-slate-800 text-white px-8 py-2 rounded-xl text-[11px] font-bold shadow-lg hover:bg-black transition-all uppercase flex items-center gap-2">
                            <span>üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="reportDate" value="${today}" onchange="updateDFTable()" class="w-full border border-pink-100 px-4 py-2 rounded-xl text-sm bg-slate-50 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Staff)</label>
                        <select id="filterStaff" onchange="handleFilterChange('staff')" class="w-full border border-pink-100 px-4 py-2 rounded-xl text-sm bg-slate-50 outline-none">
                            <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">-- ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô --</option>
                            ${staffList.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">‡πÅ‡∏û‡∏ó‡∏¢‡πå (Doctor)</label>
                        <select id="filterDoctor" onchange="handleFilterChange('doctor')" class="w-full border border-pink-100 px-4 py-2 rounded-xl text-sm bg-slate-50 outline-none">
                            <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">-- ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô --</option>
                            ${doctorList.map(d => `<option value="${d}">‡∏û‡∏ç.${d}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="text-[10px] font-bold text-[#D48197] uppercase ml-2">‡∏û‡∏¥‡πÄ‡∏®‡∏©/‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£(‡∏ø)</label>
                            <input type="number" id="extraPay" value="0" oninput="updateDFTable()" class="w-full border border-pink-100 px-4 py-2 rounded-xl text-sm bg-pink-50/50 outline-none ace-pink font-bold text-center">
                        </div>
                        <div class="w-24">
                            <label class="text-[10px] font-bold text-[#D48197] uppercase ml-2">‡∏Ñ‡∏≠‡∏° (%)</label>
                            <input type="number" id="comPercent" value="0" oninput="updateDFTable()" class="w-full border border-pink-100 px-4 py-2 rounded-xl text-sm bg-pink-50/50 outline-none ace-pink font-bold text-center" placeholder="%">
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-2xl border border-pink-100 p-8" id="printableArea">
                <div class="print:block hidden text-center mb-6">
                    <h1 class="text-2xl font-bold ace-pink uppercase">ACE CLINIC - ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠</h1>
                    <p id="printSubtitle" class="text-slate-500 font-bold mt-2"></p>
                    <p class="text-[10px] text-slate-400">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${today}</p>
                </div>
                <table class="w-full text-center text-[12px] border-separate border-spacing-y-0">
                    <thead><tr style="height: 55px;"></tr></thead>
                    <tbody id="dfTableBody" class="text-slate-600 font-normal"></tbody>
                    <tfoot id="dfTableFoot"></tfoot>
                </table>
            </div>
        </div>`;
    updateDFTable();
};

/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏≠‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå) --- */
window.updateDFTable = function() {
    const tbody = document.getElementById('dfTableBody');
    const tfoot = document.getElementById('dfTableFoot');
    const thead = document.querySelector('#printableArea thead tr');
    const selectedStaff = document.getElementById('filterStaff').value;
    const selectedDoctor = document.getElementById('filterDoctor').value;
    
    const extraPay = parseFloat(document.getElementById('extraPay')?.value || 0);
    const comPercent = parseFloat(document.getElementById('comPercent')?.value || 0);
    
    const todayQueue = JSON.parse(localStorage.getItem('todayQueueDB')) || [];
    const doneItems = todayQueue.filter(q => q.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
    
    const filteredItems = doneItems.filter(q => {
        const matchStaff = (selectedStaff === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") || (q.staff === selectedStaff);
        const matchDoctor = (selectedDoctor === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") || (q.doctor === selectedDoctor);
        return matchStaff && matchDoctor;
    });

    if (filteredItems.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="p-20 text-center italic text-slate-300">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏∞</td></tr>`;
        tfoot.innerHTML = "";
        return;
    }

    // 1. ‡∏à‡∏±‡∏î‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    let columns = [{ label: '‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ', class: 'px-4 rounded-l-[1.5rem]' }, { label: '‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£', class: 'px-4 text-left' }];
    if (selectedStaff !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || (selectedStaff === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" && selectedDoctor === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")) {
        columns.push({ label: '‡∏ú‡∏π‡πâ‡∏ó‡∏≥ (Staff)', class: 'px-4' }, { label: '‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', class: 'px-4' });
    }
    if (selectedDoctor !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || (selectedStaff === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" && selectedDoctor === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")) {
        columns.push({ label: '‡πÅ‡∏û‡∏ó‡∏¢‡πå', class: 'px-4' }, { label: '‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå', class: 'px-4' });
    }
    columns[columns.length - 1].class += ' rounded-r-[1.5rem]';
    thead.innerHTML = columns.map(col => `<th class="bg-[#D48197] text-white font-normal ${col.class}">${col.label}</th>`).join('');

    // 2. ‡∏ß‡∏≤‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LINE
    let totalS = 0, totalD = 0;
    let lineDetails = "";

    tbody.innerHTML = filteredItems.map(q => {
        const s = parseFloat(q.staffDF || 0);
        const d = parseFloat(q.doctorDF || 0);
        totalS += s; totalD += d;

        if (selectedStaff !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") {
            lineDetails += `‚Ä¢ ${q.name} (${q.course}): ‡∏ø${s.toLocaleString()}\n`;
        } else if (selectedDoctor !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") {
            lineDetails += `‚Ä¢ ${q.name} (${q.course}): ‡∏ø${d.toLocaleString()}\n`;
        }

        let rowHtml = `<td class="p-4 font-bold text-slate-700">${q.name}</td><td class="p-4 text-left text-slate-500 text-[11px]">${q.course}</td>`;
        if (selectedStaff !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || (selectedStaff === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" && selectedDoctor === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")) {
            rowHtml += `<td class="p-4">${q.staff || '-'}</td><td class="p-4 font-black ace-pink">‡∏ø${s.toLocaleString()}</td>`;
        }
        if (selectedDoctor !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || (selectedStaff === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" && selectedDoctor === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")) {
            rowHtml += `<td class="p-4">${q.doctor ? '‡∏û‡∏ç.' + q.doctor : '-'}</td><td class="p-4 font-black ace-pink">‡∏ø${d.toLocaleString()}</td>`;
        }
        return `<tr class="border-b border-pink-50 hover:bg-pink-50/20" style="height: 60px;">${rowHtml}</tr>`;
    }).join('');

    // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
    const comAmount = (totalS * comPercent) / 100;
    const finalTotal = (selectedStaff !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ? (totalS + extraPay + comAmount) : (totalD + extraPay));

   // --- üéØ 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° LINE ‡πÅ‡∏•‡∏∞ ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏≤‡∏¢) ---
    let sendLineBtn = "";
    let payDoctorBtn = ""; // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠‡∏Ñ‡πà‡∏∞
    
    if (selectedStaff !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || selectedDoctor !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") {
        const targetName = selectedStaff !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ? selectedStaff : "‡∏û‡∏ç." + selectedDoctor;
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå)
        if (selectedDoctor !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") {
            payDoctorBtn = `
                <div class="flex flex-col gap-1 ml-4 no-print border-l pl-4 border-pink-200">
                    <span class="text-[9px] text-slate-400 font-bold uppercase italic text-left">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span>
                    <div class="flex gap-1">
                        <button onclick="confirmDoctorPayment('${targetName}', ${finalTotal}, '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î')" class="bg-orange-500 text-white px-3 py-1.5 rounded-lg text-[9px] font-bold hover:bg-black transition-all">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
                        <button onclick="confirmDoctorPayment('${targetName}', ${finalTotal}, '‡πÇ‡∏≠‡∏ô (QR)')" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-[9px] font-bold hover:bg-black transition-all">üì± ‡πÇ‡∏≠‡∏ô (QR)</button>
                        <button onclick="confirmDoctorPayment('${targetName}', ${finalTotal}, '‡πÇ‡∏≠‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó')" class="bg-slate-700 text-white px-3 py-1.5 rounded-lg text-[9px] font-bold hover:bg-black transition-all">üè¢ ‡πÇ‡∏≠‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</button>
                    </div>
                </div>
            `;
        }

        let msgExtra = "";
        if (extraPay > 0) msgExtra += `‚ûï ‡∏û‡∏¥‡πÄ‡∏®‡∏©/‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£: ‡∏ø${extraPay.toLocaleString()}\n`;
        if (comPercent > 0) msgExtra += `‚ûï ‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô ${comPercent}%: ‡∏ø${comAmount.toLocaleString()}\n`;

        const message = `üì¢ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ ACE Clinic\n‡∏ñ‡∏∂‡∏á: ${targetName}\n-------------------------\n‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥:\n${lineDetails}${msgExtra}\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ‡∏ø${finalTotal.toLocaleString()}`;
        sendLineBtn = `<button onclick="window.open('https://social-plugins.line.me/lineit/share?text=${encodeURIComponent(message)}', 'line', 'width=500,height=600')" class="bg-[#06C755] text-white px-4 py-1.5 rounded-xl text-[9px] font-bold shadow-md hover:bg-black ml-4 no-print inline-flex items-center gap-1 transition-all">üü¢ LINE ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>`;
    }

    // --- üéØ 5. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á ---
    let footHtml = `<tr class="bg-slate-50 font-bold">
        <td colspan="2" class="p-4 text-right uppercase text-slate-400">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ :</td>
        <td colspan="4" class="p-4 text-lg ace-pink text-center font-black">
            <div class="flex items-center justify-center">
                <span class="text-2xl mr-2">‡∏ø${finalTotal.toLocaleString()}</span>
                ${sendLineBtn}
                ${payDoctorBtn}
            </div>
        </td>
    </tr>`;
    
    if (extraPay > 0 || comPercent > 0) {
        footHtml = `<tr class="text-[10px] text-slate-400 italic bg-slate-50/50">
            <td colspan="2" class="text-right p-1 font-bold">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°:</td>
            <td colspan="4" class="text-center p-1">
                ${extraPay > 0 ? `‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏ø${extraPay.toLocaleString()}` : ''} 
                ${comPercent > 0 ? ` | ‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô ${comPercent}% (‡∏ø${comAmount.toLocaleString()})` : ''}
            </td>
        </tr>` + footHtml;
    }
    tfoot.innerHTML = footHtml;
    
    let subtitle = "‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    if(selectedStaff !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") subtitle = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${selectedStaff}`;
    else if(selectedDoctor !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") subtitle = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå: ‡∏û‡∏ç.${selectedDoctor}`;
    document.getElementById('printSubtitle').innerText = subtitle;
};
window.openPaymentAccountSelector = function(name, amount) {
    if (amount <= 0) { alert("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 ‡∏ö‡∏≤‡∏ó‡∏Ñ‡πà‡∏∞"); return; }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    const modalHtml = `
        <div id="accountSelectorModal" class="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-[10006] animate-in fade-in duration-300">
            <div class="bg-white w-full max-w-md rounded-[3rem] p-10 shadow-2xl border border-pink-200 animate-in zoom-in duration-300 text-center font-normal">
                <h3 class="text-xl font-black ace-pink italic mb-2">üè¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô</h3>
                <p class="text-[11px] text-slate-400 uppercase font-bold mb-6">‡πÇ‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡πâ: ${name}<br>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ‡∏ø${amount.toLocaleString()}</p>
                
                <div class="space-y-3">
                    <button onclick="window.confirmDoctorPayment('${name}', ${amount}, 'üè¢ ‡πÇ‡∏≠‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó')" 
                        class="w-full bg-slate-50 border-2 border-slate-100 p-5 rounded-[2rem] hover:border-[#D48197] hover:bg-pink-50 transition-all flex items-center justify-between group">
                        <span class="text-2xl">üè¢</span>
                        <span class="font-bold text-slate-700 group-hover:text-[#D48197]">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</span>
                        <span class="text-[#D48197] opacity-0 group-hover:opacity-100">‚ùØ</span>
                    </button>

                    <button onclick="window.confirmDoctorPayment('${name}', ${amount}, 'üì± ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ K (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)')" 
                        class="w-full bg-slate-50 border-2 border-slate-100 p-5 rounded-[2rem] hover:border-green-500 hover:bg-green-50 transition-all flex items-center justify-between group">
                        <span class="text-2xl">üì±</span>
                        <span class="font-bold text-slate-700 group-hover:text-green-600">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ K (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</span>
                        <span class="text-green-600 opacity-0 group-hover:opacity-100">‚ùØ</span>
                    </button>
                </div>

                <button onclick="document.getElementById('accountSelectorModal').remove()" 
                    class="mt-8 text-slate-300 text-[10px] font-bold uppercase hover:text-red-500 transition-all">‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

/* --- üõ†Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤ + ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ + ‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á‡∏≠‡∏≠‡∏Å) --- */
window.confirmDoctorPayment = function(name, amount, accountName) {
    if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${amount.toLocaleString()} ‡∏à‡∏≤‡∏Å [${accountName}] ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        
        // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ accountDB ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏µ‡∏ö‡∏¥‡∏•‡∏Ñ‡πà‡∏∞)
        let accountDB = JSON.parse(localStorage.getItem('accountDB')) || [];
        
        accountDB.push({
            id: Date.now(),
            date: new Date().toISOString().split('T')[0], // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            time: new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }), // ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô 08:24)
            category: "‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå",
            detail: `‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ ${name}`,
            amount: parseFloat(amount),
            account: accountName,
            type: "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢",
            timestamp: new Date().getTime()
        });
        
        localStorage.setItem('accountDB', JSON.stringify(accountDB));

        // 2. ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà)
        const selectorModal = document.getElementById('accountSelectorModal');
        if (selectorModal) selectorModal.remove();
        
        alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);

        // 3. ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ "‡∏ï‡∏µ‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        loadPage(9, '‡∏ï‡∏µ‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (OUTGOING)'); 
        
        // 4. üéØ ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ß‡∏•‡∏≤
        setTimeout(() => {
            if (typeof updateExpenseTableDisplay === 'function') {
                updateExpenseTableDisplay(); 
            }
        }, 150);
    }
};
/* --- üëÅÔ∏è 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô "‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à" (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô: ‡∏ä‡∏∑‡πà‡∏≠, ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£+‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á) --- */
window.viewBillOnly = function(billId) {
    const allBills = JSON.parse(localStorage.getItem('accountDB')) || [];
    const bill = allBills.find(b => b.id == billId);
    
    if (bill) {
     
        const itemList = (bill.items || []).map(i => 
            `‚Ä¢ ${i.name} (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${i.qty || 1} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á) -> ‡∏ø${parseFloat(i.total || 0).toLocaleString()}`
        ).join('\n');

        alert(
            `üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à [‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${bill.status}]\n` +
            `----------------------------------\n` +
            `üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ: ${bill.customer || bill.customerName}\n` +
            `üí≥ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô: ${bill.payment}\n` +
            `üí∞ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${bill.total}\n` +
            `----------------------------------\n` +
            `üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠:\n${itemList}`
        );
    } else {
        alert("‚ö†Ô∏è ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
    }
};
/* --- üñ®Ô∏è 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à" (‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°) --- */
window.openOldReceiptById = function(billId) {
    const allBills = JSON.parse(localStorage.getItem('accountDB')) || [];
    const bill = allBills.find(b => b.id == billId);
    if (bill) {
        window.currentBillItems = bill.items || [];
        showReceiptPreview(bill);
        
        // üéØ ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏¥‡∏• (renderSalesPage)
        setTimeout(() => {
            const backBtn = document.querySelector('button[onclick*="Profile"], button[onclick*="Sales"]');
            if (backBtn) {
                backBtn.setAttribute('onclick', 'renderSalesPage()');
                backBtn.innerText = 'üîô ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏¥‡∏•';
            }
        }, 150);
    } else {
        alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏∞");
    }
};
/* --- üìÑ 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö --- */
window.printFullTaxInvoice = function(billId, hn) {
    try {
        const allBills = JSON.parse(localStorage.getItem('accountDB')) || [];
        const bill = allBills.find(b => b.id == billId);
        const customer = customerDB.find(c => c.hn === hn);
        if (!bill || !customer) { alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏∞"); return; }
        
        const printWindow = window.open('', '_blank');
        const totalAmt = parseFloat(String(bill.total || "0").replace(/[^0-9.-]+/g,"")) || 0;
        const vat = totalAmt * 7 / 107;
        const beforeVat = totalAmt - vat;

        printWindow.document.write(`
            <html><head><title>Tax Invoice</title><link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
            <style>body{font-family:'Sarabun',sans-serif;padding:40px;}.h{display:flex;justify-content:space-between;border-bottom:2px solid #D48197;padding-bottom:10px;margin-bottom:20px;}
            table{width:100%;border-collapse:collapse;}th{background:#FDF2F4;padding:10px;border:1px solid #eee;color:#D48197;}td{padding:10px;border:1px solid #eee;}
            .t{float:right;width:250px;margin-top:20px;}.r{display:flex;justify-content:space-between;padding:5px 0;}@media print{.no-p{display:none;}}</style></head>
            <body><div class="h"><div><h2 style="color:#D48197;margin:0;">ACE CLINIC</h2><p>‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: 11101005166</p></div><div style="text-align:right;"><h3>‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</h3><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${bill.date}</p></div></div>
            <p><b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${customer.fullname} (HN: ${customer.hn})<br><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${customer.address || '-'}</p>
            <table><thead><tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead><tbody>
            ${(bill.items || []).map((item, i) => `<tr><td align="center">${i+1}</td><td>${item.name}</td><td align="right">‡∏ø${parseFloat(item.total).toLocaleString()}</td></tr>`).join('')}
            </tbody></table><div class="t"><div class="r"><span>‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ:</span><span>‡∏ø${beforeVat.toLocaleString(undefined,{minimumFractionDigits:2})}</span></div>
            <div class="r"><span>‡∏†‡∏≤‡∏©‡∏µ 7%:</span><span>‡∏ø${vat.toLocaleString(undefined,{minimumFractionDigits:2})}</span></div>
            <div class="r" style="font-weight:bold;color:#D48197;border-top:1px solid #eee;margin-top:5px;"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span><span>‡∏ø${totalAmt.toLocaleString(undefined,{minimumFractionDigits:2})}</span></div></div>
            <div class="no-p" style="margin-top:100px;text-align:center;"><button onclick="window.print()" style="padding:10px 30px;background:#D48197;color:white;border:none;border-radius:20px;cursor:pointer;">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</button></div></body></html>
        `);
        printWindow.document.close();
    } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏Ñ‡πà‡∏∞"); }
};

/* --- ‚ùå 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏• (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏ß‡πâ‡∏î‡∏π) --- */
window.cancelBillProcess = function(billId, hn) {
    if (confirm("üö® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏∞)")) {
        try {
            let accountDB = JSON.parse(localStorage.getItem('accountDB')) || [];
            const billIdx = accountDB.findIndex(b => b.id == billId);
            
            if (billIdx !== -1) {
                // ‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≥
                if (accountDB[billIdx].status === "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å") {
                    alert("‚ö†Ô∏è ‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
                    return;
                }

                // 1. üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö)
                accountDB[billIdx].status = "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
                
                // 2. üíé ‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ö‡∏ß‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏≠‡∏≠‡∏Å)
                let customers = JSON.parse(localStorage.getItem('customerDB')) || [];
                const cIdx = customers.findIndex(c => c.hn === hn);
                if (cIdx !== -1 && accountDB[billIdx].items) {
                    accountDB[billIdx].items.forEach(billItem => {
                        const cCourseIdx = customers[cIdx].courses.findIndex(bc => bc.name === billItem.name);
                        if (cCourseIdx !== -1) {
                            // ‡∏´‡∏±‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                            customers[cIdx].courses[cCourseIdx].amount -= (billItem.qty || 1);
                            // ‡∏ñ‡πâ‡∏≤‡∏´‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏≠‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏´‡∏°‡∏î‡∏û‡∏≠‡∏î‡∏µ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ
                            if (customers[cIdx].courses[cCourseIdx].amount <= 0) {
                                customers[cIdx].courses.splice(cCourseIdx, 1);
                            }
                        }
                    });
                    localStorage.setItem('customerDB', JSON.stringify(customers));
                }

                // 3. üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                localStorage.setItem('accountDB', JSON.stringify(accountDB));
                
                alert("‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ‡∏Ñ‡πà‡∏∞)");
                
                // 4. üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                renderSalesPage(); 
            }
        } catch (e) { 
            console.error(e); 
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏Ñ‡πà‡∏∞"); 
        }
    }
};

/* --- ‚úÖ 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á --- */
window.safeToggleMenu = function(event, index) {
    event.stopPropagation();
    document.querySelectorAll('tr').forEach(tr => tr.style.zIndex = 'auto');
    const targetMenu = document.getElementById(`action-menu-${index}`);
    if (!targetMenu) return;
    const isHidden = targetMenu.classList.contains('hidden');
    document.querySelectorAll('[id^="action-menu-"]').forEach(menu => menu.classList.add('hidden'));
    if (isHidden) {
        targetMenu.classList.remove('hidden');
        const parentRow = targetMenu.closest('tr');
        if (parentRow) {
            parentRow.style.position = 'relative';
            parentRow.style.zIndex = '9999';
        }
    }
};

// ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
document.addEventListener('click', function() {
    document.querySelectorAll('[id^="action-menu-"]').forEach(menu => menu.classList.add('hidden'));
    document.querySelectorAll('tr').forEach(tr => tr.style.zIndex = 'auto');
});
/* --- üìä 2. ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô + ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤) --- */
window.updateCourseMasterTable = function() {
    const tbody = document.getElementById('courseMasterTableBody');
    const searchTerm = document.getElementById('searchCourseInput')?.value.toLowerCase() || "";
    if (!tbody) return;

    tbody.innerHTML = ''; 
    let masterDB = JSON.parse(localStorage.getItem('courseMasterDB')) || [];
    
    // üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    const filteredData = masterDB.filter(c => 
        c.name.toLowerCase().includes(searchTerm) || 
        (c.category && c.category.toLowerCase().includes(searchTerm)) ||
        (c.id && c.id.toLowerCase().includes(searchTerm))
    );

    if (filteredData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="p-20 text-center italic text-slate-300 font-light">üö¶ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</td></tr>`;
        return;
    }

    tbody.innerHTML = filteredData.map((c, idx) => `
        <tr class="border-b border-pink-50 hover:bg-pink-50/20 transition-all text-[14px]" style="height: 70px;">
            <td class="text-slate-400 font-light w-16">${idx + 1}</td>
            <td class="text-pink-400 font-light w-24">${c.id}</td>
            
            <td class="text-left pl-10 font-light text-slate-700 truncate max-w-xs whitespace-nowrap">
                ${c.name}
            </td>

            <td class="text-center w-32 whitespace-nowrap">
                <span class="bg-pink-50 text-[#D48197] px-3 py-1 rounded-full text-[10px] font-bold border border-pink-100 uppercase italic">
                    ${c.category || '‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå'}
                </span>
            </td>

            <td class="text-right pr-8 font-light text-slate-800 w-32 whitespace-nowrap">
                ‡∏ø${parseFloat(c.price || 0).toLocaleString()}
            </td>

            <td class="text-center w-24 font-light text-slate-600 whitespace-nowrap">
                ${c.amount} <span class="text-[9px] text-slate-300">‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ä‡∏¥‡πâ‡∏ô</span>
            </td>
            
            <td class="text-[11px] text-left pl-8 font-light whitespace-nowrap leading-tight">
                <div class="text-slate-400">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span class="text-slate-700 font-normal">‡∏ø${parseFloat(c.staffDF || 0).toLocaleString()}</span></div>
                <div class="text-blue-300">‡πÅ‡∏û‡∏ó‡∏¢‡πå: <span class="text-blue-600 font-normal">‡∏ø${parseFloat(c.doctorDF || 0).toLocaleString()}</span></div>
            </td>
            
            <td class="text-center w-32">
                <div class="flex items-center justify-center gap-3">
                    <button onclick="editMasterCourse(${idx})" class="text-[11px] text-slate-400 hover:text-pink-500 font-light transition-all border-b border-transparent hover:border-pink-300">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button onclick="deleteMasterCourse(${idx})" class="p-1 opacity-20 hover:opacity-100 transition-all hover:scale-110">
                        <img src="https://cdn-icons-png.flaticon.com/128/3096/3096673.png" class="w-5 h-5">
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
};

/* --- üìù 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÄ‡∏î‡∏¥‡∏° --- */
window.editMasterCourse = function(idx) {
    const masterDB = JSON.parse(localStorage.getItem('courseMasterDB')) || [];
    const c = masterDB[idx];
    
    // 1. ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏™
    openAddCourseModal();
    
    // 2. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°
    document.querySelector('#courseModal h3').innerText = "üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™";
    const saveBtn = document.querySelector('#courseModal button[onclick="saveNewMasterCourse()"]');
    saveBtn.innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    
    // 3. üéØ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
    document.getElementById('newCourseName').value = c.name;
    document.getElementById('newCourseCat').value = c.category;
    document.getElementById('newCoursePrice').value = String(c.price).replace(/,/g, '');
    document.getElementById('newCourseAmount').value = c.amount;
    document.getElementById('newCourseDF').value = String(c.staffDF).replace(/,/g, '');
    document.getElementById('newCourseDoctorDF').value = String(c.doctorDF).replace(/,/g, '');

    // 4. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÑ‡∏õ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ "‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà" ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≥
    saveBtn.onclick = function() {
        masterDB.splice(idx, 1); // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏Å‡πà‡∏≤
        localStorage.setItem('courseMasterDB', JSON.stringify(masterDB));
        saveNewMasterCourse(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß
    };
};

/* --- üì± ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡πÅ‡∏°‡πâ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö) --- */

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
window.requestNotificationPermission = function() {
    if (!("Notification" in window)) return;
    Notification.requestPermission();
};
/* =======================================================
    üìù ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å (editStock)
   ======================================================= */
window.editStock = function(idx) {
    let stockDB = JSON.parse(localStorage.getItem('clinicStockDB')) || [];
    const item = stockDB[idx];
    if (!item) return;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const editModal = document.createElement('div');
    editModal.id = "editStockModal";
    editModal.className = "fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[10006] font-light";
    
    editModal.innerHTML = `
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] overflow-hidden shadow-2xl animate-in zoom-in duration-300">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold ace-pink italic">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</h3>
                    <button onclick="this.closest('#editStockModal').remove()" class="text-slate-300 hover:text-pink-500 text-2xl">‚úï</button>
                </div>

                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <input type="date" id="editDate" value="${item.receiveDate || item.date || ''}" 
                            class="w-full border border-pink-100 p-3 rounded-xl outline-none text-sm font-light bg-slate-50">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
                        <input type="text" id="editName" value="${item.name}" 
                            class="w-full border border-pink-100 p-3 rounded-xl outline-none text-sm font-light bg-slate-50">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-slate-400 font-bold uppercase ml-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label>
                            <input type="number" id="editQty" value="${item.qty}" 
                                class="w-full border border-pink-100 p-3 rounded-xl outline-none text-sm font-bold text-center bg-slate-50">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-400 font-bold uppercase ml-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</label>
                            <input type="text" id="editUnit" value="${item.unit || ''}" 
                                class="w-full border border-pink-100 p-3 rounded-xl outline-none text-sm font-light bg-slate-50">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-slate-400 font-bold uppercase ml-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ø)</label>
                            <input type="number" id="editCost" value="${item.cost || 0}" 
                                class="w-full border border-pink-100 p-3 rounded-xl outline-none text-sm font-light bg-slate-50">
                        </div>
                        <div>
                            <label class="text-[10px] text-red-400 font-bold uppercase ml-2">üö® ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
                            <input type="date" id="editExp" value="${item.expDate || item.exp || ''}" 
                                class="w-full border border-red-100 p-3 rounded-xl outline-none text-sm font-light bg-red-50/30">
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex gap-3">
                    <button onclick="this.closest('#editStockModal').remove()" 
                        class="flex-1 py-3 rounded-xl text-[12px] font-bold bg-slate-100 text-slate-400 uppercase tracking-widest">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="saveEditStock(${idx})" 
                        class="flex-1 py-3 rounded-xl text-[12px] font-bold bg-black text-white shadow-lg hover:bg-[#D48197] transition-all uppercase tracking-widest">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
                </div>
            </div>
        </div>`;
    document.body.appendChild(editModal);
};

/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç --- */
window.saveEditStock = function(idx) {
    let stockDB = JSON.parse(localStorage.getItem('clinicStockDB')) || [];
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÉ‡∏ô Array
    stockDB[idx] = {
        ...stockDB[idx],
        receiveDate: document.getElementById('editDate').value,
        name: document.getElementById('editName').value,
        qty: parseInt(document.getElementById('editQty').value) || 0,
        unit: document.getElementById('editUnit').value,
        cost: parseFloat(document.getElementById('editCost').value) || 0,
        expDate: document.getElementById('editExp').value
    };

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LocalStorage ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
    localStorage.setItem('clinicStockDB', JSON.stringify(stockDB));
    document.getElementById('editStockModal').remove();
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    Swal.fire({
        toast: true, position: 'top-end', icon: 'success',
        title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞', showConfirmButton: false, timer: 2000
    });
    
    updateStockTable();
};


// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß
setTimeout(window.requestNotificationPermission, 2000);
/* =======================================================
    üìà 1. ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)
   ======================================================= */
window.renderReportPage = function() {
    const target = document.getElementById('dynamicContent');
    if(!target) return;

    target.innerHTML = `
        <div class="animate-in fade-in duration-500 font-light p-4 -mt-6 text-left pb-20">
            <div class="flex justify-between items-center mb-10 bg-white p-8 rounded-[3rem] shadow-sm border border-pink-100">
                <div>
                    <h2 class="text-2xl font-bold ace-pink italic leading-none text-left">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (ACE Reports)</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mt-2 italic tracking-widest text-left">Online Real-time System</p>
                </div>
                <div class="bg-pink-50 px-6 py-3 rounded-2xl border border-pink-100 text-center">
                    <p class="text-[9px] text-[#D48197] font-bold uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</p>
                    <p class="text-sm font-black text-slate-700 uppercase tracking-tighter italic">Status: Connected</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                
                <div class="space-y-4">
                    <div class="flex items-center gap-3 mb-4 ml-4"><span class="text-2xl">üì¶</span><h3 class="text-sm font-bold text-slate-500 uppercase italic">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</h3></div>
                    <div class="flex flex-col gap-2">
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', 'reportInventory()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏', 'reportLowStock()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤', 'reportDrugUsage()')}
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center gap-3 mb-4 ml-4"><span class="text-2xl">üë•</span><h3 class="text-sm font-bold text-slate-500 uppercase italic">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3></div>
                    <div class="flex flex-col gap-2">
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', 'reportNewCustomers()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', 'reportSalesByType()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏â‡∏µ‡∏î (3/6/12 ‡∏î.)', 'reportCRM()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', 'reportRemainingCourse()')}
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center gap-3 mb-4 ml-4"><span class="text-2xl">üí∞</span><h3 class="text-sm font-bold text-slate-500 uppercase italic">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3></div>
                    <div class="flex flex-col gap-2">
                        ${renderReportButton('‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡πÇ‡∏≠‡∏ô/‡∏ö‡∏±‡∏ï‡∏£)', 'reportRevenue()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ DF/‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô', 'reportStaffDF()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ)', 'reportProfitLoss()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£ ‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤/‡∏°‡∏≤‡∏™‡∏≤‡∏¢', 'reportAttendance()')}
                        ${renderReportButton('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'reportPayroll()')}
                    </div>
                </div>

            </div>
            
            <div class="mt-20 border-t border-pink-100 pt-10 text-center opacity-30">
                <p class="text-[9px] text-slate-300 font-bold uppercase tracking-[0.5em] italic">Luxury Management Intelligence</p>
            </div>
        </div>
    `;
};

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°
function renderReportButton(title, action) {
    return `
        <button onclick="${action}" class="w-full text-left bg-white p-5 rounded-[1.5rem] border border-pink-50 shadow-sm hover:shadow-xl hover:-translate-y-0.5 transition-all group flex justify-between items-center">
            <span class="text-[12px] font-bold text-slate-600 group-hover:text-[#D48197] uppercase tracking-tighter">${title}</span>
            <span class="text-slate-200 group-hover:text-[#D48197] text-[10px]">‚ùØ</span>
        </button>
    `;
}

/* =======================================================
    üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤)
   ======================================================= */
window.reportRevenue = function() {
    const area = document.getElementById('dynamicContent');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ
    area.innerHTML = `
        <div class="animate-in slide-in-from-right duration-500 p-4 -mt-6">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="renderReportPage()" class="bg-white border border-pink-100 p-3 rounded-2xl hover:bg-pink-50 transition-all text-sm">üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                <h2 class="text-xl font-bold ace-pink italic">üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h2>
            </div>

            <div class="bg-white p-8 rounded-[3rem] shadow-2xl border border-pink-100 text-left">
                <div class="flex flex-wrap items-end gap-3 mb-8 bg-slate-50/50 p-6 rounded-[2rem] border border-slate-50">
                    <div class="w-32">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-1 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á</label>
                        <select id="revPeriodType" onchange="toggleRevFilter(this.value)" class="w-full border border-pink-100 rounded-xl px-3 py-2.5 text-xs outline-none bg-white font-light">
                            <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                            <option value="monthly" selected>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                            <option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option>
                            <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                        </select>
                    </div>

                    <div id="revMonthBox" class="w-40">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-1 block">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <select id="revMonthValue" class="w-full border border-pink-100 rounded-xl px-3 py-2.5 text-xs outline-none bg-white font-light">
                            <option value="01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="02" selected>‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                        </select>
                    </div>

                    <div id="revYearBox" class="w-32">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-1 block">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</label>
                        <select id="revYearValue" class="w-full border border-pink-100 rounded-xl px-3 py-2.5 text-xs outline-none bg-white font-light">
                            <option value="2025">2025</option><option value="2026" selected>2026</option>
                        </select>
                    </div>

                    <div id="revDateBox" class="w-44 hidden">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-1 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="revDateValue" value="${new Date().toISOString().split('T')[0]}" class="w-full border border-pink-100 rounded-xl px-3 py-2 text-xs outline-none bg-white">
                    </div>

                    <button onclick="processRevenueReport()" class="bg-black text-white px-8 py-2.5 rounded-xl text-[11px] font-bold shadow-lg hover:bg-[#D48197] transition-all uppercase tracking-widest ml-auto">
                        üîç ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    </button>
                </div>
                
                <div id="revenueReportResult" class="min-h-[300px]">
                    <div class="flex items-center justify-center h-full pt-10 text-slate-300 italic text-sm">
                        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ñ‡πà‡∏∞</p>
                    </div>
                </div>
            </div>
        </div>
    `;
};

// üîÑ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
window.toggleRevFilter = function(type) {
    document.getElementById('revMonthBox').classList.toggle('hidden', type !== 'monthly');
    document.getElementById('revDateBox').classList.toggle('hidden', type !== 'daily' && type !== 'custom');
    // ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏µ
    document.getElementById('revYearBox').classList.toggle('hidden', type === 'daily' || type === 'custom');
};

// üìä ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á
window.processRevenueReport = function() {
    const resultArea = document.getElementById('revenueReportResult');
    const period = document.getElementById('revPeriodType').value;
    const accountDB = JSON.parse(localStorage.getItem('accountDB')) || [];
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const filteredIncomes = accountDB.filter(item => {
        if (item.type !== "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" || item.status !== "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô") return false;
        
        if (period === 'daily') {
            return item.date === document.getElementById('revDateValue').value;
        } else if (period === 'monthly') {
            const [y, m, d] = item.date.split('-');
            return m === document.getElementById('revMonthValue').value && y === document.getElementById('revYearValue').value;
        } else if (period === 'yearly') {
            return item.date.startsWith(document.getElementById('revYearValue').value);
        }
        return true;
    });

    const summary = { '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î': 0, '‡πÇ‡∏≠‡∏ô (QR)': 0, '‡πÇ‡∏≠‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó': 0, '‡∏£‡∏π‡∏î‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï': 0, 'Shopee': 0, 'Gowabi': 0 };
    let grandTotal = 0;
    
    filteredIncomes.forEach(item => {
        const amt = parseFloat(String(item.total).replace(/[^0-9.-]+/g,"")) || 0;
        if (summary.hasOwnProperty(item.payment)) summary[item.payment] += amt;
        grandTotal += amt;
    });

    resultArea.innerHTML = `
        <div class="animate-in fade-in duration-500 w-full mt-4">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-6 mb-10">
                ${Object.entries(summary).map(([method, total]) => `
                    <div class="bg-slate-50 p-6 rounded-[2.5rem] border border-white shadow-sm text-center transition-all hover:scale-105">
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">${method}</p>
                        <p class="text-2xl font-black ${total > 0 ? 'text-[#D48197]' : 'text-slate-200'}">‡∏ø${total.toLocaleString()}</p>
                    </div>`).join('')}
            </div>
            <div class="bg-[#D48197] p-10 rounded-[3rem] text-white mb-4 flex justify-between items-center shadow-xl">
                <div>
                    <p class="text-[11px] uppercase opacity-80 font-bold tracking-widest">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <h2 class="text-6xl font-black italic tracking-tighter">‡∏ø${grandTotal.toLocaleString()}</h2>
                </div>
                <button onclick="window.print()" class="bg-white text-[#D48197] px-10 py-4 rounded-2xl font-bold text-[11px] uppercase tracking-tighter hover:bg-slate-50 shadow-md">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
    `;
};
// 5. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á)
window.reportInventory = () => alert("üì¶ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...");
window.reportLowStock = () => alert("‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...");
window.reportDrugUsage = () => alert("üíâ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...");
window.reportNewCustomers = () => alert("üë• ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...");
window.reportSalesByType = () => alert("üõçÔ∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...");
window.reportCRM = () => alert("üíâ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏â‡∏µ‡∏î ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...");
window.reportRemainingCourse = () => alert("‚ú® ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...");
window.reportStaffDF = () => alert("üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...");
window.reportAttendance = () => alert("ü©∫ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤/‡∏°‡∏≤‡∏™‡∏≤‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...");
window.reportPayroll = () => alert("üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...");
/* =======================================================
    üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (Profit & Loss Report) 
    ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö Filter ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
   ======================================================= */

window.reportProfitLoss = function() {
    const area = document.getElementById('dynamicContent');
    if(!area) return;

    area.innerHTML = `
        <div class="animate-in slide-in-from-right duration-500 p-4 -mt-6 text-left">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="renderReportPage()" class="bg-white border border-pink-100 p-3 rounded-2xl hover:bg-pink-50 transition-all text-sm font-bold shadow-sm">üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                <h2 class="text-xl font-bold ace-pink italic">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</h2>
            </div>

            <div class="bg-white p-8 rounded-[3rem] shadow-2xl border border-pink-100">
                <div class="flex flex-wrap items-end gap-3 mb-8 bg-slate-50/50 p-6 rounded-[2rem] border border-slate-50">
                    <div class="w-32">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-1 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á</label>
                        <select id="pnLPeriodType" onchange="togglePnLFilter(this.value)" class="w-full border border-pink-100 rounded-xl px-3 py-2.5 text-xs outline-none bg-white font-light cursor-pointer">
                            <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                            <option value="monthly" selected>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                            <option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option>
                        </select>
                    </div>

                    <div id="pnLMonthBox" class="w-40">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-1 block">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <select id="pnLMonthValue" class="w-full border border-pink-100 rounded-xl px-3 py-2.5 text-xs outline-none bg-white font-light cursor-pointer">
                            <option value="01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="02" selected>‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                        </select>
                    </div>

                    <div id="pnLYearBox" class="w-32">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-1 block">‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</label>
                        <select id="pnLYearValue" class="w-full border border-pink-100 rounded-xl px-3 py-2.5 text-xs outline-none bg-white font-light cursor-pointer">
                            <option value="2025">2025</option><option value="2026" selected>2026</option>
                        </select>
                    </div>

                    <div id="pnLDateBox" class="w-44 hidden">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-1 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="pnLDateValue" value="${new Date().toISOString().split('T')[0]}" class="w-full border border-pink-100 rounded-xl px-3 py-2 text-xs outline-none bg-white font-light">
                    </div>

                    <button onclick="processProfitLossReport()" class="bg-black text-white px-10 py-2.5 rounded-xl text-[11px] font-bold shadow-lg hover:bg-[#D48197] transition-all uppercase tracking-widest ml-auto">
                        üîç ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
                    </button>
                </div>
                
                <div id="pnLReportResult" class="min-h-[400px]">
                    <div class="flex flex-col items-center justify-center h-full pt-20 text-slate-300 italic text-sm">
                        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥" ‡∏Ñ‡πà‡∏∞</p>
                    </div>
                </div>
            </div>
        </div>
    `;
};

// üîÑ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Filter (‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ)
window.togglePnLFilter = function(type) {
    document.getElementById('pnLMonthBox').classList.toggle('hidden', type !== 'monthly');
    document.getElementById('pnLDateBox').classList.toggle('hidden', type !== 'daily');
    document.getElementById('pnLYearBox').classList.toggle('hidden', type === 'daily');
};

/* =======================================================
    üìä ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô) 
   ======================================================= */
window.processProfitLossReport = function() {
    const resultArea = document.getElementById('pnLReportResult');
    const period = document.getElementById('pnLPeriodType').value;
    const accountDB = JSON.parse(localStorage.getItem('accountDB')) || [];
    const todayQueue = JSON.parse(localStorage.getItem('todayQueueDB')) || [];

    // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î
    const filteredAccounts = accountDB.filter(item => {
        if (period === 'daily') return item.date === document.getElementById('pnLDateValue').value;
        if (period === 'monthly') {
            const [y, m, d] = item.date.split('-');
            return m === document.getElementById('pnLMonthValue').value && y === document.getElementById('pnLYearValue').value;
        }
        if (period === 'yearly') return item.date.startsWith(document.getElementById('pnLYearValue').value);
        return false;
    });

    let totalRevenue = 0; 
    let generalExpenses = 0; 
    filteredAccounts.forEach(item => {
        const amt = parseFloat(String(item.total || item.amount || 0).replace(/[^0-9.-]+/g,""));
        if (item.type === "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" && item.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô") totalRevenue += amt;
        if (item.type === "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢") generalExpenses += amt;
    });

    // 2. ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ (DF)
    let totalDF = 0;
    todayQueue.forEach(q => {
        if (q.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô") {
            totalDF += (parseFloat(q.staffDF || 0) + parseFloat(q.doctorDF || 0));
        }
    });

    // 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÉ‡∏™‡πà‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ)
    const totalStaffSalary = 0; 

    resultArea.innerHTML = `
        <div class="animate-in fade-in duration-500 w-full mt-6">
            <div class="bg-blue-50 p-4 rounded-2xl mb-8 border border-blue-100 flex items-center justify-between">
                <p class="text-[11px] font-bold text-blue-600 uppercase ml-2 italic">üìå ‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏° (${period === 'monthly' ? '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'}):</p>
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-blue-400">‡∏ø</span>
                    <input type="number" id="inputManualSalary" oninput="reCalculateNetProfit(${totalRevenue}, ${generalExpenses}, ${totalDF})" 
                        placeholder="0.00" class="w-32 border border-blue-200 rounded-lg px-3 py-1.5 text-sm font-bold outline-none text-blue-700">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <div class="bg-white p-8 rounded-[2.5rem] border border-green-100 shadow-sm text-center">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (Income)</p>
                    <p class="text-3xl font-black text-green-500">‡∏ø${totalRevenue.toLocaleString()}</p>
                </div>
                <div class="bg-white p-8 rounded-[2.5rem] border border-red-100 shadow-sm text-center">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (Expenses)</p>
                    <p id="displayTotalExpense" class="text-3xl font-black text-red-400">‡∏ø${(generalExpenses + totalDF).toLocaleString()}</p>
                </div>
                <div id="profitBox" class="bg-slate-50 p-8 rounded-[2.5rem] border border-white shadow-xl text-center border-pink-200">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Profit)</p>
                    <p id="displayNetProfit" class="text-4xl font-black text-[#D48197]">‡∏ø${(totalRevenue - generalExpenses - totalDF).toLocaleString()}</p>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] border border-pink-50 overflow-hidden shadow-sm p-4">
                <table class="w-full text-sm">
                    <tbody class="text-slate-600 font-light italic">
                        <tr class="border-b border-slate-50"><td class="py-4 px-6">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå</td><td class="py-4 px-6 text-right text-green-500 font-bold">+ ‡∏ø${totalRevenue.toLocaleString()}</td></tr>
                        <tr class="border-b border-slate-50"><td class="py-4 px-6">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡πå (DF)</td><td class="py-4 px-6 text-right text-red-400">- ‡∏ø${totalDF.toLocaleString()}</td></tr>
                        <tr class="border-b border-slate-50"><td class="py-4 px-6">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î / ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</td><td class="py-4 px-6 text-right text-red-400">- ‡∏ø${generalExpenses.toLocaleString()}</td></tr>
                        <tr class="border-b border-slate-50 bg-blue-50/20"><td class="py-4 px-6 font-bold text-blue-600 underline">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°)</td><td id="tableSalaryDisplay" class="py-4 px-6 text-right text-blue-600 font-bold">- ‡∏ø0</td></tr>
                    </tbody>
                </table>
            </div>
        </div>`;
};

// üîÑ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
window.reCalculateNetProfit = function(rev, exp, df) {
    const manualSalary = parseFloat(document.getElementById('inputManualSalary').value) || 0;
    const totalExp = exp + df + manualSalary;
    const net = rev - totalExp;

    document.getElementById('displayTotalExpense').innerText = '‡∏ø' + totalExp.toLocaleString();
    document.getElementById('displayNetProfit').innerText = '‡∏ø' + net.toLocaleString();
    document.getElementById('tableSalaryDisplay').innerText = '- ‡∏ø' + manualSalary.toLocaleString();
    
    const profitBox = document.getElementById('profitBox');
    const profitText = document.getElementById('displayNetProfit');
    if(net >= 0) {
        profitBox.className = "bg-slate-50 p-8 rounded-[2.5rem] border-2 border-green-400 shadow-xl text-center animate-pulse";
        profitText.className = "text-4xl font-black text-[#D48197]";
    } else {
        profitBox.className = "bg-red-50 p-8 rounded-[2.5rem] border-2 border-red-400 shadow-xl text-center";
        profitText.className = "text-4xl font-black text-red-600";
    }
};
/* =======================================================
    üíâ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏â‡∏µ‡∏î‡∏ã‡πâ‡∏≥ (CRM Follow-up)
    ‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏≤‡πÅ‡∏Ç‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£
   ======================================================= */

window.reportCRM = function() {
    const area = document.getElementById('dynamicContent');
    if(!area) return;

    area.innerHTML = `
        <div class="animate-in slide-in-from-right duration-500 p-4 -mt-6 text-left">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="renderReportPage()" class="bg-white border border-pink-100 p-3 rounded-2xl hover:bg-pink-50 transition-all text-sm font-bold shadow-sm">üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                <h2 class="text-xl font-bold ace-pink italic">üíâ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏â‡∏µ‡∏î (CRM)</h2>
            </div>

            <div class="bg-white p-8 rounded-[3rem] shadow-2xl border border-pink-100">
                <div class="flex flex-wrap items-end gap-3 mb-8 bg-slate-50/50 p-6 rounded-[2rem] border border-slate-50">
                    <div class="w-48">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-1 block">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
                        <select id="crmPeriodType" class="w-full border border-pink-100 rounded-xl px-3 py-2.5 text-xs outline-none bg-white font-light cursor-pointer">
                            <option value="3">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Botox)</option>
                            <option value="6" selected>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Filler/‡πÇ‡∏ö‡∏Å‡∏£‡∏≤‡∏°)</option>
                            <option value="12">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î 1 ‡∏õ‡∏µ (‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå/‡∏¢‡∏Å‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö)</option>
                        </select>
                    </div>

                    <button onclick="processCRMReport()" class="bg-black text-white px-10 py-2.5 rounded-xl text-[11px] font-bold shadow-lg hover:bg-[#D48197] transition-all uppercase tracking-widest ml-auto">
                        üîç ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                    </button>
                </div>
                
                <div id="crmReportResult" class="min-h-[400px]">
                    <div class="flex flex-col items-center justify-center h-full pt-20 text-slate-300 italic text-sm">
                        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏Ñ‡πà‡∏∞</p>
                    </div>
                </div>
            </div>
        </div>
    `;
};

window.processCRMReport = function() {
    const resultArea = document.getElementById('crmReportResult');
    const monthsToFollow = parseInt(document.getElementById('crmPeriodType').value);
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
    const todayQueue = JSON.parse(localStorage.getItem('todayQueueDB')) || [];
    const customerDB = JSON.parse(localStorage.getItem('customerDB')) || [];
    
    const now = new Date();
    const followList = [];

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    todayQueue.filter(q => q.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô").forEach(job => {
        const jobDate = new Date(job.date || job.completedAt);
        const diffMonths = (now.getFullYear() - jobDate.getFullYear()) * 12 + (now.getMonth() - jobDate.getMonth());

        // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
        if (diffMonths === monthsToFollow) {
            const customer = customerDB.find(c => c.id === job.customerId) || { name: job.customerName, tel: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå" };
            followList.push({
                name: customer.name || customer.customerName,
                tel: customer.tel || "N/A",
                procedure: job.service || job.courseName || "‡∏â‡∏µ‡∏î‡∏ú‡∏¥‡∏ß/‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå",
                lastDate: job.date || job.completedAt
            });
        }
    });

    if (followList.length === 0) {
        resultArea.innerHTML = `
            <div class="py-20 text-center text-slate-300 italic">
                <p class="text-4xl mb-4">üì≠</p>
                <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞</p>
            </div>`;
        return;
    }

    resultArea.innerHTML = `
        <div class="animate-in fade-in duration-500">
            <div class="mb-4 flex justify-between items-center px-4">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${followList.length} ‡∏ó‡πà‡∏≤‡∏ô</p>
            </div>
            <div class="overflow-hidden border border-slate-50 rounded-[2rem]">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-pink-50/20 text-[#D48197] text-[10px] font-bold uppercase border-b border-pink-50">
                            <th class="py-5 px-6 text-left">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th class="py-5 px-4 text-center">‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                            <th class="py-5 px-4 text-center">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                            <th class="py-5 px-6 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody class="text-slate-600">
                        ${followList.map(item => `
                            <tr class="border-b border-slate-50 hover:bg-slate-50/50 transition-all">
                                <td class="py-4 px-6 font-bold text-slate-700">${item.name}</td>
                                <td class="py-4 px-4 text-center italic text-xs">${item.procedure}</td>
                                <td class="py-4 px-4 text-center font-mono text-blue-500 underline cursor-pointer">${item.tel}</td>
                                <td class="py-4 px-6 text-right">
                                    <button onclick="window.location='tel:${item.tel}'" class="bg-green-400 text-white px-4 py-1.5 rounded-xl text-[9px] font-bold hover:bg-green-500">üìû ‡πÇ‡∏ó‡∏£‡∏ô‡∏±‡∏î</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
};
/* =======================================================
    üë• ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (New Customer Growth)
    ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡∏ê‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
   ======================================================= */

window.reportNewCustomers = function() {
    const area = document.getElementById('dynamicContent');
    if(!area) return;

    area.innerHTML = `
        <div class="animate-in slide-in-from-right duration-500 p-4 -mt-6 text-left">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="renderReportPage()" class="bg-white border border-pink-100 p-3 rounded-2xl hover:bg-pink-50 transition-all text-sm font-bold shadow-sm">üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                <h2 class="text-xl font-bold ace-pink italic">üë• ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
            </div>

            <div class="bg-white p-8 rounded-[3rem] shadow-2xl border border-pink-100">
                <div class="flex flex-wrap items-end gap-3 mb-8 bg-slate-50/50 p-6 rounded-[2rem] border border-slate-50">
                    <div class="w-40">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-1 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π</label>
                        <select id="newCustYear" class="w-full border border-pink-100 rounded-xl px-3 py-2.5 text-xs outline-none bg-white font-light cursor-pointer">
                            <option value="2025">‡∏õ‡∏µ 2025</option>
                            <option value="2026" selected>‡∏õ‡∏µ 2026</option>
                        </select>
                    </div>
                    <button onclick="processNewCustomerReport()" class="bg-black text-white px-10 py-2.5 rounded-xl text-[11px] font-bold shadow-lg hover:bg-[#D48197] transition-all uppercase tracking-widest ml-auto">
                        üìä ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                    </button>
                </div>
                
                <div id="newCustReportResult" class="min-h-[400px]">
                    <div class="flex flex-col items-center justify-center h-full pt-20 text-slate-300 italic text-sm">
                        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏∞</p>
                    </div>
                </div>
            </div>
        </div>
    `;
};

window.processNewCustomerReport = function() {
    const resultArea = document.getElementById('newCustReportResult');
    const selectedYear = document.getElementById('newCustYear').value;
    const customerDB = JSON.parse(localStorage.getItem('customerDB')) || [];
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏°.‡∏Ñ. - ‡∏ò.‡∏Ñ.)
    const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
    const monthlyStats = new Array(12).fill(0);
    let totalInYear = 0;

    // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    customerDB.forEach(cust => {
        const createDate = new Date(cust.createdAt || cust.date);
        if (createDate.getFullYear().toString() === selectedYear) {
            const month = createDate.getMonth();
            monthlyStats[month]++;
            totalInYear++;
        }
    });

    resultArea.innerHTML = `
        <div class="animate-in fade-in duration-500">
            <div class="bg-[#D48197] p-8 rounded-[2.5rem] text-white mb-10 flex justify-between items-center shadow-lg">
                <div>
                    <p class="text-[11px] uppercase opacity-80 font-bold tracking-[0.2em]">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏õ‡∏µ ${selectedYear}</p>
                    <h2 class="text-6xl font-black italic tracking-tighter">${totalInYear.toLocaleString()} <span class="text-2xl not-italic font-light">‡∏ó‡πà‡∏≤‡∏ô</span></h2>
                </div>
                <div class="text-right">
                    <p class="text-xs italic opacity-70">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                    <p class="text-2xl font-bold">${(totalInYear / 12).toFixed(1)} ‡∏ó‡πà‡∏≤‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${monthlyStats.map((count, index) => `
                    <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border border-white hover:border-pink-200 transition-all">
                        <div class="w-24 text-[11px] font-bold text-slate-400 uppercase tracking-tighter">${monthNames[index]}</div>
                        <div class="flex-1 bg-white h-4 rounded-full overflow-hidden flex items-center px-1 border border-slate-100">
                            <div class="bg-pink-300 h-2 rounded-full transition-all duration-1000" style="width: ${totalInYear > 0 ? (count/totalInYear*100) : 0}%"></div>
                        </div>
                        <div class="w-16 text-right font-black text-[#D48197]">${count} <span class="text-[9px] text-slate-300 font-normal">‡∏ó‡πà‡∏≤‡∏ô</span></div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
};

/* =======================================================
    üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ DF/‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ 0 ‡∏Ñ‡∏ô)
    ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
   ======================================================= */

window.reportStaffDF = function() {
    const area = document.getElementById('dynamicContent');
    if(!area) return;

    // üîç 1. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const todayQueue = JSON.parse(localStorage.getItem('todayQueueDB')) || [];
    const staffDB = JSON.parse(localStorage.getItem('staffDB')) || []; 
    const allNames = new Set();
    
    // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏´‡∏•‡∏±‡∏Å)
    staffDB.forEach(s => { if(s.name) allNames.add(s.name.trim()); });
    
    // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÄ‡∏™‡∏£‡∏¥‡∏°)
    todayQueue.forEach(q => {
        if(q.doctorName) allNames.add(q.doctorName.trim());
        if(q.staffName) allNames.add(q.staffName.trim());
        if(q.saleName) allNames.add(q.saleName.trim());
    });

    const nameOptions = Array.from(allNames).sort();

    area.innerHTML = `
        <div class="animate-in slide-in-from-right duration-500 p-4 -mt-6 text-left">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="renderReportPage()" class="bg-white border border-pink-100 p-3 rounded-2xl hover:bg-pink-50 transition-all text-sm font-bold shadow-sm">üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                <h2 class="text-xl font-bold ace-pink italic leading-none">üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ DF & ‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</h2>
            </div>

            <div class="bg-white p-10 rounded-[3rem] shadow-2xl border border-pink-100 min-h-[600px]">
                <div class="flex flex-wrap items-end gap-4 mb-10 bg-slate-50/50 p-8 rounded-[2.5rem] border border-slate-100">
                    <div class="w-32">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-2 block italic">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á</label>
                        <select id="staffDFPeriod" onchange="toggleStaffDFFilter(this.value)" class="w-full border border-pink-100 rounded-xl px-4 py-3 text-xs outline-none bg-white font-bold">
                            <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                            <option value="monthly" selected>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        </select>
                    </div>

                    <div id="dfMonthBox" class="w-40">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-2 block italic">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <select id="dfMonthValue" class="w-full border border-pink-100 rounded-xl px-4 py-3 text-xs outline-none bg-white font-bold text-slate-700">
                            ${[...Array(12)].map((_, i) => {
                                const m = String(i+1).padStart(2, '0');
                                const currentM = String(new Date().getMonth() + 1).padStart(2, '0');
                                return `<option value="${m}" ${m === currentM ? 'selected' : ''}>${new Intl.DateTimeFormat('th-TH', {month: 'long'}).format(new Date(2026, i, 1))}</option>`;
                            }).join('')}
                        </select>
                    </div>

                    <div id="dfDateBox" class="w-44 hidden">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-2 block italic">‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="dfDateValue" value="${new Date().toISOString().split('T')[0]}" class="w-full border border-pink-100 rounded-xl px-4 py-2.5 text-xs outline-none bg-white font-bold">
                    </div>

                    <div class="flex-1 min-w-[200px]">
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 mb-2 block italic">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô/‡πÄ‡∏ã‡∏•‡∏•‡πå)</label>
                        <select id="filterStaffName" class="w-full border-2 border-pink-100 rounded-xl px-4 py-3 text-[11px] outline-none bg-white font-black text-slate-700 focus:border-[#D48197] transition-all">
                            <option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${nameOptions.length} ‡∏Ñ‡∏ô) --</option>
                            ${nameOptions.map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                    </div>

                    <button onclick="processStaffDFReport()" class="bg-black text-white px-10 py-3.5 rounded-2xl text-[12px] font-black shadow-lg hover:bg-[#D48197] transition-all uppercase tracking-widest ml-auto">
                        üîç ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
                    </button>
                </div>
                
                <div id="staffDFReportResult">
                    <div class="py-20 flex flex-col items-center justify-center text-slate-300 italic text-sm">
                        <p class="text-5xl mb-6 opacity-20">üí∞</p>
                        <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏Ñ‡πà‡∏∞</p>
                        ${nameOptions.length === 0 ? '<p class="text-pink-400 mt-4 text-[10px] font-bold uppercase">! ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞</p>' : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
};
/* =======================================================
    üë• ‡∏´‡∏ô‡πâ‡∏≤‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Staff Management Hub)
    ‡∏£‡∏ß‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡πà‡∏≠‡∏¢: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô, ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î, ‡∏Ç‡∏≤‡∏î‡∏•‡∏≤‡∏™‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
   ======================================================= */

window.renderStaffManagement = function() {
    const target = document.getElementById('dynamicContent');
    if(!target) return;

    target.innerHTML = `
        <div class="animate-in fade-in duration-500 p-4 -mt-6 text-left">
            <div class="flex items-center gap-4 mb-10 bg-white p-8 rounded-[3rem] shadow-sm border border-pink-100">
                <div class="w-16 h-16 bg-pink-500 rounded-3xl flex items-center justify-center shadow-lg shadow-pink-200">
                    <span class="text-3xl text-white">ü©∫</span>
                </div>
                <div>
                    <h2 class="text-3xl font-black ace-pink italic leading-none">STAFF HUB</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mt-2 italic tracking-[0.2em]">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <div onclick="renderStaffProfileList()" class="bg-white p-8 rounded-[3rem] border border-pink-50 shadow-xl hover:scale-105 transition-all cursor-pointer group">
                    <div class="w-14 h-14 bg-pink-50 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-pink-500 transition-colors">
                        <span class="text-2xl group-hover:filter group-hover:invert transition-all">üë•</span>
                    </div>
                    <h3 class="font-black text-slate-700 text-lg">‡πÅ‡∏ü‡πâ‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
                    <p class="text-[10px] text-slate-400 mt-2 italic">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß, ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°, ‡∏†‡∏≤‡∏©‡∏µ ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</p>
                </div>

                <div onclick="renderStaffCalendar()" class="bg-white p-8 rounded-[3rem] border border-pink-50 shadow-xl hover:scale-105 transition-all cursor-pointer group">
                    <div class="w-14 h-14 bg-blue-50 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-blue-500 transition-colors">
                        <span class="text-2xl group-hover:filter group-hover:invert transition-all">üìÖ</span>
                    </div>
                    <h3 class="font-black text-slate-700 text-lg">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h3>
                    <p class="text-[10px] text-slate-400 mt-2 italic">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</p>
                </div>

                <div onclick="renderAttendanceRecord()" class="bg-white p-8 rounded-[3rem] border border-pink-50 shadow-xl hover:scale-105 transition-all cursor-pointer group">
                    <div class="w-14 h-14 bg-red-50 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-red-500 transition-colors">
                        <span class="text-2xl group-hover:filter group-hover:invert transition-all">üìâ</span>
                    </div>
                    <h3 class="font-black text-slate-700 text-lg">‡∏Ç‡∏≤‡∏î / ‡∏•‡∏≤ / ‡∏™‡∏≤‡∏¢</h3>
                    <p class="text-[10px] text-slate-400 mt-2 italic">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>

                <div onclick="renderPayrollSystem()" class="bg-white p-8 rounded-[3rem] border border-pink-50 shadow-xl hover:scale-105 transition-all cursor-pointer group">
                    <div class="w-14 h-14 bg-green-50 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-green-500 transition-colors">
                        <span class="text-2xl group-hover:filter group-hover:invert transition-all">üí∞</span>
                    </div>
                    <h3 class="font-black text-slate-700 text-lg">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                    <p class="text-[10px] text-slate-400 mt-2 italic">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô + DF - ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢</p>
                </div>

            </div>
        </div>
    `;
};
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Modal/Prompt ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡∏™‡∏ß‡∏¢)
window.showAddStaffModal = function() {
    const name = prompt("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:");
    if (!name) return;
    
    const role = prompt("‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏û‡∏ó‡∏¢‡πå, ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô, ‡πÄ‡∏ã‡∏•‡∏•‡πå, ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢):", "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");
    const tel = prompt("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:");
    const salary = prompt("‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç):", "0");

    const staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
    staffDB.push({
        name: name.trim(),
        role: role || "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",
        tel: tel || "-",
        salary: parseFloat(salary) || 0
    });

    localStorage.setItem('staffDB', JSON.stringify(staffDB));
    renderStaffManagement(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞!");
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
window.deleteStaff = function(index) {
    if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        const staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
        staffDB.splice(index, 1);
        localStorage.setItem('staffDB', JSON.stringify(staffDB));
        renderStaffManagement();
    }
};
/* =======================================================
    üë• 1. ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ü‡πâ‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Professional Table View)
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏ß‡∏°‡∏ä‡∏∏‡∏î‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (‡∏ï‡∏≤‡∏£‡∏≤‡∏á + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô + ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
   ======================================================= */

// --- üìã 1.1 ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ---
window.renderStaffProfileList = function() {
    const target = document.getElementById('dynamicContent');
    const staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
    const activeStaff = staffDB.filter(s => s.status !== '‡∏≠‡∏≠‡∏Å');

    target.innerHTML = `
        <div class="animate-in fade-in duration-500 p-6 bg-[#FDF7F8] min-h-screen text-left font-sans">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm mb-6 flex flex-wrap items-center gap-4 border border-pink-100">
                <button onclick="renderStaffManagement()" class="bg-pink-50 p-3 rounded-2xl hover:bg-pink-100 transition-all text-[#D48197] font-bold">üîô ‡∏Å‡∏•‡∏±‡∏ö</button>
                
                <select id="filterBranch" onchange="window.filterStaffTable()" class="bg-slate-100 border border-pink-200 rounded-xl px-4 py-2 text-xs font-bold outline-none text-slate-600 ring-1 ring-pink-50">
                    <option value="">‚ú® ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                    <option value="‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ">‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ</option>
                    <option value="‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ">‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</option>
                    <option value="‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç">‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç</option>
                </select>
                
                <div class="flex-1 relative">
                    <input type="text" id="searchName" onkeyup="window.filterStaffTable()" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / HN / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" 
                        class="w-full bg-slate-50 border border-pink-300 rounded-full px-6 py-3 text-xs outline-none focus:ring-2 focus:ring-pink-400 shadow-inner">
                </div>

                <button onclick="window.filterStaffTable()" class="bg-[#D4B581] text-white px-8 py-3 rounded-full text-xs font-black shadow-md hover:scale-105 transition-all">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                <button onclick="window.showStaffModal('add')" class="bg-black text-white px-8 py-3 rounded-full text-xs font-black shadow-md hover:bg-slate-800 transition-all">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                <button onclick="window.renderResignedStaffTable()" class="bg-[#D48197] text-white px-6 py-3 rounded-full text-xs font-black shadow-md hover:brightness-110">üìÅ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</button>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-xl overflow-visible border border-pink-100">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-[#F9EBEF] text-[#D48197] text-[11px] font-black uppercase italic">
                            <th class="p-5">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th class="p-5 text-center">‡∏£‡∏π‡∏õ</th>
                            <th class="p-5">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</th>
                            <th class="p-5 font-mono">HN</th>
                            <th class="p-5">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th class="p-5">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
                            <th class="p-5">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                            <th class="p-5">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th class="p-5 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="staffTableBody" class="text-[11px] font-bold text-slate-600">
                        ${activeStaff.map((staff, idx) => {
                            const realIdx = staffDB.findIndex(s => s.staffId === staff.staffId);
                            return `
                            <tr class="staff-row border-b border-pink-50 hover:bg-pink-50/20 transition-all">
                                <td class="p-5 text-slate-400">${idx + 1}</td>
                                <td class="p-5 text-center">
                                    <img src="${staff.img || 'https://via.placeholder.com/150'}" class="w-10 h-10 rounded-full object-cover mx-auto border-2 border-white shadow-sm ring-1 ring-pink-100">
                                </td>
                                <td class="p-5 italic text-slate-400 font-mono">${staff.startDate || '-'}</td>
                                <td class="p-5 font-mono text-[#D48197]">${staff.staffId || '-'}</td>
                                <td class="p-5 text-slate-800">${staff.name}</td>
                                <td class="p-5 uppercase">${staff.nickname || '-'}</td>
                                <td class="p-5 font-mono">${staff.phone || '-'}</td>
                                <td class="p-5"><span class="branch-cell uppercase italic text-slate-500">${staff.branch || '-'}</span></td>
                                <td class="p-5 text-center relative">
                                    <div class="flex items-center justify-center">
                                        <button onclick="window.showStaffModal('edit', ${realIdx})" class="bg-[#D48197] text-white px-5 py-2 rounded-l-full hover:bg-[#C26D84] transition-all font-black uppercase italic">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                        <div class="relative group">
                                            <button class="bg-[#D48197] text-white px-3 py-2 rounded-r-full hover:bg-[#C26D84] border-l border-white/20 transition-all font-black">‚ñº</button>
                                            <div class="hidden group-hover:block absolute right-0 bg-white shadow-2xl rounded-2xl p-2 z-[99] border border-pink-100 min-w-[160px] animate-in zoom-in duration-150 text-left">
                                                <button onclick="window.viewStaffDetail(${realIdx})" class="w-full text-left p-3 hover:bg-pink-50 rounded-xl text-[#D48197] flex items-center gap-2 transition-all">üîç ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>                                               
 <button onclick="window.suspendStaff(${realIdx})" class="w-full text-left p-3 hover:bg-red-50 rounded-xl text-red-500 flex items-center gap-2">üö´ ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
};

/* =======================================================
    ü©∫ 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Modal)
   ======================================================= */
window.showStaffModal = function(mode, idx = null) {
    const staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
    let staff = (mode === 'edit' && idx !== null) ? staffDB[idx] : { name: '', nickname: '', phone: '', branch: '‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ', status: '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', email:'', lineId:'', bankName:'', bankAcc:'', salary: 0, startDate: '' };
    
    const modal = document.createElement('div');
    modal.id = 'staffModalContainer';
    modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-[10005] p-4';
    modal.innerHTML = `
    <div class="bg-white w-full max-w-4xl rounded-[4rem] shadow-2xl overflow-hidden border-2 border-pink-200 font-sans animate-in zoom-in duration-300">
        <div class="bg-[#F9EBEF] p-8 flex justify-between items-center border-b border-pink-300">
            <h2 class="text-[#D48197] text-xl font-bold italic uppercase">üìù ${mode === 'edit' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà'}</h2>
            <div class="flex gap-3">
                <button onclick="window.saveStaffComplete(${idx}, '${mode}')" class="bg-[#D48197] text-white px-10 py-3 rounded-full text-xs font-black shadow-lg hover:scale-105 transition-all italic">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                <button onclick="document.getElementById('staffModalContainer').remove()" class="bg-slate-200 text-slate-500 px-8 py-3 rounded-full text-xs font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
        <div class="p-12 grid grid-cols-12 gap-8 text-left overflow-y-auto max-h-[80vh]">
            <div class="col-span-4 space-y-6">
                <div class="w-full aspect-[3/4] bg-slate-50 rounded-[3rem] border-4 border-pink-300 flex flex-col items-center justify-center overflow-hidden relative shadow-inner">
                    <img id="previewImg" src="${staff.img || ''}" class="w-full h-full object-cover ${staff.img ? '' : 'hidden'}">
                    <p id="uploadText" class="${staff.img ? 'hidden' : ''} text-xs font-bold text-pink-300">üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</p>
                    <input type="file" accept="image/*" onchange="window.previewStaffPhoto(this)" class="absolute inset-0 opacity-0 cursor-pointer">
                </div>
                <select id="newStatus" class="w-full border-2 border-pink-100 p-3 rounded-xl text-sm font-bold outline-none bg-white">
                    <option value="‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" ${staff.status === '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' ? 'selected' : ''}>üü¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
                    <option value="‡∏≠‡∏≠‡∏Å" ${staff.status === '‡∏≠‡∏≠‡∏Å' ? 'selected' : ''}>üî¥ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</option>
                </select>
            </div>

            <div class="col-span-8 grid grid-cols-2 gap-4">
                <div class="col-span-1">
                    <label class="text-[10px] font-bold text-pink-500 ml-2 uppercase italic">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Auto)</label>
                    <input type="text" id="newHN" value="${staff.staffId || ''}" class="w-full bg-slate-100 border-2 border-pink-200 rounded-xl p-3 text-sm font-bold text-[#D48197]" readonly>
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] font-bold text-slate-400 ml-2 italic uppercase">üìç ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≤‡∏Ç‡∏≤</label>
                    <select id="newBranch" class="w-full border-2 border-pink-100 p-3 rounded-xl text-sm font-bold outline-none bg-white">
                        <option value="‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ" ${staff.branch === '‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ' ? 'selected' : ''}>‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ</option>
                        <option value="‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ" ${staff.branch === '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ' ? 'selected' : ''}>‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</option>
                        <option value="‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç" ${staff.branch === '‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç' ? 'selected' : ''}>‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç</option>
                    </select>
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] font-bold text-slate-400 ml-2 italic">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                    <input type="text" id="newName" value="${staff.name || ''}" class="w-full border-2 border-pink-100 p-3 rounded-xl text-sm font-bold outline-none">
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] font-bold text-slate-400 ml-2 italic">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                    <input type="text" id="newNickname" value="${staff.nickname || ''}" class="w-full border-2 border-pink-100 p-3 rounded-xl text-sm font-bold outline-none">
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] font-bold text-slate-400 ml-2 italic">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                    <input type="date" id="newStart" value="${staff.startDate || ''}" class="w-full border-2 border-pink-100 p-3 rounded-xl text-sm font-bold outline-none">
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] font-bold text-slate-400 ml-2 italic">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
                    <input type="text" id="newPhone" value="${staff.phone || ''}" class="w-full border-2 border-pink-100 p-3 rounded-xl text-sm font-bold outline-none">
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] font-bold text-[#D48197] ml-2 italic">üè¶ ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                    <input type="text" id="newBank" value="${staff.bankName || ''}" class="w-full border-2 border-pink-100 p-3 rounded-xl text-sm font-bold outline-none">
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] font-bold text-[#D48197] ml-2 italic">üí≥ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                    <input type="text" id="newAcc" value="${staff.bankAcc || ''}" class="w-full border-2 border-pink-100 p-3 rounded-xl text-sm font-bold outline-none">
                </div>
                <div class="col-span-2">
                    <label class="text-[10px] font-bold text-rose-500 ml-2 uppercase italic">üí∏ ‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô *</label>
                    <input type="number" id="newSalary" value="${staff.salary || ''}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô..." class="w-full border-2 border-rose-200 p-3 rounded-xl text-base font-black text-rose-600 outline-none bg-rose-50/30">
                </div>
                <div class="col-span-2">
                    <label class="text-[10px] font-bold text-slate-400 ml-2 italic">üè† ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                    <textarea id="newAddress" rows="2" class="w-full border-2 border-pink-200 rounded-2xl p-4 text-xs font-bold outline-none">${staff.address || ''}</textarea>
                </div>
            </div>
        </div>
    </div>`;
    document.body.appendChild(modal);
};

/* =======================================================
    üíæ 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Save Staff)
   ======================================================= */
window.saveStaffComplete = function(idx, mode) {
    const name = document.getElementById('newName')?.value;
    const branch = document.getElementById('newBranch')?.value;
    const bankName = document.getElementById('newBank')?.value;
    const bankAcc = document.getElementById('newAcc')?.value;
    const phone = document.getElementById('newPhone')?.value;
    const startDate = document.getElementById('newStart')?.value;
    const address = document.getElementById('newAddress')?.value;
    const salary = document.getElementById('newSalary')?.value;

    if (!name || !phone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ñ‡πà‡∏∞");

    let staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
    const imgElement = document.getElementById('previewImg');
    const imgData = imgElement ? imgElement.src : '';

    const data = {
        name: name,
        nickname: document.getElementById('newNickname').value,
        branch: branch || '‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ',
        status: document.getElementById('newStatus').value,
        bankName: bankName,
        bankAcc: bankAcc,
        phone: phone,
        startDate: startDate,
        address: address,
        salary: parseFloat(salary || 0),
        img: imgData.startsWith('data:') ? imgData : (mode === 'edit' && staffDB[idx] ? staffDB[idx].img : ''),
        updatedAt: new Date().toLocaleDateString('th-TH')
    };

    if (mode === 'edit' && idx !== null) {
        staffDB[idx] = { ...staffDB[idx], ...data };
    } else {
        const branchCode = branch === '‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ' ? 'P' : (branch === '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ' ? 'S' : 'O');
        const thaiYear = (new Date().getFullYear() + 543).toString().slice(-2);
        data.staffId = branchCode + thaiYear + String(staffDB.length + 1).padStart(4, '0');
        staffDB.push(data);
    }

    localStorage.setItem('staffDB', JSON.stringify(staffDB));
    document.getElementById('staffModalContainer').remove();
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞! ‚ú®");
    renderStaffProfileList();
};

/* =======================================================
    üîé 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (View Staff Detail)
   ======================================================= */
window.viewStaffDetail = function(idx) {
    const staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
    const staff = staffDB[idx];
    if (!staff) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

    const target = document.getElementById('dynamicContent');
    target.innerHTML = `
        <div class="animate-in slide-in-from-right duration-500 p-6 text-left pb-20 font-sans">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm mb-6 flex justify-between items-center border border-pink-100">
                <button onclick="renderStaffProfileList()" class="bg-pink-50 p-3 rounded-2xl text-[#D48197] font-bold">üîô ‡∏Å‡∏•‡∏±‡∏ö</button>
                <div class="text-right font-black ace-pink uppercase italic">ID: ${staff.staffId || '-'}</div>
            </div>
            <div class="grid grid-cols-12 gap-8">
                <div class="col-span-12 lg:col-span-4 space-y-6">
                    <div class="bg-white p-8 rounded-[4rem] shadow-xl border border-pink-50 text-center">
                        <img src="${staff.img || 'https://via.placeholder.com/300'}" class="w-full aspect-[3/4] rounded-[3rem] object-cover border-8 border-slate-50 mb-6">
                        <h3 class="text-2xl font-black text-slate-700">${staff.name}</h3>
                        <p class="text-sm font-bold text-[#D48197] mt-2 italic uppercase">${staff.branch}</p>
                    </div>
                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="showStaffAttendance(${idx})" class="w-full bg-blue-500 text-white p-4 rounded-3xl text-xs font-black shadow-lg hover:scale-105 transition-all">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤/‡∏™‡∏≤‡∏¢ (%)</button>
                        <button onclick="showSalaryHistory(${idx})" class="w-full bg-green-500 text-white p-4 rounded-3xl text-xs font-black shadow-lg hover:scale-105 transition-all">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
                        <button onclick="openSalaryAdjustmentModal(${idx})" class="w-full bg-rose-500 text-white p-4 rounded-3xl text-xs font-black shadow-lg hover:scale-105 transition-all">üìà ‡∏õ‡∏£‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (1 ‡∏°.‡∏Ñ.)</button>
                        <button onclick="showStaffDocs(${idx})" class="w-full bg-amber-500 text-white p-4 rounded-3xl text-xs font-black shadow-lg hover:scale-105 transition-all">üìÅ ‡πÅ‡∏ü‡πâ‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
                    </div>
                </div>
                <div class="col-span-12 lg:col-span-8 space-y-6">
                    <div class="bg-white p-10 rounded-[4rem] shadow-xl border border-pink-50">
                        <h3 class="text-lg font-black text-slate-700 mb-8 border-b border-dashed border-pink-200 pb-4 italic">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
                        <div class="grid grid-cols-2 gap-y-6 gap-x-10">
                            <div><label class="text-[10px] text-slate-400 font-bold uppercase italic">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label><p class="font-bold text-slate-700 border-b border-slate-50 pb-1">${staff.nickname || '-'}</p></div>
                            <div><label class="text-[10px] text-slate-400 font-bold uppercase italic">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><p class="font-bold text-blue-500 border-b border-slate-50 pb-1">${staff.phone || '-'}</p></div>
                            <div><label class="text-[10px] text-slate-400 font-bold uppercase italic">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label><p class="font-bold text-slate-700 border-b border-slate-50 pb-1">${staff.startDate || '-'}</p></div>
                            <div><label class="text-[10px] text-slate-400 font-bold uppercase italic">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><p class="font-bold text-green-500 border-b border-slate-50 pb-1">${staff.status || '-'}</p></div>
                            <div><label class="text-[10px] text-[#D48197] font-bold uppercase italic block italic">üè¶ ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label><p class="font-bold text-slate-700 border-b border-slate-50 pb-1">${staff.bankName || '-'}</p></div>
                            <div><label class="text-[10px] text-[#D48197] font-bold uppercase italic block italic">üí≥ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><p class="font-bold text-slate-700 border-b border-slate-50 pb-1">${staff.bankAcc || '-'}</p></div>
                            <div><label class="text-[10px] text-rose-500 font-bold uppercase italic block">üí∏ ‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label><p class="text-sm font-black text-rose-600 border-b border-rose-50 pb-1">‡∏ø${parseFloat(staff.salary || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}</p></div>
                            <div class="col-span-2"><label class="text-[10px] text-slate-400 font-bold uppercase italic">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label><p class="text-xs font-bold text-slate-500 leading-relaxed">${staff.address || '-'}</p></div>
                        </div>
                    </div>
                    <div id="staffSubDisplay" class="bg-white p-10 rounded-[4rem] shadow-2xl border-2 border-slate-50 min-h-[400px]">
                        <div class="flex flex-col items-center justify-center h-full pt-20 text-slate-300 italic text-center">
                            <p class="text-6xl mb-4 opacity-20">üìä</p><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ñ‡πà‡∏∞</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
};

// üìä 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥, ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£) - ‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
window.showStaffAttendance = function(idx) {
    const staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
    const staff = staffDB[idx];
    if (!staff) return;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ---
    const totalWorkDays = 26; // ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    const absentDays = parseInt(staff.lastAbsentReg || 0); // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏Ç‡∏≤‡∏î
    const lateMins = parseInt(staff.lastLateMins || 0);   // ‡∏î‡∏∂‡∏á‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏¢
    const leaveDays = parseInt(staff.lastLeaveDays || 0); // ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏•‡∏≤

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (Work Attendance Rate)
    // ‡∏™‡∏π‡∏ï‡∏£: ((‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - ‡∏ß‡∏±‡∏ô‡∏Ç‡∏≤‡∏î) / ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) * 100
    const attendanceRate = Math.max(0, ((totalWorkDays - absentDays) / totalWorkDays) * 100).toFixed(0);

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    let suggestion = "‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô 1-5% ‡∏Ñ‡πà‡∏∞";
    if (attendanceRate < 90) suggestion = "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°";
    if (lateMins > 120) suggestion = "‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏±‡∏Å‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";

    document.getElementById('staffSubDisplay').innerHTML = `
        <div class="animate-in fade-in duration-300 text-left">
            <div class="flex justify-between items-center mb-6 border-b pb-2">
                <h4 class="text-lg font-black text-blue-600 uppercase italic">üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Attendance)</h4>
                <button onclick="openAttendanceEntryModal(${idx})" class="bg-blue-600 text-white px-4 py-1.5 rounded-xl text-[10px] font-bold hover:bg-black transition-all">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤/‡∏™‡∏≤‡∏¢</button>
            </div>

            <div class="grid grid-cols-4 gap-4 mb-8">
                <div class="bg-green-50 p-6 rounded-[2.5rem] text-center border border-green-100 shadow-sm">
                    <p class="text-[9px] text-green-600 font-black uppercase mb-1">‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á</p>
                    <h5 class="text-4xl font-black text-green-600">${attendanceRate}%</h5>
                </div>

                <div class="col-span-3 bg-slate-50 p-6 rounded-[2.5rem] flex justify-around items-center border border-slate-100">
                    <div class="text-center">
                        <p class="text-[9px] text-slate-400 font-bold uppercase">‡∏™‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
                        <p class="text-xl font-black text-slate-700">${lateMins} ‡∏ô.</p>
                    </div>
                    <div class="text-center border-l border-slate-200 pl-8">
                        <p class="text-[9px] text-slate-400 font-bold uppercase">‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô</p>
                        <p class="text-xl font-black text-red-500">${absentDays} ‡∏ß‡∏±‡∏ô</p>
                    </div>
                    <div class="text-center border-l border-slate-200 pl-8">
                        <p class="text-[9px] text-slate-400 font-bold uppercase">‡∏•‡∏≤‡∏Å‡∏¥‡∏à/‡∏õ‡πà‡∏ß‡∏¢</p>
                        <p class="text-xl font-black text-blue-400">${leaveDays} ‡∏ß‡∏±‡∏ô</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100 text-center animate-pulse">
                <p class="text-xs font-bold text-blue-700 underline underline-offset-4">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 1 ‡∏°.‡∏Ñ.: ${suggestion}</p>
            </div>
        </div>`;
};

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤/‡∏™‡∏≤‡∏¢ ---
window.openAttendanceEntryModal = function(idx) {
    const staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
    const staff = staffDB[idx];

    document.getElementById('staffSubDisplay').innerHTML = `
        <div class="animate-in slide-in-from-right duration-300 text-left">
            <h4 class="text-lg font-black text-blue-600 uppercase mb-6 border-b pb-2 italic">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h4>
            <p class="text-xs font-bold text-slate-400 mb-6 italic">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${staff.name}</p>
            
            <div class="grid grid-cols-3 gap-6 mb-8">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">‡∏™‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏° (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                    <input type="number" id="inputLate" value="${staff.lastLateMins || 0}" class="w-full border-2 border-slate-100 p-4 rounded-2xl font-bold outline-none focus:border-blue-400 bg-white">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-red-400 uppercase ml-2">‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô)</label>
                    <input type="number" id="inputAbsent" value="${staff.lastAbsentReg || 0}" class="w-full border-2 border-slate-100 p-4 rounded-2xl font-bold outline-none focus:border-red-400 bg-white text-red-500">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-blue-400 uppercase ml-2">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏Å‡∏¥‡∏à (‡∏ß‡∏±‡∏ô)</label>
                    <input type="number" id="inputLeave" value="${staff.lastLeaveDays || 0}" class="w-full border-2 border-slate-100 p-4 rounded-2xl font-bold outline-none focus:border-blue-400 bg-white text-blue-500">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="saveAttendanceData(${idx})" class="flex-1 bg-black text-white py-4 rounded-[1.5rem] font-bold shadow-xl hover:bg-blue-600 transition-all uppercase text-xs italic">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                <button onclick="showStaffAttendance(${idx})" class="px-8 py-4 bg-slate-100 text-slate-400 rounded-[1.5rem] font-bold text-xs">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>`;
};

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á LocalStorage ---
window.saveAttendanceData = function(idx) {
    let db = JSON.parse(localStorage.getItem('staffDB')) || [];
    
    db[idx].lastLateMins = parseInt(document.getElementById('inputLate').value) || 0;
    db[idx].lastAbsentReg = parseInt(document.getElementById('inputAbsent').value) || 0;
    db[idx].lastLeaveDays = parseInt(document.getElementById('inputLeave').value) || 0;

    localStorage.setItem('staffDB', JSON.stringify(db));
    
    Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', timer: 1500, showConfirmButton: false });
    showStaffAttendance(idx); // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏∏‡∏ì)
window.openSalaryAdjustmentModal = function(idx) {
    const staff = (JSON.parse(localStorage.getItem('staffDB')) || [])[idx];
    document.getElementById('staffSubDisplay').innerHTML = `
        <div class="max-w-md mx-auto py-10 text-left animate-in slide-in-from-bottom">
            <h4 class="text-2xl font-black text-rose-600 italic mb-8 uppercase">üìà ‡∏õ‡∏£‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</h4>
            <div class="space-y-6">
                <div class="bg-slate-50 p-5 rounded-[2rem] border border-slate-100 shadow-inner">
                    <label class="text-[10px] text-slate-400 font-bold uppercase ml-2 italic">‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                    <p class="text-3xl font-black text-slate-700 ml-2">‡∏ø${parseFloat(staff.salary || 0).toLocaleString()}</p>
                </div>
                <div>
                    <label class="text-[10px] text-rose-500 font-bold uppercase ml-2">‡∏£‡∏∞‡∏ö‡∏∏‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏°‡∏µ‡∏ú‡∏• 1 ‡∏°.‡∏Ñ.)</label>
                    <input type="number" id="newSalaryInput" placeholder="0.00" class="w-full border-2 border-rose-100 p-5 rounded-[2rem] text-xl font-black text-rose-600 outline-none focus:border-rose-400">
                </div>
                <button onclick="saveSalaryAdjustment(${idx})" class="w-full bg-rose-500 text-white p-6 rounded-[2.5rem] font-black shadow-xl hover:brightness-110 transition-all uppercase tracking-widest italic">üíæ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            </div>
        </div>`;
};
/* =======================================================
    üïí GLOBAL UTILITIES (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
   ======================================================= */
window.previewStaffPhoto = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('previewImg').classList.remove('hidden');
            if(document.getElementById('uploadText')) document.getElementById('uploadText').classList.add('hidden');
        };
        reader.readAsDataURL(input.files[0]);
    }
};

function updateHeaderTime() {
    const timeEl = document.getElementById('headerLastUpdate');
    if (timeEl) timeEl.innerText = new Date().toLocaleTimeString('th-TH', { hour12: false });
}
setInterval(updateHeaderTime, 1000);
window.onload = () => { if(document.getElementById('headerDatePicker')) document.getElementById('headerDatePicker').valueAsDate = new Date(); };
/* =======================================================
    üöÄ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
   ======================================================= */
window.filterStaffTable = function() {
    const input = document.getElementById("searchName");
    const branch = document.getElementById("filterBranch").value;
    const filter = input.value.toLowerCase();
    const rows = document.querySelectorAll("#staffTableBody tr");

    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        const branchText = row.querySelector(".branch-cell").innerText;
        
        const matchSearch = text.includes(filter);
        const matchBranch = branch === "" || branchText.includes(branch);

        if (matchSearch && matchBranch) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
};

/* =======================================================
    üíä ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Auto-Fill ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏à‡∏≤‡∏Å Master Data (‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤)
   ======================================================= */
window.autoFillDrugInfo = function(drugName) {
    const drugDB = JSON.parse(localStorage.getItem('drugMasterDB')) || [];
    const drug = drugDB.find(d => d.name === drugName);
    
    if (drug) {
        if(document.getElementById('lblUsage')) document.getElementById('lblUsage').value = drug.usage || '';
        if(document.getElementById('lblDetail')) document.getElementById('lblDetail').value = drug.detail || '';
    }
};

/* =======================================================
    üíæ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤ (Drug Master)
   ======================================================= */
window.saveDrugMaster = function() {
    const name = document.getElementById('mDrugName').value.trim();
    const usage = document.getElementById('mDrugUsage').value;
    const detail = document.getElementById('mDrugDetail').value;

    if (!name) { alert("‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞"); return; }

    let drugDB = JSON.parse(localStorage.getItem('drugMasterDB')) || [];
    drugDB.unshift({ name, usage, detail });
    localStorage.setItem('drugMasterDB', JSON.stringify(drugDB));

    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏¢‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    document.getElementById('drugMasterModal').remove();
    openDrugMasterSettings(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
};

/* =======================================================
    üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Staff DF) - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
   ======================================================= */
window.processStaffDFReport = function() {
    const resultArea = document.getElementById('staffDFReportResult');
    const selectedStaff = document.getElementById('filterStaffName').value;
    const period = document.getElementById('staffDFPeriod').value;
    
    const todayQueue = JSON.parse(localStorage.getItem('todayQueueDB')) || [];
    const doneJobs = todayQueue.filter(q => q.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");

    let filtered = doneJobs.filter(q => {
        if (!selectedStaff) return true;
        return q.staff === selectedStaff || q.doctor === selectedStaff;
    });

    let totalDF = 0;
    const listHtml = filtered.map(item => {
        const df = (item.staff === selectedStaff) ? parseFloat(item.staffDF || 0) : parseFloat(item.doctorDF || 0);
        totalDF += df;
        return `
            <div class="flex justify-between p-4 border-b border-pink-50">
                <span class="text-slate-600">${item.name} (${item.course})</span>
                <span class="font-bold text-pink-500">‡∏ø${df.toLocaleString()}</span>
            </div>
        `;
    }).join('');

    resultArea.innerHTML = `
        <div class="animate-in fade-in duration-500 bg-white rounded-[2rem] p-6 shadow-inner border border-pink-50">
            <div class="mb-6 bg-[#D48197] p-6 rounded-3xl text-white flex justify-between items-center">
                <p class="font-bold uppercase text-[10px]">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∞‡∏™‡∏° ${selectedStaff || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}</p>
                <h2 class="text-4xl font-black italic">‡∏ø${totalDF.toLocaleString()}</h2>
            </div>
            ${listHtml || '<p class="text-center py-10 text-slate-300">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</p>'}
        </div>
    `;
};
/* =======================================================
    üö´ 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Suspend Staff)
   ======================================================= */
window.suspendStaff = function(idx) {
    let staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
    const staffName = staffDB[idx].name;

    if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á "${staffName}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ü‡πâ‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡∏£‡∏∞‡∏á‡∏±‡∏ö)`)) {
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏≠‡∏≠‡∏Å' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏£‡∏∞‡∏á‡∏±‡∏ö' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏≤‡∏Å Filter ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        staffDB[idx].status = '‡∏≠‡∏≠‡∏Å'; 
        staffDB[idx].resignDate = new Date().toLocaleDateString('th-TH');
        
        localStorage.setItem('staffDB', JSON.stringify(staffDB));
        
        alert(`‚úÖ ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ${staffName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞`);
        renderStaffProfileList(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    }
};

/* =======================================================
    üìÅ 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (Resigned Staff Table)
   ======================================================= */
window.renderResignedStaffTable = function() {
    const target = document.getElementById('dynamicContent');
    const staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏≠‡∏≠‡∏Å'
    const resignedStaff = staffDB.filter(s => s.status === '‡∏≠‡∏≠‡∏Å');

    target.innerHTML = `
        <div class="animate-in slide-in-from-bottom duration-500 p-6 text-left">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm mb-6 flex justify-between items-center border border-pink-100">
                <div class="flex items-center gap-4">
                    <button onclick="renderStaffProfileList()" class="bg-slate-100 p-3 rounded-2xl hover:bg-slate-200 transition-all text-slate-500 font-bold">üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                    <h2 class="text-xl font-black text-slate-400 italic uppercase">üìÅ ‡πÅ‡∏ü‡πâ‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å/‡∏£‡∏∞‡∏á‡∏±‡∏ö</h2>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border border-slate-200 opacity-80">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-100 text-slate-400 text-[11px] font-black uppercase">
                            <th class="p-5">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th class="p-5">‡∏£‡∏π‡∏õ</th>
                            <th class="p-5">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th>
                            <th class="p-5">HN</th>
                            <th class="p-5">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th class="p-5">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th class="p-5 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody class="text-[11px] font-bold text-slate-500">
                        ${resignedStaff.length > 0 ? resignedStaff.map((staff, idx) => {
                            const realIdx = staffDB.findIndex(s => s.staffId === staff.staffId);
                            return `
                            <tr class="border-b border-slate-50 hover:bg-slate-50 transition-all">
                                <td class="p-5">${idx + 1}</td>
                                <td class="p-5 text-center">
                                    <img src="${staff.img || 'https://via.placeholder.com/150'}" class="w-10 h-10 rounded-full grayscale object-cover mx-auto opacity-50">
                                </td>
                                <td class="p-5 text-red-400">${staff.resignDate || '-'}</td>
                                <td class="p-5 font-mono">${staff.staffId || '-'}</td>
                                <td class="p-5">${staff.name}</td>
                                <td class="p-5">${staff.branch || '-'}</td>
                                <td class="p-5 text-center">
                                    <button onclick="window.restoreStaff(${realIdx})" class="bg-green-500 text-white px-4 py-1.5 rounded-full hover:bg-green-600 transition-all text-[9px] font-black uppercase">üîÑ ‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
                                </td>
                            </tr>`;
                        }).join('') : `<tr><td colspan="7" class="p-20 text-center italic text-slate-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏Ñ‡πà‡∏∞</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
    `;
};

/* =======================================================
    üîÑ 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Restore Staff)
   ======================================================= */
window.restoreStaff = function(idx) {
    let staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
    
    if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á "${staffDB[idx].name}" ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        staffDB[idx].status = '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
        delete staffDB[idx].resignDate; // ‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏≠‡∏≠‡∏Å
        
        localStorage.setItem('staffDB', JSON.stringify(staffDB));
        alert("‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        renderResignedStaffTable(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡∏≤‡∏≠‡∏≠‡∏Å
    }
};
/* =======================================================
    üí∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (OUTGOING) - ‡∏ä‡∏∏‡∏î‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£
   ======================================================= */
window.renderExpensePage = function() {
    const target = document.getElementById('dynamicContent');
    if (!target) return;
    const today = new Date().toISOString().split('T')[0];

    target.innerHTML = `
        <div class="animate-in fade-in duration-500 p-4 -mt-12 text-left pb-20 font-normal">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-pink-100 mb-4 no-print relative z-10">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-5 items-end">
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-normal text-[#D48197] uppercase ml-2 mb-1 block italic">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                        <input type="date" id="expenseDate" value="${today}" onchange="window.updateExpenseTableDisplay()" class="w-full border border-pink-100 px-4 py-3 rounded-2xl text-[13px] font-normal bg-slate-50 outline-none text-slate-600 shadow-sm focus:ring-1 focus:ring-pink-200">
                    </div>
                    <div class="md:col-span-4">
                        <label class="text-[10px] font-normal text-[#D48197] uppercase ml-2 mb-1 block italic">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</label>
                        <input type="text" id="expenseName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." class="w-full border border-pink-100 px-4 py-3 rounded-2xl text-[13px] font-normal bg-slate-50 outline-none focus:ring-1 focus:ring-pink-200 text-slate-700 shadow-sm">
                    </div>
                    <div class="md:col-span-3">
                        <label class="text-[10px] font-normal text-[#D48197] uppercase ml-2 mb-1 block italic">‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                        <select id="expenseAccount" class="w-full border border-pink-100 px-4 py-3 rounded-2xl text-[13px] font-normal bg-slate-50 outline-none text-slate-600 appearance-none cursor-pointer shadow-sm">
                            <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                            <option value="‡πÇ‡∏≠‡∏ô (QR)">üì± ‡πÇ‡∏≠‡∏ô (QR)</option>
                            <option value="‡πÇ‡∏≠‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">üè¢ ‡πÇ‡∏≠‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</option>
                            <option value="‡∏£‡∏π‡∏î‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï">üí≥ ‡∏£‡∏π‡∏î‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                            <option value="Shopee">üõçÔ∏è Shopee</option>
                            <option value="Gowabi">üéüÔ∏è Gowabi</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-normal text-[#D48197] uppercase ml-2 mb-1 block text-right pr-4 italic">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label>
                        <input type="number" id="expenseAmount" placeholder="0.00" class="w-full border border-pink-100 px-4 py-3 rounded-2xl text-[15px] font-normal bg-slate-50 outline-none text-[#D48197] text-right shadow-sm">
                    </div>
                    <div class="md:col-span-1">
                        <input type="hidden" id="editingId" value="">
                        <button onclick="window.saveManualExpense()" id="btnSaveExpense" class="w-full bg-[#D48197] text-white h-[48px] rounded-2xl text-[11px] font-bold shadow-lg hover:bg-black transition-all uppercase">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-[3rem] shadow-2xl border border-pink-100 p-8 min-h-[500px]">
                <table class="w-full text-center text-sm border-separate border-spacing-y-0">
                    <thead>
                        <tr style="height: 55px;">
                            <th class="bg-[#D48197] text-white font-normal px-4 rounded-l-[1.5rem] w-32">‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                            <th class="bg-[#D48197] text-white font-normal px-4 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="bg-[#D48197] text-white font-normal px-2 text-center">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                            <th class="bg-[#D48197] text-white font-normal px-4 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                            <th class="bg-[#D48197] text-white font-normal px-4 rounded-r-[1.5rem] w-32">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="expenseDataBody" class="text-slate-600 font-normal"></tbody>
                </table>
            </div>
        </div>
    `;
    window.updateExpenseTableDisplay();
};
/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --- */
window.handleFilterChange = function(type) {
    const staffField = document.getElementById('filterStaff');
    const docField = document.getElementById('filterDoctor');
    if (type === 'staff' && docField) docField.value = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    else if (type === 'doctor' && staffField) staffField.value = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    updateDFTable();
};

/* =======================================================
    üí∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (OUTGOING) - ‡∏â‡∏ö‡∏±‡∏ö Capsule: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç | ‡∏•‡∏ö(‚ñº)
   ======================================================= */

/* --- üõ†Ô∏è 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Capsule Style: ‡∏Ñ‡∏•‡∏¥‡∏Å ‚ñº ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ) --- */
window.updateExpenseTableDisplay = function() {
    const tbody = document.getElementById('expenseDataBody');
    const dateInput = document.getElementById('expenseDate');
    if(!tbody || !dateInput) return;

    const selectedDate = dateInput.value;
    const accountDB = JSON.parse(localStorage.getItem('accountDB')) || [];
    
    const expenses = accountDB.filter(item => item.type === "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" && item.date === selectedDate);

    if (expenses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="p-20 text-center text-slate-300 italic font-normal">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate} --</td></tr>`;
        return;
    }

    tbody.innerHTML = expenses.reverse().map((item, i) => `
        <tr class="border-b border-pink-50 hover:bg-pink-50/20 transition-all font-normal" style="height: 70px;">
            <td class="p-4 text-slate-400 text-[11px]">
                <span class="font-bold text-[#D48197]">${item.time || '--:--'} ‡∏ô.</span>
            </td>
            <td class="p-4 text-left">
                <span class="font-bold text-slate-700">${item.detail}</span>
                ${item.category ? `<br><span class="text-[9px] text-slate-300 uppercase">${item.category}</span>` : ''}
            </td>
            <td class="p-4 text-center text-slate-500 text-[11px] italic">${item.account}</td>
            <td class="p-4 text-right font-black text-red-500 text-lg">‡∏ø${parseFloat(item.amount).toLocaleString()}</td>
            <td class="p-4 text-center">
                
                <div class="inline-flex items-center bg-[#D48197] text-white rounded-full p-1 shadow-md scale-90">
                    
                    <button onclick="window.editExpense(${item.id})" 
                            class="pl-5 pr-3 py-1.5 text-[12px] font-bold border-r border-white/30 hover:bg-white/10 rounded-l-full transition-all">
                        ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>

                    <button onclick="window.deleteExpense(${item.id})" 
                            title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ"
                            class="px-3 py-1.5 text-[10px] hover:bg-red-500 rounded-r-full transition-all flex items-center justify-center">
                        ‡∏•‡∏ö
                    </button>
                    
                </div>

            </td>
        </tr>
    `).join('');
};

/* --- üíæ 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Save / Update) --- */
window.saveManualExpense = function() {
    const name = document.getElementById('expenseName').value.trim();
    const amount = document.getElementById('expenseAmount').value;
    const account = document.getElementById('expenseAccount').value;
    const date = document.getElementById('expenseDate').value;
    const editingId = document.getElementById('editingId').value;

    if (!name || !amount || amount <= 0) {
        Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞', confirmButtonColor: '#D48197' });
        return;
    }

    let accountDB = JSON.parse(localStorage.getItem('accountDB')) || [];
    
    if (editingId) {
        const index = accountDB.findIndex(i => i.id == editingId);
        if (index !== -1) {
            accountDB[index].detail = name;
            accountDB[index].amount = parseFloat(amount);
            accountDB[index].account = account;
            accountDB[index].date = date;
        }
        document.getElementById('editingId').value = "";
        const btn = document.getElementById('btnSaveExpense');
        if(btn) { btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"; btn.style.backgroundColor = "#D48197"; }
    } else {
        accountDB.push({
            id: Date.now(),
            date: date,
            time: new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
            type: "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢",
            category: "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ",
            detail: name,
            amount: parseFloat(amount),
            account: account,
            timestamp: new Date().getTime()
        });
    }
   
    localStorage.setItem('accountDB', JSON.stringify(accountDB));
    document.getElementById('expenseName').value = "";
    document.getElementById('expenseAmount').value = "";
    window.updateExpenseTableDisplay();
    if (typeof refreshAllData === 'function') refreshAllData();
    
    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: editingId ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏∞' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏∞', showConfirmButton: false, timer: 1500 });
};

/* --- üóëÔ∏è 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° ‚ñº) --- */
window.deleteExpense = function(id) {
    Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
        text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#D48197',
        cancelButtonColor: '#888',
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    }).then((result) => {
        if (result.isConfirmed) {
            let accountDB = JSON.parse(localStorage.getItem('accountDB')) || [];
            localStorage.setItem('accountDB', JSON.stringify(accountDB.filter(i => i.id !== id)));
            window.updateExpenseTableDisplay();
            if (typeof refreshAllData === 'function') refreshAllData();
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞', showConfirmButton: false, timer: 1500 });
        }
    });
};

/* --- üìù 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --- */
window.editExpense = function(id) {
    const accountDB = JSON.parse(localStorage.getItem('accountDB')) || [];
    const item = accountDB.find(i => i.id === id);
    if(!item) return;

    document.getElementById('expenseName').value = item.detail;
    document.getElementById('expenseAmount').value = item.amount;
    document.getElementById('expenseAccount').value = item.account;
    document.getElementById('expenseDate').value = item.date;
    document.getElementById('editingId').value = item.id;
    
    const btn = document.getElementById('btnSaveExpense');
    if(btn) {
        btn.innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        btn.style.backgroundColor = "#2563eb";
    }
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
};
/* =======================================================
    üìÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å (‡∏â‡∏ö‡∏±‡∏ö Luxury Pink Header)
   ======================================================= */

if (typeof currentViewDate === 'undefined') {
    window.currentViewDate = new Date();
}

window.renderStaffCalendar = function() {
    const target = document.getElementById('dynamicContent');
    if (!target) return;
    
    target.innerHTML = `
        <div class="animate-in fade-in duration-500 p-4 -mt-6 text-left pb-20 font-normal">
            <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-pink-100 mb-6 flex justify-between items-center no-print">
                <div class="flex items-center gap-6">
                    <button onclick="renderStaffManagement()" class="bg-slate-800 text-white w-12 h-12 rounded-2xl hover:bg-black transition-all flex items-center justify-center shadow-lg">‚ùÆ</button>
                    <div>
                        <h2 class="text-3xl font-black text-slate-800 tracking-tighter leading-none uppercase italic">CLINIC CALENDAR</h2>
                        <p class="text-[11px] text-[#D48197] font-black uppercase mt-2 tracking-[0.2em]">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GOOGLE</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.syncCalendarToGoogle()" class="bg-[#4285F4] text-white px-8 py-3 rounded-2xl text-[11px] font-black shadow-lg hover:brightness-110 transition-all uppercase flex items-center gap-2">
                        <img src="https://cdn-icons-png.flaticon.com/128/300/300221.png" class="w-4 h-4 brightness-200"> SYNC GOOGLE
                    </button>
                    <button onclick="window.openAddHolidayModal()" class="bg-[#D48197] text-white px-8 py-3 rounded-2xl text-[11px] font-black shadow-xl hover:bg-black transition-all uppercase">
                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡∏ß
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4">
                    <div class="bg-white p-8 rounded-[3rem] shadow-xl border border-pink-50 min-h-[600px] flex flex-col">
                        <h3 class="text-sm font-black text-slate-800 mb-6 border-b-4 border-[#D48197] pb-4 uppercase italic">üìå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h3>
                        <div id="holidayList" class="space-y-3 overflow-y-auto flex-1 pr-2 font-normal"></div>
                    </div>
                </div>

                <div class="lg:col-span-8">
                    <div class="bg-white rounded-[3.5rem] shadow-2xl border border-pink-100 p-10 min-h-[650px]">
                        
                        <div class="flex justify-between items-center mb-10 bg-slate-50 p-4 rounded-[2rem]">
                            <button onclick="window.changeMonth(-1)" class="w-12 h-12 flex items-center justify-center rounded-2xl bg-white shadow-sm hover:bg-[#D48197] hover:text-white transition-all text-slate-800 font-black text-xl">‚ùÆ</button>
                            <div class="text-center">
                                <h3 id="monthYearLabel" class="text-2xl font-black text-slate-800 uppercase tracking-tighter italic"></h3>
                            </div>
                            <button onclick="window.changeMonth(1)" class="w-12 h-12 flex items-center justify-center rounded-2xl bg-white shadow-sm hover:bg-[#D48197] hover:text-white transition-all text-slate-800 font-black text-xl">‚ùØ</button>
                        </div>

                        <div id="calendarGrid" class="grid grid-cols-7 gap-3">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    window.updateHolidayDisplay();
};

window.changeMonth = function(offset) {
    window.currentViewDate.setMonth(window.currentViewDate.getMonth() + offset);
    window.updateHolidayDisplay();
};

/* --- üé® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (‡∏â‡∏ö‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏ß‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô 100%) --- */
window.drawCalendar = function() {
    const grid = document.getElementById('calendarGrid');
    const label = document.getElementById('monthYearLabel');
    if (!grid || !label) return;

    const year = window.currentViewDate.getFullYear();
    const month = window.currentViewDate.getMonth();
    const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
    
    label.innerText = `${monthNames[month]} ${year + 543}`;

    const holidays = JSON.parse(localStorage.getItem('clinicHolidaysDB')) || [];
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // üéÄ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß: ‡∏à‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á (Center) ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏´‡∏ô‡∏≤
    const daysHeader = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
    grid.innerHTML = daysHeader.map(d => `
        <div class="text-[12px] font-black text-white bg-[#D48197] py-4 rounded-2xl mb-2 shadow-sm uppercase italic flex items-center justify-center text-center">
            ${d}
        </div>
    `).join('');

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    for(let i=0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

    // ‡∏ß‡∏≤‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á
    for(let d=1; d <= daysInMonth; d++) {
        const checkDate = new Date(year, month, d);
        checkDate.setHours(0,0,0,0);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡∏ß
        const isHoliday = holidays.find(h => {
            const start = new Date(h.start);
            const end = new Date(h.end);
            start.setHours(0,0,0,0);
            end.setHours(0,0,0,0);
            return checkDate >= start && checkDate <= end;
        });

        const isToday = d === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear();

        grid.innerHTML += `
            <div class="relative h-24 border-2 border-slate-50 rounded-[2rem] flex flex-col items-center justify-center transition-all shadow-sm
                ${isHoliday ? 'bg-pink-100 border-pink-300' : 'bg-white hover:border-pink-200'}">
                <span class="text-sm font-black ${isToday ? 'bg-[#D48197] text-white w-9 h-9 rounded-full flex items-center justify-center shadow-lg' : 'text-slate-600'}">${d}</span>
                ${isHoliday ? `<span class="text-[9px] text-[#D48197] font-black mt-2 px-1 truncate w-full text-center uppercase italic">${isHoliday.title}</span>` : ''}
            </div>
        `;
    }
};
window.updateHolidayDisplay = function() {
    const listArea = document.getElementById('holidayList');
    if (!listArea) return;
    
    let holidays = JSON.parse(localStorage.getItem('clinicHolidaysDB')) || [];
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    holidays = holidays.filter(h => h && h.start && h.end);
    holidays.sort((a, b) => new Date(a.start) - new Date(b.start));
    
    listArea.innerHTML = holidays.length === 0 
        ? `<div class="py-20 text-center text-slate-300 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</div>`
        : holidays.map((h, idx) => `
            <div class="group p-4 bg-white border-l-8 border-[#D48197] rounded-r-3xl mb-3 flex justify-between items-center shadow-sm hover:shadow-md transition-all border border-pink-50">
                <div class="text-left font-normal">
                    <p class="text-[10px] text-[#D48197] font-black uppercase">
                        ${h.start.split('-').reverse().join('/')} - ${h.end.split('-').reverse().join('/')}
                    </p>
                    <p class="text-sm font-bold text-slate-800">${h.title}</p>
                </div>
                <button onclick="window.deleteHoliday(${idx})" class="text-slate-300 hover:text-red-500 font-bold p-2 transition-colors">‚úï</button>
            </div>
        `).join('');
    
    window.drawCalendar();
};

window.openAddHolidayModal = function() {
    Swal.fire({
        title: '<span class="text-slate-800 font-black italic uppercase">üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡∏ß</span>',
        html: `
            <div class="p-4 space-y-4 text-left font-normal">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 block mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</label>
                    <input id="hTitle" class="swal2-input w-full m-0 rounded-2xl border-pink-100 focus:border-[#D48197]" style="box-shadow:none;" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå, ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á...">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 block mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="hStart" class="swal2-input w-full m-0 rounded-2xl border-pink-100">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 block mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)</label>
                        <input type="date" id="hEnd" class="swal2-input w-full m-0 rounded-2xl border-pink-100">
                    </div>
                </div>
            </div>
        `,
        confirmButtonText: 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        confirmButtonColor: '#D48197',
        showCancelButton: true,
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        preConfirm: () => {
            const title = document.getElementById('hTitle').value;
            const start = document.getElementById('hStart').value;
            const end = document.getElementById('hEnd').value;
            if (!title || !start || !end) {
                Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ñ‡πà‡∏∞');
            }
            return { title, start, end };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            let holidays = JSON.parse(localStorage.getItem('clinicHolidaysDB')) || [];
            holidays.push(result.value);
            localStorage.setItem('clinicHolidaysDB', JSON.stringify(holidays));
            window.updateHolidayDisplay();
            Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', showConfirmButton: false, timer: 1500 });
        }
    });
};

window.deleteHoliday = function(idx) {
    if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        let holidays = JSON.parse(localStorage.getItem('clinicHolidaysDB')) || [];
        holidays.splice(idx, 1);
        localStorage.setItem('clinicHolidaysDB', JSON.stringify(holidays));
        window.updateHolidayDisplay();
    }
};

window.syncCalendarToGoogle = function() {
    // üåê ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á
    window.open('https://calendar.google.com/', '_blank');
    Swal.fire({
        toast: true, position: 'top-end', icon: 'success',
        title: '‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞', showConfirmButton: false, timer: 3000
    });
};

  lucide.createIcons();
/* =======================================================
    üí∞ [‡∏ä‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå] ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ACE Clinic
    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÑ‡∏î‡πâ 100%, ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ‡πÇ‡∏≠‡∏ó‡∏µ, ‡∏¢‡∏≠‡∏î‡∏´‡∏±‡∏Å‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö
   ======================================================= */

// 1Ô∏è‚É£ ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Compact Grid)
window.renderPayrollSystem = function() {
    const target = document.getElementById('dynamicContent');
    if(!target) return;

    const allStaff = JSON.parse(localStorage.getItem('staffDB')) || [];
    const activeStaff = allStaff.filter(s => s.status === '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô');
    const payrollHistory = JSON.parse(localStorage.getItem('payrollHistoryDB')) || [];
    
    const now = new Date();
    const selM = document.getElementById('filterMonth')?.value || (now.getMonth() + 1);
    const selY = document.getElementById('filterYear')?.value || (now.getFullYear() + 543);
    const selectedPeriod = `${selM}/${selY}`;

    target.innerHTML = `
        <div class="animate-in fade-in duration-500 p-6 -mt-10 text-left pb-24 font-normal bg-[#FDF7F8]">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h1 class="text-4xl font-black text-slate-800 italic uppercase leading-none">PAYROLL</h1>
                    <p class="text-[9px] text-[#D48197] font-black uppercase mt-2 tracking-[0.4em] italic">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏≠‡∏•‡∏•‡∏µ‡πà ‡∏Ñ‡∏≠‡∏™‡πÄ‡∏°‡∏ï‡∏¥‡∏Å‡∏™‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î | 096-0836665</p>
                </div>
                <div class="flex gap-2 bg-white p-3 rounded-[1.5rem] shadow-sm border border-pink-100 items-end">
                    <div class="flex flex-col">
                        <label class="text-[8px] font-black text-[#C5A059] uppercase ml-2 mb-0.5 italic">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <select id="filterMonth" onchange="window.renderPayrollSystem()" class="bg-slate-50 border border-pink-50 rounded-lg px-2 py-1 text-[10px] font-bold outline-none cursor-pointer">
                            ${[...Array(12)].map((_, i) => `<option value="${i+1}" ${selM == i+1 ? 'selected' : ''}>${new Intl.DateTimeFormat('th-TH', {month: 'short'}).format(new Date(2026, i, 1))}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-[8px] font-black text-[#C5A059] uppercase ml-2 mb-0.5 italic">‡∏õ‡∏µ (‡∏û.‡∏®.)</label>
                        <select id="filterYear" onchange="window.renderPayrollSystem()" class="bg-slate-50 border border-pink-50 rounded-lg px-2 py-1 text-[10px] font-bold outline-none cursor-pointer">
                            <option value="2569" ${selY == 2569 ? 'selected' : ''}>2569</option>
                            <option value="2570" ${selY == 2570 ? 'selected' : ''}>2570</option>
                        </select>
                    </div>
                    <button onclick="renderStaffManagement()" class="bg-slate-800 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg mb-0.5">‚ùÆ</button>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                ${activeStaff.map((s) => {
                    const record = payrollHistory.find(p => p.staffId === s.staffId && p.period === selectedPeriod);
                    const originalIndex = allStaff.findIndex(item => item.staffId === s.staffId);
                    return `
                    <div class="bg-white rounded-[2.5rem] p-6 border border-slate-50 shadow-lg hover:shadow-2xl transition-all text-center relative overflow-hidden group">
                        <div class="w-14 h-14 bg-[#FFF5F7] rounded-2xl flex items-center justify-center mb-4 border border-pink-50 mx-auto overflow-hidden">
                            <img src="${s.img || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover">
                        </div>
                        <h3 class="text-lg font-black text-slate-800 leading-tight mb-0.5 italic text-center">${s.name}</h3>
                        <p class="text-[8px] text-[#D48197] font-black uppercase tracking-widest mb-4 italic text-center">${s.role || 'Staff'}</p>
                        <div class="space-y-2 border-t border-slate-50 pt-4 mb-6 font-bold italic text-[10px]">
                            <div class="flex justify-between"><span>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span><span class="text-slate-700 font-black">‡∏ø${parseFloat(s.salary || 0).toLocaleString()}</span></div>
                            <div class="flex justify-between"><span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><span class="${record ? 'text-green-500' : 'text-orange-400'} font-black">${record ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</span></div>
                        </div>
                        <button onclick="window.openLuxuryPayroll(${originalIndex}, '${selectedPeriod}')" class="w-full py-3 rounded-xl font-black text-[9px] uppercase tracking-[0.2em] shadow-md ${record ? 'bg-slate-100 text-slate-400' : 'bg-[#D48197] text-white hover:bg-black'}">
                            ${record ? '‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì'}
                        </button>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
};

// 2Ô∏è‚É£ ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏ß‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏ï‡πâ OT ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡∏¢‡∏≠‡∏î‡∏´‡∏±‡∏Å‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
window.openLuxuryPayroll = function(idx, period) {
    const allStaff = JSON.parse(localStorage.getItem('staffDB')) || [];
    const staff = allStaff[idx];
    if(!staff) return;

    const history = JSON.parse(localStorage.getItem('payrollHistoryDB')) || [];
    const prev = history.find(p => p.staffId === staff.staffId && p.period === period);

    const modal = document.createElement('div');
    modal.id = "payrollModal";
    modal.className = "fixed inset-0 bg-pink-900/40 backdrop-blur-md flex items-center justify-center z-[10006] p-4 font-normal";
    
    modal.innerHTML = `
        <div class="bg-white w-full max-w-6xl rounded-[4rem] shadow-2xl overflow-hidden border-2 border-pink-100 animate-in slide-in-from-bottom duration-500 text-left">
            <div class="grid grid-cols-1 md:grid-cols-12">
                <div class="md:col-span-4 bg-[#FFF5F7] p-10 flex flex-col justify-between border-r border-pink-100 font-bold italic">
                    <div>
                        <h3 class="text-2xl font-black text-slate-800 mb-1 uppercase">${staff.name}</h3>
                        <p class="text-[9px] text-[#D48197] font-black uppercase mb-8">‡∏á‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: ${period}</p>
                        <div class="bg-white p-6 rounded-[2rem] shadow-sm border-b-8 border-[#C5A059] text-center">
                            <p class="text-[8px] font-black text-slate-400 uppercase italic mb-1">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (NET)</p>
                            <h2 id="mNet" class="text-4xl font-black text-slate-800 italic tracking-tighter">‡∏ø0.000</h2>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <button onclick="saveAndPrintPayroll(${idx}, '${period}')" class="w-full bg-[#D48197] text-white py-4 rounded-[1.5rem] text-[11px] font-black shadow-lg hover:bg-black uppercase italic">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏•‡∏¥‡∏õ</button>
                        <button type="button" onclick="window.sendPayrollEmailPrompt()" class="w-full bg-white border-2 border-pink-200 text-[#D48197] py-3.5 rounded-[1.5rem] text-[10px] font-black hover:bg-pink-50 uppercase italic">üìß ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
                        <button onclick="document.getElementById('payrollModal').remove()" class="w-full text-slate-300 py-1 text-[9px] font-black uppercase hover:text-red-400 font-bold italic">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                    </div>
                </div>

                <div class="md:col-span-8 p-10 overflow-y-auto font-bold italic" style="max-height: 80vh;">
                    <div class="grid grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <h4 class="text-xs font-black text-[#C5A059] border-b-4 border-pink-50 pb-2 uppercase italic tracking-widest">üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (EARNINGS)</h4>
                            <div class="space-y-4 font-normal italic">
                                <div><label class="text-[10px] text-slate-400 font-black">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ê‡∏≤‡∏ô</label>
                                <input type="number" id="mSalary" value="${staff.salary}" class="w-full bg-slate-50 border-none p-3.5 rounded-2xl font-black text-slate-400 italic" readonly></div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div><label class="text-[10px] text-slate-400 font-black italic">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</label>
                                    <input type="number" id="mComm" oninput="calcPayrollLogic()" value="${prev ? prev.comm : 0}" class="w-full border-2 border-pink-50 p-3.5 rounded-2xl font-black outline-none focus:border-[#C5A059]"></div>
                                    <div><label class="text-[10px] text-slate-400 font-black italic">‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ (DF)</label>
                                    <input type="number" id="mDF" oninput="calcPayrollLogic()" value="${prev ? prev.df : 0}" class="w-full border-2 border-pink-50 p-3.5 rounded-2xl font-black outline-none focus:border-[#C5A059]"></div>
                                </div>
                                <div><label class="text-[10px] text-slate-400 font-black italic">‡πÇ‡∏≠‡∏ó‡∏µ (OT)</label>
                                <input type="number" id="mOT" oninput="calcPayrollLogic()" value="${prev ? prev.ot : 0}" class="w-full border-2 border-pink-50 p-3.5 rounded-2xl font-black outline-none focus:border-[#C5A059]"></div>

                                <div class="bg-white p-4 rounded-3xl border border-pink-50 text-[8px] font-bold text-slate-400 italic shadow-sm mt-4">
                                    <p class="text-[#C5A059] mb-1 font-black uppercase tracking-tighter underline underline-offset-4">üìú ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô:</p>
                                    <ul class="space-y-0.5 list-disc pl-3">
                                        <li><b>‡∏°‡∏≤‡∏™‡∏≤‡∏¢:</b> ‡∏ü‡∏£‡∏µ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (< 10 ‡∏ô‡∏≤‡∏ó‡∏µ) ‡πÄ‡∏Å‡∏¥‡∏ô‡∏´‡∏±‡∏Å 5‡∏ö./‡∏ô‡∏≤‡∏ó‡∏µ</li>
                                        <li><b>‡∏™‡∏≤‡∏¢ > 30 ‡∏ô‡∏≤‡∏ó‡∏µ:</b> ‡∏´‡∏±‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ï‡∏≤‡∏°‡∏ê‡∏≤‡∏ô</li>
                                        <li><b>‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô:</b> ‡∏´‡∏±‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô + ‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</li>
                                        <li><b>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢:</b> ‡∏ü‡∏£‡∏µ 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ (‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏±‡∏Å)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <h4 class="text-xs font-black text-red-400 border-b-4 border-pink-50 pb-2 uppercase italic tracking-widest">üî¥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h4>
                            <div class="space-y-4">
                                <div class="bg-red-50/30 p-5 rounded-[2.5rem] border border-red-100 shadow-inner space-y-4 italic">
                                    <p class="text-[9px] font-black text-red-500 mb-1 uppercase underline underline-offset-4">‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏≤</p>
                                    <div class="flex flex-col gap-0.5">
                                        <div class="flex justify-between items-center"><label class="text-[10px] text-slate-500">‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô)</label>
                                        <input type="number" id="mAbsDays" oninput="calcPayrollLogic()" value="${prev ? prev.absDays : 0}" class="w-14 bg-white border border-red-100 p-1 rounded-lg text-center font-black text-red-500 text-xs"></div>
                                        <div class="text-[8px] text-right text-red-400 font-black italic" id="valAbsDayDeduct">‡∏´‡∏±‡∏Å: ‡∏ø0.00</div>
                                    </div>
                                    <div class="flex flex-col gap-0.5">
                                        <div class="flex justify-between items-center"><label class="text-[10px] text-slate-500">‡∏´‡∏±‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡πÄ‡∏ä‡πà‡∏ô 1.30)</label>
                                        <input type="number" id="mAbsHours" oninput="calcPayrollLogic()" value="${prev ? prev.absHours : 0}" class="w-14 bg-white border border-red-100 p-1 rounded-lg text-center font-black text-red-500 text-xs"></div>
                                        <div class="text-[8px] text-right text-red-400 font-black italic" id="valAbsHourDeduct">‡∏´‡∏±‡∏Å: ‡∏ø0.00</div>
                                    </div>
                                    <div class="flex flex-col gap-0.5">
                                        <div class="flex justify-between items-center"><label class="text-[10px] text-slate-500">‡∏°‡∏≤‡∏™‡∏≤‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                                        <input type="number" id="mLateMin" oninput="calcPayrollLogic()" value="${prev ? prev.lateMins : 0}" class="w-14 bg-white border border-red-100 p-1 rounded-lg text-center font-black text-red-500 text-xs"></div>
                                        <div class="text-[8px] text-right text-red-400 font-black italic" id="valLateDeduct">‡∏´‡∏±‡∏Å: ‡∏ø0.00</div>
                                    </div>
                                    <div class="pt-2 border-t border-red-200 flex justify-between items-center"><span class="text-[11px] font-black text-red-600">‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏Å‡∏ß‡∏¥‡∏ô‡∏±‡∏¢:</span><span id="resDeductTotal" class="text-[12px] font-black text-red-600">- ‡∏ø0.000</span></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-[10px] text-slate-400 font-black italic">‡∏†‡∏≤‡∏©‡∏µ (WHT)</label>
                                    <input type="number" id="mTax" oninput="calcPayrollLogic()" value="${prev ? prev.tax : 0}" class="w-full border-2 border-pink-50 p-3.5 rounded-2xl font-black outline-none focus:border-[#C5A059]"></div>
                                    <div><label class="text-[10px] text-slate-400 font-black italic">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°</label>
                                    <input type="number" id="mSSO" class="w-full bg-slate-100 border-none p-3.5 rounded-2xl font-black text-slate-400 italic" readonly></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    document.body.appendChild(modal);
    calcPayrollLogic();
};

// 3Ô∏è‚É£ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
window.calcPayrollLogic = function() {
    const salary = parseFloat(document.getElementById('mSalary').value) || 0;
    const comm = parseFloat(document.getElementById('mComm').value) || 0;
    const hourRate = (salary / 30) / 8;

    const absD = parseFloat(document.getElementById('mAbsDays').value) || 0;
    const absDayDeduct = absD * (salary / 30);
    const commDeduct = (absD > 0) ? (comm / 30) * absD : 0;
    document.getElementById('valAbsDayDeduct').innerText = `‡∏´‡∏±‡∏Å: ‡∏ø${(absDayDeduct + commDeduct).toLocaleString(undefined, {minimumFractionDigits: 2})}`;

    const absHIn = parseFloat(document.getElementById('mAbsHours').value) || 0;
    const h = Math.floor(absHIn);
    const m = (absHIn - h) * 100;
    const absHourDeduct = (h + (m/60)) * hourRate;
    document.getElementById('valAbsHourDeduct').innerText = `‡∏´‡∏±‡∏Å: ‡∏ø${absHourDeduct.toLocaleString(undefined, {minimumFractionDigits: 2})}`;

    const lateM = parseFloat(document.getElementById('mLateMin').value) || 0;
    let lateDeduct = 0;
    if (lateM > 10 && lateM <= 30) lateDeduct = lateM * 5;
    else if (lateM > 30) lateDeduct = (lateM / 60) * hourRate;
    document.getElementById('valLateDeduct').innerText = `‡∏´‡∏±‡∏Å: ‡∏ø${lateDeduct.toLocaleString(undefined, {minimumFractionDigits: 2})}`;

    const totalD = absDayDeduct + commDeduct + absHourDeduct + lateDeduct;
    document.getElementById('resDeductTotal').innerText = `- ‡∏ø${totalD.toLocaleString(undefined, {minimumFractionDigits: 3})}`;

    const sso = Math.min(875, salary * 0.05);
    document.getElementById('mSSO').value = sso.toFixed(0);

    const income = salary + comm + (parseFloat(document.getElementById('mDF').value) || 0) + (parseFloat(document.getElementById('mOT').value) || 0);
    const net = income - totalD - sso - (parseFloat(document.getElementById('mTax').value) || 0);
    document.getElementById('mNet').innerText = `‡∏ø${net.toLocaleString(undefined, {minimumFractionDigits: 3})}`;
};
// üíæ 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
window.saveAndPrintPayroll = function(idx, period) {
    const allStaff = JSON.parse(localStorage.getItem('staffDB')) || [];
    const staff = allStaff[idx];
    if(!staff) return Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'error');

    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡πÉ‡∏ä‡πâ ID ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö HTML ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    const data = {
        staffId: staff.staffId,
        period: period,
        salary: parseFloat(document.getElementById('mSalary').value) || 0,
        comm: parseFloat(document.getElementById('mComm').value) || 0,
        df: parseFloat(document.getElementById('mDF').value) || 0,
        ot: parseFloat(document.getElementById('mOT').value) || 0,
        tax: parseFloat(document.getElementById('mTax').value) || 0,
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ô‡∏±‡∏¢
        absDays: parseFloat(document.getElementById('mAbsDays').value) || 0,
        absHours: parseFloat(document.getElementById('mAbsHours').value) || 0,
        lateMins: parseFloat(document.getElementById('mLateMin').value) || 0,
        // ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        netPay: document.getElementById('mNet').innerText,
        timestamp: new Date().getTime()
    };

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Payroll History)
    let history = JSON.parse(localStorage.getItem('payrollHistoryDB')) || [];
    const exIdx = history.findIndex(p => p.staffId === staff.staffId && p.period === period);
    
    if(exIdx !== -1) {
        history[exIdx] = data; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
    } else {
        history.push(data); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    }
    
    localStorage.setItem('payrollHistoryDB', JSON.stringify(history));

    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
    Swal.fire({
        icon: 'success',
        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏á‡∏ß‡∏î ' + period + ' ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß',
        showConfirmButton: false,
        timer: 1500
    }).then(() => {
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        if (window.printSlip) window.printSlip(data, staff); 
        document.getElementById('payrollModal').remove();
        renderPayrollSystem(); 
    });
};

// üìß 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á (z-index Fix)
window.sendPayrollEmailPrompt = function() {
    Swal.fire({
        title: 'üìß ‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
        input: 'email',
        inputLabel: '‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á',
        inputPlaceholder: 'employee@aceclinic.com',
        confirmButtonColor: '#D48197',
        confirmButtonText: '‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
        showCancelButton: true,
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        customClass: {
            container: 'z-[11000]' // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
        }
    }).then((result) => {
        if (result.isConfirmed && result.value) {
            // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö API ‡πÄ‡∏ä‡πà‡∏ô EmailJS ‡∏´‡∏£‡∏∑‡∏≠ Backend)
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: `‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏õ‡∏ó‡∏µ‡πà ${result.value} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞`,
                confirmButtonColor: '#D48197'
            });
        }
    });
};
/* =======================================================
   üìà 12. ATTENDANCE SUMMARY (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)
   ======================================================= */
window.renderAttendanceRecord = function() {
    const target = document.getElementById('dynamicContent');
    const staffDB = JSON.parse(localStorage.getItem('staffDB')) || [];
    const payrollHistory = JSON.parse(localStorage.getItem('payrollHistoryDB')) || [];
    const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏π (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
    if (!window.attViewMode) window.attViewMode = 'monthly'; 
    const selMonth = window.selectedAttMonth || String(new Date().getMonth() + 1).padStart(2, '0');
    const selYearThai = window.selectedAttYear || "2569"; // ‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ ‡∏û.‡∏®.

    let displayData = [];
    let titleText = "";

    if (window.attViewMode === 'monthly') {
        // --- üìÖ ‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ---
        const periodKey = `${parseInt(selMonth)}/${selYearThai}`;
        titleText = `‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏ß‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNames[parseInt(selMonth)-1]} ${selYearThai}`;
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞ Map ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å staffDB ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        displayData = payrollHistory.filter(p => p.period === periodKey).map(record => {
            const staffInfo = staffDB.find(s => s.staffId === record.staffId);
            return {
                ...record,
                displayName: staffInfo ? staffInfo.name : (record.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'),
                lateMins: parseFloat(record.lateMins || record.lateCount || 0),
                absDays: parseFloat(record.absDays || 0),
                sickDays: parseFloat(record.sickDays || 0),
                netAmount: parseFloat(record.netAmount || 0)
            };
        });
    } else {
        // --- üóìÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ---
        titleText = `‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ ‡∏û.‡∏®. ${selYearThai}`;
        
        const yearlyMap = {};
        payrollHistory.forEach(record => {
            if (record.period && record.period.endsWith(selYearThai)) {
                if (!yearlyMap[record.staffId]) {
                    const staffInfo = staffDB.find(s => s.staffId === record.staffId);
                    yearlyMap[record.staffId] = { 
                        staffId: record.staffId,
                        displayName: staffInfo ? staffInfo.name : (record.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'),
                        lateMins: 0, absDays: 0, sickDays: 0, netAmount: 0, monthsCount: 0 
                    };
                }
                yearlyMap[record.staffId].lateMins += parseFloat(record.lateMins || record.lateCount || 0);
                yearlyMap[record.staffId].absDays += parseFloat(record.absDays || 0);
                yearlyMap[record.staffId].sickDays += parseFloat(record.sickDays || 0);
                yearlyMap[record.staffId].netAmount += parseFloat(record.netAmount || 0);
                yearlyMap[record.staffId].monthsCount += 1;
            }
        });
        displayData = Object.values(yearlyMap);
    }

    target.innerHTML = `
        <div class="animate-in fade-in duration-500 text-left pb-20 no-print font-normal">
            <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-pink-100 mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
                <div>
                    <h2 class="text-2xl font-black text-slate-800 italic uppercase leading-none">ATTENDANCE SUMMARY</h2>
                    <p class="text-[10px] text-[#D48197] font-black uppercase mt-2 italic tracking-widest text-left">${titleText}</p>
                </div>
                
                <div class="flex flex-wrap items-center gap-3 bg-slate-50 p-3 rounded-3xl border border-pink-50">
                    <div class="flex bg-white rounded-xl p-1 shadow-sm border border-pink-100 mr-2">
                        <button onclick="window.attViewMode='monthly'; renderAttendanceRecord()" class="px-4 py-1.5 text-[10px] font-black rounded-lg transition-all ${window.attViewMode==='monthly' ? 'bg-[#D48197] text-white' : 'text-slate-400'}">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
                        <button onclick="window.attViewMode='yearly'; renderAttendanceRecord()" class="px-4 py-1.5 text-[10px] font-black rounded-lg transition-all ${window.attViewMode==='yearly' ? 'bg-[#D48197] text-white' : 'text-slate-400'}">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
                    </div>

                    ${window.attViewMode === 'monthly' ? `
                        <select onchange="window.selectedAttMonth = this.value; renderAttendanceRecord()" class="bg-white border border-pink-200 rounded-xl px-4 py-2 text-xs font-bold outline-none cursor-pointer">
                            ${monthNames.map((m, i) => `<option value="${String(i+1).padStart(2,'0')}" ${selMonth == String(i+1).padStart(2,'0') ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    ` : ''}
                    
                    <select onchange="window.selectedAttYear = this.value; renderAttendanceRecord()" class="bg-white border border-pink-200 rounded-xl px-4 py-2 text-xs font-bold outline-none cursor-pointer">
                        <option value="2568" ${selYearThai == '2568' ? 'selected' : ''}>2568</option>
                        <option value="2569" ${selYearThai == '2569' ? 'selected' : ''}>2569</option>
                    </select>

                    <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2 rounded-xl text-[10px] font-black shadow-lg hover:bg-black transition-all uppercase">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                </div>
                <button onclick="loadPage(7, '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')" class="bg-pink-50 p-3 rounded-2xl text-[#D48197] font-bold shadow-sm hover:bg-pink-100 transition-all">üîô ‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>

            <div class="glass-card overflow-hidden !p-0 shadow-2xl border-none">
                <table class="w-full text-sm text-center">
                    <thead class="bg-[#F9EBEF] text-[#D48197] font-black uppercase italic text-[10px]">
                        <tr>
                            <th class="p-5 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                            <th class="p-5">‡∏™‡∏≤‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                            <th class="p-5">‡∏Ç‡∏≤‡∏î (‡∏ß‡∏±‡∏ô)</th>
                            <th class="p-5">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡∏ß‡∏±‡∏ô)</th>
                            <th class="p-5">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th>
                            <th class="p-5 bg-pink-100/30 text-blue-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (%)</th>
                        </tr>
                    </thead>
                    <tbody class="font-bold text-slate-600">
                        ${displayData.length > 0 ? displayData.map(record => `
                            <tr class="border-b border-pink-50 hover:bg-pink-50/10 transition-all">
                                <td class="p-5 text-left">${record.displayName}</td>
                                <td class="p-5">${record.lateMins} ‡∏ô.</td>
                                <td class="p-5">${record.absDays} ‡∏ß.</td>
                                <td class="p-5">${record.sickDays} ‡∏ß.</td>
                                <td class="p-5 text-[#D48197]">‡∏ø${record.netAmount.toLocaleString()}</td>
                                <td class="p-5 bg-pink-50/20 text-blue-600">5.0%</td>
                            </tr>`).join('') : `<tr><td colspan="6" class="p-20 text-slate-300 italic">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
    `;
};

/* =======================================================
   üì± ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Mobile & Responsive (ACE CLINIC LUXURY)
   ======================================================= */
</script>

<style>
  /* 1. ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å */
  #mainDashboard {
    display: flex !important;
    width: 100% !important;
    min-height: 100vh;
    transition: all 0.3s ease;
  }

  /* 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Sidebar (Aside) */
  aside {
    width: 300px !important;
    min-width: 300px !important;
    flex-shrink: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏ñ‡∏π‡∏Å "‡∏û‡∏±‡∏ö" */
  .ace-collapsed aside {
    width: 0 !important;
    min-width: 0 !important;
    opacity: 0;
    pointer-events: none;
  }

  /* 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Header ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î) */
  header {
    display: flex !important;
    flex-wrap: nowrap !important; /* ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
    align-items: center !important;
    justify-content: space-between !important;
    padding: 10px 20px !important;
    gap: 10px !important;
  }

  /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Header ‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏ö‡∏µ‡∏¢‡∏î‡∏Å‡∏±‡∏ô */
  header .flex.items-center.gap-4 {
    flex-shrink: 0 !important;
    display: flex !important;
    gap: 8px !important;
  }

  /* 4. ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π (‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏≠‡∏¢‡∏ï‡πà‡∏≠ Sidebar ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ) */
  #toggle-button-fixed {
    position: fixed;
    top: 32px; /* ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö Header */
    left: 285px; 
    width: 30px;
    height: 30px;
    background: #D48197;
    color: white;
    border-radius: 8px;
    display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≠ Login */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1000001;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border: 2px solid white;
  }

  /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠ */
  .ace-collapsed #toggle-button-fixed {
    left: 10px;
    top: 20px;
  }

  /* 5. ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
  main {
    flex-grow: 1;
    width: 100%;
    transition: all 0.3s ease;
    overflow-x: hidden;
  }

  @media screen and (max-width: 768px) {
    aside { position: fixed !important; z-index: 9999; height: 100vh; }
    #toggle-button-fixed { display: flex !important; top: 15px; left: 15px; }
    header { flex-wrap: wrap !important; } /* ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
  }
</style>

<div id="toggle-button-fixed" onclick="toggleAceMenu()">
  <span id="btn-icon-symbol">‚ùÆ</span>
</div>

<script>
  /**
   * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π
   */
  function toggleAceMenu() {
    const body = document.body;
    const isCollapsed = body.classList.toggle('ace-collapsed');
    document.getElementById('btn-icon-symbol').innerText = isCollapsed ? '‚ùØ' : '‚ùÆ';
  }

  /**
   * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
   */
  function checkUIVisibility() {
    const loginPage = document.getElementById('loginPage');
    const toggleBtn = document.getElementById('toggle-button-fixed');
    if (loginPage && (loginPage.classList.contains('hidden') || loginPage.style.display === 'none')) {
      toggleBtn.style.display = 'flex';
    } else {
      toggleBtn.style.display = 'none';
    }
  }

  // ‡πÉ‡∏ä‡πâ MutationObserver ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö Real-time
  const observer = new MutationObserver(checkUIVisibility);
  window.addEventListener('load', () => {
    const loginPage = document.getElementById('loginPage');
    if (loginPage) observer.observe(loginPage, { attributes: true, attributeFilter: ['class', 'style'] });
    checkUIVisibility();
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Mobile
    if (window.innerWidth <= 768) {
      document.body.classList.add('ace-collapsed');
      document.getElementById('btn-icon-symbol').innerText = '‚ùØ';
    }
  });

</script>
</body>
</html>
